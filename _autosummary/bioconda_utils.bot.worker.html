
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>worker &#8212; Bioconda  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css" />
    <link rel="stylesheet" type="text/css" href="../_static/font-awesome-4.7.0/css/font-awesome.min.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="aiopipe" href="bioconda_utils.aiopipe.html" />
    <link rel="prev" title="web" href="bioconda_utils.bot.web.html" />
    <link href="https://fonts.googleapis.com/css?family=Lato|Raleway" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">

    <link rel="apple-touch-icon" sizes="57x57" href="../_static/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../_static/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../_static/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../_static/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../_static/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../_static/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../_static/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../_static/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../_static/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="../_static/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../_static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../_static/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../_static/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="../_static/ms-icon-144x144.png">

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />


  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo/bioconda_monochrome_small.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../updating.html">Updating recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../updating.html#updating-recipes-for-a-pinning-change">Updating recipes for a pinning change</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linting.html">Linting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faqs.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build-system.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cb3.html">Conda build v3</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../developer.html">Developer Docs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../bioconda-utils.html"><code class="docutils literal notranslate"><span class="pre">bioconda-utils</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="bioconda_utils.html">bioconda_utils</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="bioconda_utils.bot.html">bot</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="bioconda_utils.bot.chat.html">chat</a></li>
<li class="toctree-l3"><a class="reference internal" href="bioconda_utils.bot.commands.html">commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="bioconda_utils.bot.config.html">config</a></li>
<li class="toctree-l3"><a class="reference internal" href="bioconda_utils.bot.events.html">events</a></li>
<li class="toctree-l3"><a class="reference internal" href="bioconda_utils.bot.tasks.html">tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="bioconda_utils.bot.views.html">views</a></li>
<li class="toctree-l3"><a class="reference internal" href="bioconda_utils.bot.web.html">web</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">worker</a></li>
</ul>
</li>
</ul>
</li>
</ul>

<ul>
  
  <li class="toctree-l1"><a href="https://github.com/bioconda/bioconda-recipes">Bioconda @ Github</a></li>
  
  <li class="toctree-l1"><a href="../conda-recipe_index.html">Recipe Index</a></li>
  
  <li class="toctree-l1"><a href="https://gitter.im/bioconda/Lobby"><img alt="Gitter" src="https://img.shields.io/gitter/room/bioconda/Lobby.svg"></a></li>
  
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="module-bioconda_utils.bot.worker">
<span id="worker"></span><h1>worker<a class="headerlink" href="#module-bioconda_utils.bot.worker" title="Permalink to this headline">¶</a></h1>
<p>Celery Worker Setup</p>
<p class="rubric">Functions</p>
<table class="longtable docutils align-center">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="#bioconda_utils.bot.worker.custom_dumps" title="bioconda_utils.bot.worker.custom_dumps"><code class="xref py py-obj docutils literal notranslate"><span class="pre">custom_dumps</span></code></a>(string)</p></td>
<td><p>Serialize <strong>s</strong> to JSON accepting <strong>for_json</strong> serializer method</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#bioconda_utils.bot.worker.custom_loads" title="bioconda_utils.bot.worker.custom_loads"><code class="xref py py-obj docutils literal notranslate"><span class="pre">custom_loads</span></code></a>(string)</p></td>
<td><p>Deserialize <strong>s</strong> recreating objects</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#bioconda_utils.bot.worker.install_gpg_key" title="bioconda_utils.bot.worker.install_gpg_key"><code class="xref py py-obj docutils literal notranslate"><span class="pre">install_gpg_key</span></code></a>()</p></td>
<td><p>Install GPG key from environment</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#bioconda_utils.bot.worker.setup_new_celery_process" title="bioconda_utils.bot.worker.setup_new_celery_process"><code class="xref py py-obj docutils literal notranslate"><span class="pre">setup_new_celery_process</span></code></a>([sender, conf])</p></td>
<td><p>This hook is called when a celery worker is initialized</p></td>
</tr>
</tbody>
</table>
<p class="rubric">Classes</p>
<table class="longtable docutils align-center">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="#bioconda_utils.bot.worker.AsyncTask" title="bioconda_utils.bot.worker.AsyncTask"><code class="xref py py-obj docutils literal notranslate"><span class="pre">AsyncTask</span></code></a></p></td>
<td><p>Task class with support for async tasks</p></td>
</tr>
</tbody>
</table>
<p class="rubric">Documentation</p>
<dl class="class">
<dt id="bioconda_utils.bot.worker.AsyncTask">
<em class="property">class </em><code class="descclassname">bioconda_utils.bot.worker.</code><code class="descname">AsyncTask</code><a class="reference internal" href="../_modules/bioconda_utils/bot/worker.html#AsyncTask"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#bioconda_utils.bot.worker.AsyncTask" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">celery.app.task.Task</span></code></p>
<p>Task class with support for async tasks</p>
<p>We override celery.Task with our own version, with some extra
features and defaults:</p>
<ul>
<li><p>Since we already use a lot of async stuff elsewhere, it’s useful
to allow the <code class="docutils literal notranslate"><span class="pre">run</span></code> method of tasks be <code class="docutils literal notranslate"><span class="pre">async</span></code>. This Task
class detects if the method provided is a coroutine and runs it
inside the asyncio event loop.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">async</span> <span class="k">def</span> <span class="nf">mytask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_init</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="o">...</span>
</pre></div>
</div>
</li>
<li><p>Provide access to a GitHubAppHandler instance shared at least
within the worker process.</p>
<p>This is a little tedious. Since the task may be spawned some
time after the webook that created it was triggered, the tokens
we got inside the webserver may have timed out. In an attempt to
avoid wasting API calls to create those tokens continuously, the
Task class maintains a copy.</p>
</li>
<li><p>Default to <code class="docutils literal notranslate"><span class="pre">acks_late</span> <span class="pre">=</span> <span class="pre">True</span></code>. The reason we use Celery at all
is so that spawned tasks can survive a shutdown of the app.</p></li>
</ul>
<dl class="attribute">
<dt id="bioconda_utils.bot.worker.AsyncTask.acks_late">
<code class="descname">acks_late</code><em class="property"> = True</em><a class="headerlink" href="#bioconda_utils.bot.worker.AsyncTask.acks_late" title="Permalink to this definition">¶</a></dt>
<dd><p>Our tasks should be re-run if they don’t finish</p>
</dd></dl>

<dl class="method">
<dt id="bioconda_utils.bot.worker.AsyncTask.async_init">
<code class="descname">async_init</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/bioconda_utils/bot/worker.html#AsyncTask.async_init"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#bioconda_utils.bot.worker.AsyncTask.async_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Init things that need to be run inside the loop</p>
<p>This happens during binding -&gt; on load.</p>
</dd></dl>

<dl class="method">
<dt id="bioconda_utils.bot.worker.AsyncTask.async_pre_run">
<code class="descname">async_pre_run</code><span class="sig-paren">(</span><em>args</em>, <em>_kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/bioconda_utils/bot/worker.html#AsyncTask.async_pre_run"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#bioconda_utils.bot.worker.AsyncTask.async_pre_run" title="Permalink to this definition">¶</a></dt>
<dd><p>Per-call async initialization</p>
<p>Prepares the <a class="reference internal" href="#bioconda_utils.bot.worker.AsyncTask.ghapi" title="bioconda_utils.bot.worker.AsyncTask.ghapi"><code class="xref any py py-attr docutils literal notranslate"><span class="pre">ghapi</span></code></a> property for tasks.</p>
<p>FIXME: doesn’t replace kwargs</p>
</dd></dl>

<dl class="method">
<dt id="bioconda_utils.bot.worker.AsyncTask.bind">
<code class="descname">bind</code><span class="sig-paren">(</span><em>app=None</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/bioconda_utils/bot/worker.html#AsyncTask.bind"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#bioconda_utils.bot.worker.AsyncTask.bind" title="Permalink to this definition">¶</a></dt>
<dd><p>Intercept binding of task to (celery) app</p>
<p>Here we take the half-finished generated Task class and
replace the async run method with a sync run method that
executes the original method inside the asyncio loop.</p>
</dd></dl>

<dl class="attribute">
<dt id="bioconda_utils.bot.worker.AsyncTask.ghapi">
<code class="descname">ghapi</code><em class="property"> = None</em><a class="headerlink" href="#bioconda_utils.bot.worker.AsyncTask.ghapi" title="Permalink to this definition">¶</a></dt>
<dd><p>Access the Github API</p>
</dd></dl>

<dl class="attribute">
<dt id="bioconda_utils.bot.worker.AsyncTask.ghappapi">
<code class="descname">ghappapi</code><em class="property"> = None</em><a class="headerlink" href="#bioconda_utils.bot.worker.AsyncTask.ghappapi" title="Permalink to this definition">¶</a></dt>
<dd><p>Access Github App API</p>
</dd></dl>

<dl class="attribute">
<dt id="bioconda_utils.bot.worker.AsyncTask.loop">
<code class="descname">loop</code><a class="headerlink" href="#bioconda_utils.bot.worker.AsyncTask.loop" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the async loop - creating a new one if necessary</p>
</dd></dl>

<dl class="method">
<dt id="bioconda_utils.bot.worker.AsyncTask.run">
<code class="descname">run</code><span class="sig-paren">(</span><em>*_args</em>, <em>**_kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/bioconda_utils/bot/worker.html#AsyncTask.run"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#bioconda_utils.bot.worker.AsyncTask.run" title="Permalink to this definition">¶</a></dt>
<dd><p>The tasks actual run method. Will be replaced during bind</p>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="bioconda_utils.bot.worker.custom_dumps">
<code class="descclassname">bioconda_utils.bot.worker.</code><code class="descname">custom_dumps</code><span class="sig-paren">(</span><em>string</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/bioconda_utils/bot/worker.html#custom_dumps"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#bioconda_utils.bot.worker.custom_dumps" title="Permalink to this definition">¶</a></dt>
<dd><p>Serialize <strong>s</strong> to JSON accepting <strong>for_json</strong> serializer method</p>
</dd></dl>

<dl class="function">
<dt id="bioconda_utils.bot.worker.custom_loads">
<code class="descclassname">bioconda_utils.bot.worker.</code><code class="descname">custom_loads</code><span class="sig-paren">(</span><em>string</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/bioconda_utils/bot/worker.html#custom_loads"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#bioconda_utils.bot.worker.custom_loads" title="Permalink to this definition">¶</a></dt>
<dd><p>Deserialize <strong>s</strong> recreating objects</p>
<p>JSON objects (dicts) containing a __type__ and a __module__
field are turned into objects by loading and instantiating
the type, passing the result dict from obj.for_json() to
__init__().</p>
</dd></dl>

<dl class="function">
<dt id="bioconda_utils.bot.worker.install_gpg_key">
<code class="descclassname">bioconda_utils.bot.worker.</code><code class="descname">install_gpg_key</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="../_modules/bioconda_utils/bot/worker.html#install_gpg_key"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#bioconda_utils.bot.worker.install_gpg_key" title="Permalink to this definition">¶</a></dt>
<dd><p>Install GPG key from environment</p>
</dd></dl>

<dl class="function">
<dt id="bioconda_utils.bot.worker.setup_new_celery_process">
<code class="descclassname">bioconda_utils.bot.worker.</code><code class="descname">setup_new_celery_process</code><span class="sig-paren">(</span><em>sender=None</em>, <em>conf=None</em>, <em>**_kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/bioconda_utils/bot/worker.html#setup_new_celery_process"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#bioconda_utils.bot.worker.setup_new_celery_process" title="Permalink to this definition">¶</a></dt>
<dd><p>This hook is called when a celery worker is initialized</p>
<p>Here we make sure that the GPG signing key is installed</p>
</dd></dl>

</div>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2016-2019, The Bioconda Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/_autosummary/bioconda_utils.bot.worker.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    <div class="git-ribbon">
      <a href="https://github.com/bioconda/bioconda-utils/edit/master/bioconda_utils/bot/worker.py" rel="me">Edit me on GitHub</a>
    </div>
  </body>
</html>