
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>bioconda_utils.githubhandler &#8212; Bioconda  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/font-awesome-4.7.0/css/font-awesome.min.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="https://fonts.googleapis.com/css?family=Lato|Raleway" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">

    <link rel="apple-touch-icon" sizes="57x57" href="../../_static/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../../_static/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../../_static/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../../_static/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../../_static/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../../_static/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../../_static/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../../_static/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../_static/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="../../_static/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../_static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../../_static/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../_static/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="../../_static/ms-icon-144x144.png">

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />


  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo/bioconda_monochrome_small.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../updating.html">Updating recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../updating.html#updating-recipes-for-a-pinning-change">Updating recipes for a pinning change</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linting.html">Linting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faqs.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build-system.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cb3.html">Conda build v3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer.html">Developer Docs</a></li>
</ul>

<ul>
  
  <li class="toctree-l1"><a href="https://github.com/bioconda/bioconda-recipes">Bioconda @ Github</a></li>
  
  <li class="toctree-l1"><a href="../../conda-recipe_index.html">Recipe Index</a></li>
  
  <li class="toctree-l1"><a href="https://gitter.im/bioconda/Lobby"><img alt="Gitter" src="https://img.shields.io/gitter/room/bioconda/Lobby.svg"></a></li>
  
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bioconda_utils.githubhandler</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Wrappers for Github Web-API Bindings&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="k">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">AsyncIterator</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="kn">import</span> <span class="nn">backoff</span>
<span class="kn">import</span> <span class="nn">cachetools</span>
<span class="kn">import</span> <span class="nn">gidgethub</span>
<span class="kn">import</span> <span class="nn">gidgethub.aiohttp</span>
<span class="kn">import</span> <span class="nn">gidgethub.sansio</span>
<span class="kn">import</span> <span class="nn">jwt</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-name</span>


<span class="c1">#: State for Github Issues</span>
<span class="n">IssueState</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;IssueState&quot;</span><span class="p">,</span> <span class="s2">&quot;open closed all&quot;</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-name</span>

<span class="c1">#: State of Github Check Run</span>
<span class="n">CheckRunStatus</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;CheckRunState&quot;</span><span class="p">,</span> <span class="s2">&quot;queued in_progress completed&quot;</span><span class="p">)</span>

<span class="c1">#: Conclusion of Github Check Run</span>
<span class="n">CheckRunConclusion</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;CheckRunConclusion&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;success failure neutral cancelled timed_out action_required&quot;</span><span class="p">)</span>

<span class="c1">#: Merge method</span>
<span class="n">MergeMethod</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;MergeMethod&quot;</span><span class="p">,</span> <span class="s2">&quot;merge squash rebase&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="iso_now"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.iso_now">[docs]</a><span class="k">def</span> <span class="nf">iso_now</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Creates ISO 8601 timestamp in format</span>
<span class="sd">    ``YYYY-MM-DDTHH:MM:SSZ`` as required by Github</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;Z&#39;</span></div>


<div class="viewcode-block" id="GitHubHandler"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler">[docs]</a><span class="k">class</span> <span class="nc">GitHubHandler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Handles interaction with GitHub</span>

<span class="sd">    Arguments:</span>
<span class="sd">      token: OAUTH token granting permissions to GH</span>
<span class="sd">      dry_run: Don&#39;t actually modify things if set</span>
<span class="sd">      to_user: Target User/Org for PRs</span>
<span class="sd">      to_repo: Target repository within **to_user**</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PULLS</span>             <span class="o">=</span> <span class="s2">&quot;/repos/</span><span class="si">{user}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/pulls{/number}{?head,base,state}&quot;</span>
    <span class="n">PULL_FILES</span>        <span class="o">=</span> <span class="s2">&quot;/repos/</span><span class="si">{user}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/pulls/</span><span class="si">{number}</span><span class="s2">/files&quot;</span>
    <span class="n">PULL_COMMITS</span>      <span class="o">=</span> <span class="s2">&quot;/repos/</span><span class="si">{user}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/pulls/</span><span class="si">{number}</span><span class="s2">/commits&quot;</span>
    <span class="n">PULL_MERGE</span>        <span class="o">=</span> <span class="s2">&quot;/repos/</span><span class="si">{user}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/pulls/</span><span class="si">{number}</span><span class="s2">/merge&quot;</span>
    <span class="n">BRANCH_PROTECTION</span> <span class="o">=</span> <span class="s2">&quot;/repos/</span><span class="si">{user}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/branches/</span><span class="si">{branch}</span><span class="s2">/protection&quot;</span>
    <span class="n">ISSUES</span>            <span class="o">=</span> <span class="s2">&quot;/repos/</span><span class="si">{user}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/issues{/number}&quot;</span>
    <span class="n">ISSUE_COMMENTS</span>    <span class="o">=</span> <span class="s2">&quot;/repos/</span><span class="si">{user}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/issues/</span><span class="si">{number}</span><span class="s2">/comments&quot;</span>
    <span class="n">COMMENTS</span>          <span class="o">=</span> <span class="s2">&quot;/repos/</span><span class="si">{user}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/issues/comments{/comment_id}&quot;</span>
    <span class="n">CHECK_RUN</span>         <span class="o">=</span> <span class="s2">&quot;/repos/</span><span class="si">{user}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/check-runs{/id}&quot;</span>
    <span class="n">GET_CHECK_RUNS</span>    <span class="o">=</span> <span class="s2">&quot;/repos/</span><span class="si">{user}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/commits/</span><span class="si">{commit}</span><span class="s2">/check-runs&quot;</span>
    <span class="n">GET_STATUSES</span>      <span class="o">=</span> <span class="s2">&quot;/repos/</span><span class="si">{user}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/commits/</span><span class="si">{commit}</span><span class="s2">/statuses&quot;</span>
    <span class="n">CONTENTS</span>          <span class="o">=</span> <span class="s2">&quot;/repos/</span><span class="si">{user}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/contents/</span><span class="si">{path}</span><span class="s2">{?ref}&quot;</span>
    <span class="n">GIT_REFERENCE</span>     <span class="o">=</span> <span class="s2">&quot;/repos/</span><span class="si">{user}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/git/refs/</span><span class="si">{ref}</span><span class="s2">&quot;</span>
    <span class="n">ORG_MEMBERS</span>       <span class="o">=</span> <span class="s2">&quot;/orgs/</span><span class="si">{user}</span><span class="s2">/members{/username}&quot;</span>
    <span class="n">ORG</span>               <span class="o">=</span> <span class="s2">&quot;/orgs/</span><span class="si">{user}</span><span class="s2">&quot;</span>
    <span class="n">ORG_TEAMS</span>         <span class="o">=</span> <span class="s2">&quot;/orgs/</span><span class="si">{user}</span><span class="s2">/teams{/team_slug}&quot;</span>

    <span class="n">TEAMS_MEMBERSHIP</span>  <span class="o">=</span> <span class="s2">&quot;/teams/</span><span class="si">{team_id}</span><span class="s2">/memberships/</span><span class="si">{username}</span><span class="s2">&quot;</span>

    <span class="n">SEARCH_ISSUES</span>     <span class="o">=</span> <span class="s2">&quot;/search/issues?q=&quot;</span>

    <span class="n">STATE</span> <span class="o">=</span> <span class="n">IssueState</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">to_user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bioconda&quot;</span><span class="p">,</span>
                 <span class="n">to_repo</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bioconda-recipes&quot;</span><span class="p">,</span>
                 <span class="n">installation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#: API Bearer Token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="c1">#: If set, no actual modifying actions are taken</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span> <span class="o">=</span> <span class="n">dry_run</span>
        <span class="c1">#: The installation ID if this instance is connected to an App</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installation</span> <span class="o">=</span> <span class="n">installation</span>
        <span class="c1">#: Owner of the Repo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">to_user</span>
        <span class="c1">#: Name of the Repo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span> <span class="o">=</span> <span class="n">to_repo</span>
        <span class="c1">#: Default variables for API calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_default</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">to_user</span><span class="p">,</span>
                            <span class="s1">&#39;repo&#39;</span><span class="p">:</span> <span class="n">to_repo</span><span class="p">}</span>

        <span class="c1"># filled in by login():</span>
        <span class="c1">#: Gidgethub API object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="p">:</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">GitHubAPI</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#: Login username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.user}</span><span class="s2">/</span><span class="si">{self.repo}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.__class__.__name__}</span><span class="s2">(</span><span class="si">{self.user}</span><span class="s2">/</span><span class="si">{self.repo}</span><span class="s2">)&quot;</span>

<div class="viewcode-block" id="GitHubHandler.for_json"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.for_json">[docs]</a>    <span class="k">def</span> <span class="nf">for_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return JSON repesentation of object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;__module__&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
            <span class="s1">&#39;__type__&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
            <span class="s1">&#39;dry_run&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">,</span>
            <span class="s1">&#39;to_user&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="s1">&#39;to_repo&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="p">,</span>
            <span class="s1">&#39;installation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">installation</span>
        <span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_json</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">sansio</span><span class="o">.</span><span class="n">RateLimit</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Last recorded rate limit data&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">rate_limit</span>

<div class="viewcode-block" id="GitHubHandler.set_oauth_token"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.set_oauth_token">[docs]</a>    <span class="k">def</span> <span class="nf">set_oauth_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update oauth token for the wrapped GitHubAPI object&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">oauth_token</span> <span class="o">=</span> <span class="n">token</span></div>

<div class="viewcode-block" id="GitHubHandler.create_api_object"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.create_api_object">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">create_api_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create API object&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="GitHubHandler.get_file_relurl"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.get_file_relurl">[docs]</a>    <span class="k">def</span> <span class="nf">get_file_relurl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">branch_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Format domain relative url for **path** on **branch_name**&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;/</span><span class="si">{user}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/tree/</span><span class="si">{branch_name}</span><span class="s2">/</span><span class="si">{path}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">branch_name</span><span class="o">=</span><span class="n">branch_name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubHandler.login"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.login">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log into API (fills `username`)&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_api_object</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;UNKNOWN [no token]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="s2">&quot;/user&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;login&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">GitHubException</span><span class="p">:</span>
                <span class="k">pass</span></div>

<div class="viewcode-block" id="GitHubHandler.iter_teams"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.iter_teams">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">iter_teams</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;List organization teams</span>

<span class="sd">        Returns:</span>
<span class="sd">          Async iterator over dicts, containing **id**,</span>
<span class="sd">          **name**, **slug**, **description**, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">team</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getiter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ORG_TEAMS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">team</span></div>

<div class="viewcode-block" id="GitHubHandler.get_team_id"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.get_team_id">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_team_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">team_slug</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="n">team_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the Team ID from the Team slug</span>

<span class="sd">        If both are set, **team_slug** is tried first.</span>

<span class="sd">        Args:</span>
<span class="sd">          team_slug: urlized team name, e.g. &quot;justice-league&quot; for &quot;Justice League&quot;</span>
<span class="sd">          team_name: alternative, use normal name (requires extra API call internally)</span>

<span class="sd">        Returns:</span>
<span class="sd">          Team ID if found, otherwise `None`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">team_slug</span><span class="p">:</span>
            <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
            <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;team_slug&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">team_slug</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">team</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ORG_TEAMS</span><span class="p">,</span> <span class="n">var_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">team</span> <span class="ow">and</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">team</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">team</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">404</span><span class="p">:</span>
                    <span class="k">raise</span>

        <span class="k">if</span> <span class="n">team_name</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">team</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_teams</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">team</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">team_name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">team</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubHandler.is_team_member"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.is_team_member">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_team_member</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">team</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if user is a member of given team</span>

<span class="sd">        Args:</span>
<span class="sd">          username: Name of user to check</span>
<span class="sd">          team: ID, Slug or Name of team to check</span>
<span class="sd">        Returns:</span>
<span class="sd">          True if the user is a member of the team</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">team</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">team_id</span> <span class="o">=</span> <span class="n">team</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">team_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_team_id</span><span class="p">(</span><span class="n">team</span><span class="p">,</span> <span class="n">team</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">team</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not find team for name &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">team</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">var_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
            <span class="s1">&#39;team_id&#39;</span><span class="p">:</span> <span class="n">team_id</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="s2">&quot;application/vnd.github.hellcat-preview+json&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEAMS_MEMBERSHIP</span><span class="p">,</span> <span class="n">var_data</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;active&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">404</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="GitHubHandler.is_member"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.is_member">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_member</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">team</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check user membership</span>

<span class="sd">        Args:</span>
<span class="sd">          username: Name of user for whom to check membership</span>
<span class="sd">          team: Name, Slug or ID of team to check</span>
<span class="sd">        Returns:</span>
<span class="sd">          True if the user is member of the organization, and, if **team**</span>
<span class="sd">          is provided, if user is member of that team.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ORG_MEMBERS</span><span class="p">,</span> <span class="n">var_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;User </span><span class="si">%s</span><span class="s2"> is not a member of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;User </span><span class="si">%s</span><span class="s2"> IS a member of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">team</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_team_member</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">team</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="GitHubHandler.search_issues"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.search_issues">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">search_issues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">issue</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Search issues/PRs on our repos</span>

<span class="sd">        Arguments:</span>
<span class="sd">          author: login name of user to search</span>
<span class="sd">          pr: whether to consider only PRs</span>
<span class="sd">          issue: whether to consider only non-PR issues</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;org:&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">pr</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">issue</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;is:pr&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">issue</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pr</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;is:issue&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">author</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;author:&quot;</span> <span class="o">+</span> <span class="n">author</span><span class="p">]</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_ISSUES</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query</span><span class="p">))</span></div>

<div class="viewcode-block" id="GitHubHandler.get_pr_count"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.get_pr_count">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_pr_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the number of PRs opened by user</span>

<span class="sd">        Arguments:</span>
<span class="sd">          user: login of user to query</span>

<span class="sd">        Returns:</span>
<span class="sd">          Number of PRs that **user** has opened so far</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_issues</span><span class="p">(</span><span class="n">pr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubHandler.is_org"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.is_org">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_org</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if we are operating on an organization&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ORG</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="c1"># pylint: disable=too-many-arguments</span>
<div class="viewcode-block" id="GitHubHandler.get_prs"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.get_prs">[docs]</a>    <span class="nd">@backoff</span><span class="o">.</span><span class="n">on_exception</span><span class="p">(</span><span class="n">backoff</span><span class="o">.</span><span class="n">fibo</span><span class="p">,</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_prs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">from_branch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">from_user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">to_branch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">number</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IssueState</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve list of PRs matching parameters</span>

<span class="sd">        Arguments:</span>
<span class="sd">          from_branch: Name of branch from which PR asks to pull</span>
<span class="sd">          from_user: Name of user/org in from which to pull</span>
<span class="sd">                     (default: from auth)</span>
<span class="sd">          to_branch: Name of branch into which to pull (default: master)</span>
<span class="sd">          number: PR number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_user</span><span class="p">:</span>
            <span class="n">from_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>
        <span class="k">if</span> <span class="n">from_branch</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">from_user</span><span class="p">:</span>
                <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{from_user}</span><span class="s2">:</span><span class="si">{from_branch}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_branch</span>
        <span class="k">if</span> <span class="n">to_branch</span><span class="p">:</span>
            <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_branch</span>
        <span class="k">if</span> <span class="n">number</span><span class="p">:</span>
            <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
            <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">accept</span> <span class="o">=</span> <span class="s2">&quot;application/vnd.github.shadow-cat-preview&quot;</span>  <span class="c1"># for draft</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PULLS</span><span class="p">,</span> <span class="n">var_data</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubHandler.iter_pr_commits"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.iter_pr_commits">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">iter_pr_commits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create iterator over commits in a PR&quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getiter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PULL_COMMITS</span><span class="p">,</span> <span class="n">var_data</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">item</span>
        <span class="k">except</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">GitHubException</span><span class="p">:</span>
            <span class="k">return</span></div>

    <span class="c1"># pylint: disable=too-many-arguments</span>
<div class="viewcode-block" id="GitHubHandler.create_pr"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.create_pr">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">create_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">from_branch</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">from_user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">to_branch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;master&quot;</span><span class="p">,</span>
                        <span class="n">body</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">maintainer_can_modify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">draft</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Create new PR</span>

<span class="sd">        Arguments:</span>
<span class="sd">          title: Title of new PR</span>
<span class="sd">          from_branch: Name of branch from which PR asks to pull (aka head)</span>
<span class="sd">          from_user: Name of user/org in from which to pull</span>
<span class="sd">          to_branch: Name of branch into which to pull (aka base, default: master)</span>
<span class="sd">          body: Body text of PR</span>
<span class="sd">          maintainer_can_modify: Whether to allow maintainer to modify from_branch</span>
<span class="sd">          draft: whether PR is draft</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_user</span><span class="p">:</span>
            <span class="n">from_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s1">&#39;base&#39;</span> <span class="p">:</span> <span class="n">to_branch</span><span class="p">,</span>
            <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">body</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;maintainer_can_modify&#39;</span><span class="p">:</span> <span class="n">maintainer_can_modify</span><span class="p">,</span>
            <span class="s1">&#39;draft&#39;</span><span class="p">:</span> <span class="n">draft</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">from_user</span> <span class="ow">and</span> <span class="n">from_user</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{from_user}</span><span class="s2">:</span><span class="si">{from_branch}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_branch</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PR data </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Would create PR &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; title: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">body</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; body:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating PR &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>

        <span class="n">accept</span> <span class="o">=</span> <span class="s2">&quot;application/vnd.github.shadow-cat-preview&quot;</span>  <span class="c1"># for draft</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PULLS</span><span class="p">,</span> <span class="n">var_data</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubHandler.merge_pr"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.merge_pr">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">merge_pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sha</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">method</span><span class="p">:</span> <span class="n">MergeMethod</span> <span class="o">=</span> <span class="n">MergeMethod</span><span class="o">.</span><span class="n">squash</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Merge a PR</span>

<span class="sd">        Arguments:</span>
<span class="sd">          number: PR Number</span>
<span class="sd">          title: Title for the commit message</span>
<span class="sd">          message: Message to append to automatic message</span>
<span class="sd">          sha: SHA PR head must match</span>
<span class="sd">          merge_method: `MergeMethod` to use. Defaults to squash.</span>

<span class="sd">        Returns:</span>
<span class="sd">          Tuple: True if successful and message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;commit_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
        <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;commit_message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span>
        <span class="k">if</span> <span class="n">sha</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sha</span>
        <span class="k">if</span> <span class="n">method</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;merge_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">name</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PULL_MERGE</span><span class="p">,</span> <span class="n">var_data</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">405</span><span class="p">,</span> <span class="mi">409</span><span class="p">):</span>
                <span class="c1"># not allowed / conflict</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="GitHubHandler.pr_is_merged"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.pr_is_merged">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">pr_is_merged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Checks whether a PR has been merged</span>

<span class="sd">        Arguments:</span>
<span class="sd">          number: PR Number</span>

<span class="sd">        Returns:</span>
<span class="sd">          True if the PR has been merged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PULL_MERGE</span><span class="p">,</span> <span class="n">var_data</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="GitHubHandler.modify_issue"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.modify_issue">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">modify_issue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                           <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">body</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Modify existing issue (PRs are issues)</span>

<span class="sd">        Arguments:</span>
<span class="sd">          labels: list of labels to assign to issue</span>
<span class="sd">          title: new title</span>
<span class="sd">          body: new body</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
        <span class="k">if</span> <span class="n">body</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Would modify PR </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New title: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New labels: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">body</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New Body:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="n">number</span><span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Modifying PR </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ISSUES</span><span class="p">,</span> <span class="n">var_data</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubHandler.create_comment"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.create_comment">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">create_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create issue comment</span>

<span class="sd">        Arguments:</span>
<span class="sd">          number: Issue number</span>
<span class="sd">          body: Comment content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">body</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Would create comment on issue #</span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating comment on issue #</span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ISSUE_COMMENTS</span><span class="p">,</span> <span class="n">var_data</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="GitHubHandler.iter_comments"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.iter_comments">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">iter_comments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;List comments for issue&quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getiter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ISSUE_COMMENTS</span><span class="p">,</span> <span class="n">var_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubHandler.update_comment"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.update_comment">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update issue comment</span>

<span class="sd">        Arguments:</span>
<span class="sd">          number: Comment number (NOT PR NUMBER!)</span>
<span class="sd">          body: Comment content</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;comment_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">body</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Would update comment </span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="n">number</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating comment </span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COMMENTS</span><span class="p">,</span> <span class="n">var_data</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="GitHubHandler.get_pr_modified_files"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.get_pr_modified_files">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_pr_modified_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the list of files modified by the PR</span>

<span class="sd">        Arguments:</span>
<span class="sd">          number: PR issue number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PULL_FILES</span><span class="p">,</span> <span class="n">var_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubHandler.create_check_run"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.create_check_run">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">create_check_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">head_sha</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">details_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">external_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a check run</span>

<span class="sd">        Arguments:</span>
<span class="sd">          name: The name of the check, e.g. ``bioconda-test``</span>
<span class="sd">          head_sha: The sha of the commit to check</span>
<span class="sd">          details_url: URL for &quot;View more details on &lt;App name&gt;&quot; link</span>
<span class="sd">          external_id: ID for us</span>

<span class="sd">        Returns:</span>
<span class="sd">          The ID of the check run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;head_sha&#39;</span><span class="p">:</span> <span class="n">head_sha</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">details_url</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;details_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details_url</span>
        <span class="k">if</span> <span class="n">external_id</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;external_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">external_id</span>

        <span class="n">accept</span> <span class="o">=</span> <span class="s2">&quot;application/vnd.github.antiope-preview+json&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CHECK_RUN</span><span class="p">,</span> <span class="n">var_data</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="GitHubHandler.modify_check_run"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.modify_check_run">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">modify_check_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                               <span class="n">status</span><span class="p">:</span> <span class="n">CheckRunStatus</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">conclusion</span><span class="p">:</span> <span class="n">CheckRunConclusion</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">output_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">output_summary</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">output_text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">output_annotations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Modify a check runs</span>

<span class="sd">        Arguments:</span>
<span class="sd">          number: id number of check run</span>
<span class="sd">          status: current status</span>
<span class="sd">          conclusion: result of check run, needed if status is completed</span>
<span class="sd">          output_title: title string for result window</span>
<span class="sd">          output_summary: subtitle/summary string for result window (reqired if title given)</span>
<span class="sd">          output_text: Markdown text for result window</span>
<span class="sd">          annotations: List of annotated code pieces, each has to have ``path``,</span>
<span class="sd">                       ``start_line`` and ``end_line``, ``annotation_level`` (``notice``,</span>
<span class="sd">                       ``warning``, ``failure``), and a ``message``. May also have</span>
<span class="sd">                       may have ``start_column`` and ``end_column`` (if only one line),</span>
<span class="sd">                       ``title`` and ``raw_details``.</span>
<span class="sd">          actions: List of up to three &quot;actions&quot; as dict of ``label``, ``description``</span>
<span class="sd">                   and ``identifier``</span>
<span class="sd">        Returns:</span>
<span class="sd">          Check run &quot;object&quot; as dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Modifying check run </span><span class="si">%i</span><span class="s2">: status=</span><span class="si">%s</span><span class="s2"> conclusion=</span><span class="si">%s</span><span class="s2"> title=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">number</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">conclusion</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">conclusion</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span> <span class="n">output_title</span><span class="p">)</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">CheckRunStatus</span><span class="o">.</span><span class="n">in_progress</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;started_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iso_now</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">conclusion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;conclusion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conclusion</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;completed_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iso_now</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">output_title</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">output_title</span><span class="p">,</span>
                <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="n">output_summary</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">output_text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">output_annotations</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;annotations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_annotations</span>
        <span class="k">if</span> <span class="n">actions</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">actions</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="s2">&quot;application/vnd.github.antiope-preview+json&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CHECK_RUN</span><span class="p">,</span> <span class="n">var_data</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubHandler.get_check_runs"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.get_check_runs">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_check_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sha</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;List check runs for **sha**</span>

<span class="sd">        Arguments:</span>
<span class="sd">          sha: The commit SHA for which  to search for check runs</span>
<span class="sd">        Returns:</span>
<span class="sd">          List of check run &quot;objects&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;commit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sha</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="s2">&quot;application/vnd.github.antiope-preview+json&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GET_CHECK_RUNS</span><span class="p">,</span> <span class="n">var_data</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;check_runs&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="GitHubHandler.get_statuses"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.get_statuses">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_statuses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sha</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;List status checks for **sha**</span>

<span class="sd">        Arguments:</span>
<span class="sd">          sha: The commit SHA for which to find statuses</span>
<span class="sd">        Returns:</span>
<span class="sd">          List of status &quot;objects&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;commit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sha</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GET_STATUSES</span><span class="p">,</span> <span class="n">var_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="GitHubHandler.get_branch_protection"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.get_branch_protection">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_branch_protection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Retrieve protection settings for branch</span>

<span class="sd">        Arguments:</span>
<span class="sd">          branch: Branch for which to get protection settings</span>

<span class="sd">        Returns:</span>
<span class="sd">          Deep dict as example below. Protections not in place will not be present</span>
<span class="sd">          in dict.</span>

<span class="sd">          .. code-block:: yaml</span>

<span class="sd">             required_status_checks:  # require status checks to pass</span>
<span class="sd">                 strict: False        # require PR branch to be up to date with base</span>
<span class="sd">                 contexts:            # list of status checks required</span>
<span class="sd">                    - bioconda-test</span>
<span class="sd">                 enforce_admins:      # admins, too, must follow rules</span>
<span class="sd">                    - enabled: True</span>
<span class="sd">             required_approving_review_count: 1  # 1 - 6 valid</span>
<span class="sd">             dismiss_stale_reviews: False  # auto dismiss approval after push</span>
<span class="sd">             require_code_owner_reviews: False</span>
<span class="sd">             required_pull_request_reviews:  # require approving review</span>
<span class="sd">                 dismissal_restrictions:  # specify who may dismiss reviews</span>
<span class="sd">                    users:</span>
<span class="sd">                      - login: bla</span>
<span class="sd">                    teams:</span>
<span class="sd">                      - id: 1</span>
<span class="sd">                      - name: Bl Ub</span>
<span class="sd">                      - slug: bl-ub</span>
<span class="sd">             restrictions:             # specify who may push</span>
<span class="sd">               users:</span>
<span class="sd">                 - login: bla</span>
<span class="sd">               teams:</span>
<span class="sd">                 - id: 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;branch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="s2">&quot;application/vnd.github.luke-cage-preview+json&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BRANCH_PROTECTION</span><span class="p">,</span> <span class="n">var_data</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="GitHubHandler.check_protections"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.check_protections">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">check_protections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pr_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                <span class="n">head_sha</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check whether PR meets protection requirements</span>

<span class="sd">        Arguments:</span>
<span class="sd">          pr_number: issue number of PR</span>
<span class="sd">          head_sha: if given, check that this is still the latest sha</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prs</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">pr_number</span><span class="p">)</span>
        <span class="c1"># check that no new commits were made</span>
        <span class="k">if</span> <span class="n">head_sha</span> <span class="ow">and</span> <span class="n">head_sha</span> <span class="o">!=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="s1">&#39;sha&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Most recent SHA in PR differs&quot;</span>
        <span class="n">head_sha</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span>
        <span class="c1"># check whether it&#39;s already merged</span>
        <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;merged&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;PR has already been merged&quot;</span>
        <span class="c1"># check whether it&#39;s in draft state</span>
        <span class="k">if</span> <span class="n">pr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;draft&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;PR is marked as draft&quot;</span>
        <span class="c1"># check whether it&#39;s mergeable</span>
        <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;mergeable&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;PR mergability unknown. Retry again later.&quot;</span>

        <span class="c1"># get required checks for target branch</span>
        <span class="n">protections</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_branch_protection</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">])</span>
        <span class="n">required_checks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">protections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;required_status_checks&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;contexts&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found required checks: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">required_checks</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_statuses</span><span class="p">(</span><span class="n">head_sha</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span>
                <span class="n">required_checks</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_check_runs</span><span class="p">(</span><span class="n">head_sha</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found check </span><span class="si">%s</span><span class="s2"> with state </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">check</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conclusion&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">check</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conclusion&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span>
                <span class="n">required_checks</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">check</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">required_checks</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s2">&quot;Missing checks for #</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pr_number</span><span class="p">,</span> <span class="n">required_checks</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Not all required checks have passed&quot;</span>

        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;LGTM&quot;</span></div>

<div class="viewcode-block" id="GitHubHandler.get_contents"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.get_contents">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get contents of a file in repo</span>

<span class="sd">        Arguments:</span>
<span class="sd">          path: file path</span>
<span class="sd">          ref: git reference (branch, commit, tag)</span>

<span class="sd">        Returns:</span>
<span class="sd">          The contents of the file</span>

<span class="sd">        Raises:</span>
<span class="sd">          RuntimeError if the content encoding is not understood.</span>
<span class="sd">          (Should always be base64)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
            <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="s1">&#39;master&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONTENTS</span><span class="p">,</span> <span class="n">var_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;base64&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Got unknown encoding for </span><span class="si">{self}</span><span class="s2">/</span><span class="si">{path}</span><span class="s2">:</span><span class="si">{ref}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">content_bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">])</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">content_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">content</span></div>

<div class="viewcode-block" id="GitHubHandler.delete_branch"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubHandler.delete_branch">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">delete_branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Delete a branch (ref)</span>

<span class="sd">        Arguments:</span>
<span class="sd">          ref: Name of reference/branch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_default</span><span class="p">)</span>
        <span class="n">var_data</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GIT_REFERENCE</span><span class="p">,</span> <span class="n">var_data</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AiohttpGitHubHandler"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.AiohttpGitHubHandler">[docs]</a><span class="k">class</span> <span class="nc">AiohttpGitHubHandler</span><span class="p">(</span><span class="n">GitHubHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;GitHubHandler using Aiohttp for HTTP requests</span>

<span class="sd">    Arguments:</span>
<span class="sd">      session: Aiohttp Client Session object</span>
<span class="sd">      requester: Identify self (e.g. user agent)</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="AiohttpGitHubHandler.create_api_object"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.AiohttpGitHubHandler.create_api_object">[docs]</a>    <span class="k">def</span> <span class="nf">create_api_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">,</span>
                          <span class="n">requester</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">GitHubAPI</span><span class="p">(</span>
            <span class="n">session</span><span class="p">,</span> <span class="n">requester</span><span class="p">,</span> <span class="n">oauth_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span></div></div>


<div class="viewcode-block" id="Event"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.Event">[docs]</a><span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">gidgethub</span><span class="o">.</span><span class="n">sansio</span><span class="o">.</span><span class="n">Event</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds **get(path)** method to Github Webhook event&quot;&quot;&quot;</span>
<div class="viewcode-block" id="Event.get"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.Event.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">altvalue</span><span class="o">=</span><span class="ne">KeyError</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get subkeys from even data using slash separated path&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">altvalue</span> <span class="o">==</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;No &#39;</span><span class="si">{path}</span><span class="s2">&#39; in event type </span><span class="si">{self.event}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">altvalue</span>
        <span class="k">return</span> <span class="n">data</span></div></div>


<div class="viewcode-block" id="GitHubAppHandler"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubAppHandler">[docs]</a><span class="k">class</span> <span class="nc">GitHubAppHandler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Handles interaction with Github as App&quot;&quot;&quot;</span>

    <span class="c1">#: Github API url for creating an access token for a specific installation</span>
    <span class="c1">#: of an app.</span>
    <span class="n">INSTALLATION_TOKEN</span> <span class="o">=</span> <span class="s2">&quot;/app/installations/</span><span class="si">{installation_id}</span><span class="s2">/access_tokens&quot;</span>

    <span class="c1">#: Get installation info</span>
    <span class="n">INSTALLATION</span> <span class="o">=</span> <span class="s2">&quot;/repos/</span><span class="si">{owner}</span><span class="s2">/</span><span class="si">{repo}</span><span class="s2">/installation&quot;</span>

    <span class="c1">#: Lifetime of JWT in seconds</span>
    <span class="n">JWT_RENEW_PERIOD</span> <span class="o">=</span> <span class="mi">600</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">,</span>
                 <span class="n">app_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">app_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">app_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#: Name of app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">app_name</span>

        <span class="c1">#: Our client session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="c1">#: Cache for GET queries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cachetools</span><span class="o">.</span><span class="n">LRUCache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
        <span class="c1">#: Authorization key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app_key</span> <span class="o">=</span> <span class="n">app_key</span>
        <span class="c1">#: ID of app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app_id</span> <span class="o">=</span> <span class="n">app_id</span>
        <span class="c1">#: JWT and its expiry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jwt</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1">#: OAUTH tokens for installations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tokens</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#: GitHubHandlers for each installation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">GitHubHandler</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="GitHubAppHandler.get_app_jwt"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubAppHandler.get_app_jwt">[docs]</a>    <span class="k">def</span> <span class="nf">get_app_jwt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns JWT authenticating as this app&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">expires</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jwt</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expires</span> <span class="ow">or</span> <span class="n">expires</span> <span class="o">&lt;</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">60</span><span class="p">:</span>
            <span class="n">expires</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">JWT_RENEW_PERIOD</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;iat&#39;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
                <span class="s1">&#39;exp&#39;</span><span class="p">:</span> <span class="n">expires</span><span class="p">,</span>
                <span class="s1">&#39;iss&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_id</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">token_utf8</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;RS256&quot;</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">token_utf8</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_jwt</span> <span class="o">=</span> <span class="p">(</span><span class="n">expires</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Created new&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Reusing&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> JWT valid for </span><span class="si">%i</span><span class="s2"> minutes&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="n">expires</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="GitHubAppHandler.parse_isotime"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubAppHandler.parse_isotime">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_isotime</span><span class="p">(</span><span class="n">timestr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Converts UTC ISO 8601 time stamp to seconds in epoch&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timestr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Time String &#39;</span><span class="si">%s</span><span class="s2">&#39; not in UTC&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span><span class="p">)))</span></div>

<div class="viewcode-block" id="GitHubAppHandler.get_installation_token"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubAppHandler.get_installation_token">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_installation_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">installation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns OAUTH token for installation referenced in **event**&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">installation</span>
        <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">expires</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">installation</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expires</span> <span class="ow">or</span> <span class="n">expires</span> <span class="o">&lt;</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">60</span><span class="p">:</span>
            <span class="n">api</span> <span class="o">=</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">GitHubAPI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">api</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">INSTALLATION_TOKEN</span><span class="p">,</span>
                    <span class="p">{</span><span class="s1">&#39;installation_id&#39;</span><span class="p">:</span> <span class="n">installation</span><span class="p">},</span>
                    <span class="n">data</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">accept</span><span class="o">=</span><span class="s2">&quot;application/vnd.github.machine-man-preview+json&quot;</span><span class="p">,</span>
                    <span class="n">jwt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_app_jwt</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to get installation token for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">raise</span>

            <span class="n">expires</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_isotime</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;expires_at&#39;</span><span class="p">])</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tokens</span><span class="p">[</span><span class="n">installation</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">expires</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Created new&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Reusing&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> token for </span><span class="si">%i</span><span class="s2"> valid for </span><span class="si">%i</span><span class="s2"> minutes&quot;</span><span class="p">,</span>
                     <span class="n">msg</span><span class="p">,</span> <span class="n">installation</span><span class="p">,</span> <span class="p">(</span><span class="n">expires</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="GitHubAppHandler.get_installation_id"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubAppHandler.get_installation_id">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_installation_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">repo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve installation ID given user and repo&quot;&quot;&quot;</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">gidgethub</span><span class="o">.</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">GitHubAPI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">api</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INSTALLATION</span><span class="p">,</span>
                                <span class="p">{</span><span class="s1">&#39;owner&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">:</span> <span class="n">repo</span><span class="p">},</span>
                                <span class="n">accept</span><span class="o">=</span><span class="s2">&quot;application/vnd.github.machine-man-preview+json&quot;</span><span class="p">,</span>
                                <span class="n">jwt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_app_jwt</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="GitHubAppHandler.get_github_api"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.githubhandler.html#bioconda_utils.githubhandler.GitHubAppHandler.get_github_api">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_github_api</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">to_user</span><span class="p">,</span> <span class="n">to_repo</span><span class="p">,</span> <span class="n">installation</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GitHubHandler</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns the GitHubHandler for the installation the event came from&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">installation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">installation</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_installation_id</span><span class="p">(</span><span class="n">to_user</span><span class="p">,</span> <span class="n">to_repo</span><span class="p">)</span>

        <span class="n">handler_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">installation</span><span class="p">,</span> <span class="n">to_repo</span><span class="p">)</span>
        <span class="n">api</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">handler_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api</span><span class="p">:</span>
            <span class="c1"># update oauth token (ours expire)</span>
            <span class="n">api</span><span class="o">.</span><span class="n">set_oauth_token</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_installation_token</span><span class="p">(</span><span class="n">installation</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">api</span> <span class="o">=</span> <span class="n">AiohttpGitHubHandler</span><span class="p">(</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_installation_token</span><span class="p">(</span><span class="n">installation</span><span class="p">),</span>
                <span class="n">to_user</span><span class="o">=</span><span class="n">to_user</span><span class="p">,</span> <span class="n">to_repo</span><span class="o">=</span><span class="n">to_repo</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
                <span class="n">installation</span><span class="o">=</span><span class="n">installation</span>
            <span class="p">)</span>
            <span class="n">api</span><span class="o">.</span><span class="n">create_api_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">handler_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">api</span>
        <span class="k">return</span> <span class="n">api</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2016-2019, The Bioconda Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    <div class="git-ribbon">
      <a href="https://github.com/bioconda/bioconda-utils/edit/master/bioconda_utils/githubhandler.py" rel="me">Edit me on GitHub</a>
    </div>
  </body>
</html>