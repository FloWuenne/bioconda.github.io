
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>bioconda_utils.hosters &#8212; Bioconda  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/font-awesome-4.7.0/css/font-awesome.min.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="https://fonts.googleapis.com/css?family=Lato|Raleway" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">

    <link rel="apple-touch-icon" sizes="57x57" href="../../_static/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../../_static/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../../_static/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../../_static/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../../_static/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../../_static/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../../_static/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../../_static/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../_static/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="../../_static/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../_static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../../_static/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../_static/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="../../_static/ms-icon-144x144.png">

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />


  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo/bioconda_monochrome_small.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user/index.html">User Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributor/index.html">Contributing to Bioconda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Docs</a></li>
</ul>

<ul>
  
  <li class="toctree-l1"><a href="https://github.com/bioconda/bioconda-recipes">Bioconda @ Github</a></li>
  
  <li class="toctree-l1"><a href="../../conda-recipe_index.html">Recipe Index</a></li>
  
  <li class="toctree-l1"><a href="https://gitter.im/bioconda/Lobby"><img alt="Gitter" src="https://img.shields.io/gitter/room/bioconda/Lobby.svg"></a></li>
  
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bioconda_utils.hosters</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Check package URLs for updates</span>

<span class="sd">Subclasses of `Hoster` define how to handle each hoster. Hosters are</span>
<span class="sd">selected by regex matching each source URL in a recipe. The</span>
<span class="sd">`HTMLHoster` provides parsing for hosting sites listing new</span>
<span class="sd">releases in HTML format (probably covers most). Adding a hoster is</span>
<span class="sd">as simple as defining a regex to match the existing source URL, a</span>
<span class="sd">formatting string creating the URL of the relases page and a regex</span>
<span class="sd">to match links and extract their version.</span>

<span class="sd">- We need to use :conda:package:`regex` rather than `re` to allow</span>
<span class="sd">  recursive matching to manipulate capture groups in URL patterns as</span>
<span class="sd">  needed. (Technically, we could avoid this using a Snakemake wildcard</span>
<span class="sd">  type syntax to define the patterns - implementers welcome).</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">redirect_stdout</span><span class="p">,</span> <span class="n">redirect_stderr</span>
<span class="kn">from</span> <span class="nn">distutils.version</span> <span class="kn">import</span> <span class="n">LooseVersion</span>
<span class="kn">from</span> <span class="nn">html.parser</span> <span class="kn">import</span> <span class="n">HTMLParser</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Match</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Pattern</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span>
                    <span class="n">Optional</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span>

<span class="kn">import</span> <span class="nn">regex</span> <span class="k">as</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">.aiopipe</span> <span class="kn">import</span> <span class="n">AsyncRequests</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-name</span>


<span class="c1">#: Matches named capture groups</span>
<span class="c1">#: This is so complicated because we need to parse matched, not-escaped</span>
<span class="c1">#: parentheses to determine where the clause ends.</span>
<span class="c1">#: Requires regex package for recursion.</span>
<span class="n">RE_CAPGROUP</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(\?P&lt;(\w+)&gt;(?&gt;[^()]+|</span><span class="se">\\</span><span class="s2">\(|</span><span class="se">\\</span><span class="s2">\)|(\((?&gt;[^()]+|</span><span class="se">\\</span><span class="s2">\(|</span><span class="se">\\</span><span class="s2">\)|(?2))*\)))*\)&quot;</span><span class="p">)</span>
<span class="n">RE_REFGROUP</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(\?P=(\w+)\)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="dedup_named_capture_group"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.dedup_named_capture_group">[docs]</a><span class="k">def</span> <span class="nf">dedup_named_capture_group</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replaces repetitions of capture groups with matches to first instance&quot;&quot;&quot;</span>
    <span class="n">seen</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="s2">&quot;inner replace&quot;</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(?P=</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">RE_CAPGROUP</span><span class="p">,</span> <span class="n">replace</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span></div>


<div class="viewcode-block" id="replace_named_capture_group"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.replace_named_capture_group">[docs]</a><span class="k">def</span> <span class="nf">replace_named_capture_group</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">vals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Replaces capture groups with values from **vals**&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="s2">&quot;inner replace&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">RE_CAPGROUP</span><span class="p">,</span> <span class="n">replace</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">RE_REFGROUP</span><span class="p">,</span> <span class="n">replace</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="HosterMeta"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.HosterMeta">[docs]</a><span class="k">class</span> <span class="nc">HosterMeta</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Meta-Class for Hosters</span>

<span class="sd">    By making Hosters classes of a metaclass, rather than instances of a class,</span>
<span class="sd">    we leave the option to add functions to a Hoster.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hoster_types</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;HosterMeta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bases</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
                <span class="n">namespace</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates Hoster classes</span>

<span class="sd">        - expands references among ``{var}_pattern`` attributes</span>
<span class="sd">        - compiles ``{var}_pattern`` attributes to ``{var}_re``</span>
<span class="sd">        - registers complete classes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isabstract</span><span class="p">(</span><span class="n">typ</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">typ</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">typ</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Custom&quot;</span><span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">hoster_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>

        <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_pattern&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_pattern&quot;</span><span class="p">)}</span>

        <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="c1"># expand pattern references:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">new_pattern</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">[</span><span class="n">pat</span><span class="p">]</span>
            <span class="k">while</span> <span class="n">pattern</span> <span class="o">!=</span> <span class="n">new_pattern</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">new_pattern</span>
                <span class="n">new_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\{\d+,?\d*\})&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;{\1}&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
                <span class="n">new_pattern</span> <span class="o">=</span> <span class="n">new_pattern</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">patterns</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
            <span class="n">patterns</span><span class="p">[</span><span class="n">pat</span><span class="p">]</span> <span class="o">=</span> <span class="n">pattern</span>
            <span class="c1"># repair duplicate capture groups:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">dedup_named_capture_group</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="c1"># save parsed and compiled pattern</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">pat</span> <span class="o">+</span> <span class="s2">&quot;_pattern_compiled&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Pattern </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">typ</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">pat</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">pat</span> <span class="o">+</span> <span class="s2">&quot;_re&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">typ</span>

<div class="viewcode-block" id="HosterMeta.select_hoster"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.HosterMeta.select_hoster">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">select_hoster</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Hoster&quot;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Select `Hoster` able to handle **url**</span>

<span class="sd">        Returns: `Hoster` or `None`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Matching url &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">hoster_type</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">hoster_types</span><span class="p">:</span>
            <span class="n">hoster</span> <span class="o">=</span> <span class="n">hoster_type</span><span class="o">.</span><span class="n">try_make_hoster</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hoster</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">hoster</span>
        <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="Hoster"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.Hoster">[docs]</a><span class="k">class</span> <span class="nc">Hoster</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">HosterMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Hoster Baseclass&quot;&quot;&quot;</span>

    <span class="c1">#: matches upstream version</span>
    <span class="c1">#: - begins with a number</span>
    <span class="c1">#: - then only numbers, characters or one of -, +, ., :, ~</span>
    <span class="c1">#: - at most 31 characters length (to avoid matching checksums)</span>
    <span class="c1">#: - accept v or r as prefix if after slash, dot, underscore or dash</span>
    <span class="n">version_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?:(?&lt;=[/._-])[rv])?(?P&lt;version&gt;\d[\da-zA-Z\-+\.:\~_]{0,30})&quot;</span>

    <span class="c1">#: matches archive file extensions</span>
    <span class="n">ext_pattern</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;ext&gt;(?i)\.(?:(?:(tar\.|t)(?:xz|bz2|gz))|zip|jar))&quot;</span>

    <span class="c1">#: named patterns that will change with a version upgrade</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">url_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s2">&quot;matches upstream package url&quot;</span>

    <span class="c1">#: will be generated as each class is created</span>
    <span class="n">url_re</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">link_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s2">&quot;matches links on relase page&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">releases_formats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="s2">&quot;format template for release page URL&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">match</span><span class="p">:</span> <span class="n">Match</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">releases_urls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">template</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">releases_formats</span>
        <span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> matched </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">)</span>

<div class="viewcode-block" id="Hoster.try_make_hoster"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.Hoster.try_make_hoster">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">try_make_hoster</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Hoster&quot;</span><span class="p">],</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Hoster&quot;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creates hoster if **url** is matched by its **url_pattern**&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">klass</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;Hoster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span>
                    <span class="s2">&quot;Customized&quot;</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="p">(</span><span class="bp">cls</span><span class="p">,),</span>
                    <span class="p">{</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_pattern&quot;</span><span class="p">:</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Overrides invalid for </span><span class="si">%s</span><span class="s2"> - skipping&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">klass</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">url_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">klass</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">match</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Hoster.get_versions"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.Hoster.get_versions">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_versions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="s2">&quot;AsyncRequests&quot;</span><span class="p">,</span> <span class="n">orig_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="s2">&quot;Gets list of versions from upstream hosting site&quot;</span></div></div>


<div class="viewcode-block" id="HrefParser"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.HrefParser">[docs]</a><span class="k">class</span> <span class="nc">HrefParser</span><span class="p">(</span><span class="n">HTMLParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract link targets from HTML&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">link_re</span><span class="p">:</span> <span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_re</span> <span class="o">=</span> <span class="n">link_re</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="HrefParser.get_matches"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.HrefParser.get_matches">[docs]</a>    <span class="k">def</span> <span class="nf">get_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Return matches found for **link_re** in href links&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches</span></div>

    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attrs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;href&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handle_a_href</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">break</span>

<div class="viewcode-block" id="HrefParser.handle_a_href"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.HrefParser.handle_a_href">[docs]</a>    <span class="k">def</span> <span class="nf">handle_a_href</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">href</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Process href attributes of anchor tags&quot;&quot;&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">href</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;href&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">href</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Error parsing HTML: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div>


<span class="c1"># pylint: disable=abstract-method</span>
<div class="viewcode-block" id="HTMLHoster"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.HTMLHoster">[docs]</a><span class="k">class</span> <span class="nc">HTMLHoster</span><span class="p">(</span><span class="n">Hoster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base for Hosters handling release listings in HTML format&quot;&quot;&quot;</span>

<div class="viewcode-block" id="HTMLHoster.get_versions"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.HTMLHoster.get_versions">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">orig_version</span><span class="p">):</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">}</span>
        <span class="n">link_pattern</span> <span class="o">=</span> <span class="n">replace_named_capture_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link_pattern_compiled</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
        <span class="n">link_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">link_pattern</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">releases_urls</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">HrefParser</span><span class="p">(</span><span class="n">link_re</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="k">await</span> <span class="n">req</span><span class="o">.</span><span class="n">get_text_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_matches</span><span class="p">():</span>
                <span class="n">match</span><span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">match</span><span class="p">[</span><span class="s2">&quot;href&quot;</span><span class="p">])</span>
                <span class="n">match</span><span class="p">[</span><span class="s2">&quot;releases_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>

                <span class="n">match</span><span class="p">[</span><span class="s2">&quot;vals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div></div>


<div class="viewcode-block" id="FTPHoster"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.FTPHoster">[docs]</a><span class="k">class</span> <span class="nc">FTPHoster</span><span class="p">(</span><span class="n">Hoster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scans for updates on FTP servers&quot;&quot;&quot;</span>
<div class="viewcode-block" id="FTPHoster.get_versions"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.FTPHoster.get_versions">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">orig_version</span><span class="p">):</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">}</span>
        <span class="n">link_pattern</span> <span class="o">=</span> <span class="n">replace_named_capture_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link_pattern_compiled</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
        <span class="n">link_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">link_pattern</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">releases_urls</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="k">await</span> <span class="n">req</span><span class="o">.</span><span class="n">get_ftp_listing</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">link_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fname</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ftp://&quot;</span> <span class="o">+</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fname</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;releases_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="n">version_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?:(?&lt;=[/._-])[rv])?(?P&lt;version&gt;\d[\da-zA-Z\-+\.:\~_]{0,30}?)&quot;</span>
    <span class="n">host_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;host&gt;[-_.\w]+)&quot;</span>
    <span class="n">path_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;path&gt;[-_/.\w]+/)&quot;</span>
    <span class="n">package_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;package&gt;[-_\w]+)&quot;</span>
    <span class="n">suffix_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;suffix&gt;([-_](lin|linux|Linux|x64|x86|src|64|OSX))*)&quot;</span>
    <span class="n">link_pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{path}{package}{version}{suffix}{ext}</span><span class="s2">&quot;</span>
    <span class="n">url_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;ftp://</span><span class="si">{host}</span><span class="s2">/</span><span class="si">{link}</span><span class="s2">&quot;</span>
    <span class="n">releases_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ftp://</span><span class="si">{host}</span><span class="s2">/</span><span class="si">{path}</span><span class="s2">&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="OrderedHTMLHoster"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.OrderedHTMLHoster">[docs]</a><span class="k">class</span> <span class="nc">OrderedHTMLHoster</span><span class="p">(</span><span class="n">HTMLHoster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;HTMLHoster for which we can expected newest releases at top</span>

<span class="sd">    The point isn&#39;t performance, but avoiding hassle with old versions</span>
<span class="sd">    which may follow different versioning schemes.</span>
<span class="sd">    E.g. 0.09 -&gt; 0.10 -&gt; 0.2 -&gt; 0.2.1</span>

<span class="sd">    FIXME: If the current version is not in the list, that&#39;s likely</span>
<span class="sd">           a pathologic case. Should be handled somewhere.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="OrderedHTMLHoster.get_versions"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.OrderedHTMLHoster.get_versions">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">orig_version</span><span class="p">):</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_versions</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">orig_version</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">match</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">matches</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">num</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">matches</span>
        <span class="k">return</span> <span class="n">matches</span><span class="p">[:</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="GithubBase"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.GithubBase">[docs]</a><span class="k">class</span> <span class="nc">GithubBase</span><span class="p">(</span><span class="n">OrderedHTMLHoster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for software hosted on github.com&quot;&quot;&quot;</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;fname&#39;</span><span class="p">]</span>
    <span class="n">account_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;account&gt;[-\w]+)&quot;</span>
    <span class="n">project_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;project&gt;[-.\w]+)&quot;</span>
    <span class="n">prefix_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;prefix&gt;[-_./\w]+?)&quot;</span>
    <span class="n">suffix_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;suffix&gt;[-_](lin)?)&quot;</span>
    <span class="c1">#tag_pattern = &quot;{prefix}??{version}{suffix}??&quot;</span>
    <span class="n">tag_pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{prefix}</span><span class="s2">??</span><span class="si">{version}</span><span class="s2">&quot;</span>
    <span class="n">url_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;github\.com</span><span class="si">{link}</span><span class="s2">&quot;</span>
    <span class="n">fname_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;fname&gt;[^/]+)&quot;</span>
    <span class="n">releases_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://github.com/</span><span class="si">{account}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/releases&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="GithubRelease"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.GithubRelease">[docs]</a><span class="k">class</span> <span class="nc">GithubRelease</span><span class="p">(</span><span class="n">GithubBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Matches release artifacts uploaded to Github&quot;&quot;&quot;</span>
    <span class="n">link_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;/</span><span class="si">{account}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/releases/download/</span><span class="si">{tag}</span><span class="s2">/</span><span class="si">{fname}{ext}</span><span class="s2">?&quot;</span></div>


<div class="viewcode-block" id="GithubTag"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.GithubTag">[docs]</a><span class="k">class</span> <span class="nc">GithubTag</span><span class="p">(</span><span class="n">GithubBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Matches GitHub repository archives created automatically from tags&quot;&quot;&quot;</span>
    <span class="n">link_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;/</span><span class="si">{account}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/archive/</span><span class="si">{tag}{ext}</span><span class="s2">&quot;</span>
    <span class="n">releases_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://github.com/</span><span class="si">{account}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/tags&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="GithubReleaseAttachment"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.GithubReleaseAttachment">[docs]</a><span class="k">class</span> <span class="nc">GithubReleaseAttachment</span><span class="p">(</span><span class="n">GithubBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Matches release artifacts uploaded as attachment to release notes&quot;&quot;&quot;</span>
    <span class="n">link_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;/</span><span class="si">{account}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/files/\d+/</span><span class="si">{tag}{ext}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="GithubRepoStore"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.GithubRepoStore">[docs]</a><span class="k">class</span> <span class="nc">GithubRepoStore</span><span class="p">(</span><span class="n">GithubBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Matches release artifacts stored in a github repo&quot;&quot;&quot;</span>
    <span class="n">branch_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(master|[\da-f]</span><span class="si">{40}</span><span class="s2">)&quot;</span>
    <span class="n">subdir_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;subdir&gt;([-._\w]+/)+)&quot;</span>
    <span class="n">link_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;/</span><span class="si">{account}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/blob/master/</span><span class="si">{subdir}{tag}{ext}</span><span class="s2">&quot;</span>
    <span class="n">url_pattern</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:(?P&lt;raw&gt;raw\.githubusercontent)|github)\.com/&quot;</span>
                   <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{account}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/(?(raw)|(?:(?P&lt;blob&gt;blob/)|raw/))&quot;</span>
                   <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{branch}</span><span class="s2">/</span><span class="si">{subdir}</span><span class="s2">?</span><span class="si">{tag}{ext}</span><span class="s2">(?(blob)\?raw|)&quot;</span><span class="p">)</span>
    <span class="n">releases_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://github.com/</span><span class="si">{account}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/tree/master/</span><span class="si">{subdir}</span><span class="s2">&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Bioconductor"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.Bioconductor">[docs]</a><span class="k">class</span> <span class="nc">Bioconductor</span><span class="p">(</span><span class="n">HTMLHoster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Matches R packages hosted at Bioconductor&quot;&quot;&quot;</span>
    <span class="n">link_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;/src/contrib/(?P&lt;package&gt;[^/]+)_</span><span class="si">{version}{ext}</span><span class="s2">&quot;</span>
    <span class="n">section_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;/(bioc|data/annotation|data/experiment)&quot;</span>
    <span class="n">url_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;bioconductor.org/packages/(?P&lt;bioc&gt;[\d\.]+)</span><span class="si">{section}{link}</span><span class="s2">&quot;</span>
    <span class="n">releases_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://bioconductor.org/packages/</span><span class="si">{bioc}</span><span class="s2">/bioc/html/</span><span class="si">{package}</span><span class="s2">.html&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="CargoPort"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.CargoPort">[docs]</a><span class="k">class</span> <span class="nc">CargoPort</span><span class="p">(</span><span class="n">HTMLHoster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Matches source backup urls created by cargo-port&quot;&quot;&quot;</span>
    <span class="n">os_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;_(?P&lt;os&gt;src_all|linux_x86|darwin_x86)&quot;</span>
    <span class="n">link_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;package&gt;[^/]+)_</span><span class="si">{version}{os}{ext}</span><span class="s2">&quot;</span>
    <span class="n">url_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;depot.galaxyproject.org/software/(?P&lt;package&gt;[^/]+)/</span><span class="si">{link}</span><span class="s2">&quot;</span>
    <span class="n">releases_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://depot.galaxyproject.org/software/</span><span class="si">{package}</span><span class="s2">&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="SourceForge"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.SourceForge">[docs]</a><span class="k">class</span> <span class="nc">SourceForge</span><span class="p">(</span><span class="n">HTMLHoster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Matches packages hosted at SourceForge&quot;&quot;&quot;</span>
    <span class="n">project_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;project&gt;[-\w]+)&quot;</span>
    <span class="n">subproject_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;((?P&lt;subproject&gt;[-\w%]+)/)?&quot;</span>
    <span class="n">baseurl_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;sourceforge\.net/project(s)?/</span><span class="si">{project}</span><span class="s2">/(?(1)files/|)</span><span class="si">{subproject}</span><span class="s2">&quot;</span>

    <span class="n">package_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;package&gt;[-\w_\.+]*?[a-zA-Z+])&quot;</span>
    <span class="n">type_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;type&gt;((linux|x?(64|86)|src|source|all|core|java\d?)[-_.])*)&quot;</span>
    <span class="n">type2_pattern</span> <span class="o">=</span> <span class="n">type_pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;type2&quot;</span><span class="p">)</span>
    <span class="n">sep_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;sep&gt;[-_.]?)&quot;</span>  <span class="c1"># separator between package name and version</span>
    <span class="n">filename_pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{package}{sep}</span><span class="s2">(</span><span class="si">{type2}{sep}</span><span class="s2">)?</span><span class="si">{version}</span><span class="s2">(</span><span class="si">{sep}{type}</span><span class="s2">)?</span><span class="si">{ext}</span><span class="s2">&quot;</span>

    <span class="n">url_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{baseurl}{filename}</span><span class="s2">&quot;</span>
    <span class="n">link_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{baseurl}{filename}</span><span class="s2">&quot;</span>
    <span class="n">releases_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://sourceforge.net/projects/</span><span class="si">{project}</span><span class="s2">/files/&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="JSONHoster"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.JSONHoster">[docs]</a><span class="k">class</span> <span class="nc">JSONHoster</span><span class="p">(</span><span class="n">Hoster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base for Hosters handling release listings in JSON format&quot;&quot;&quot;</span>
<div class="viewcode-block" id="JSONHoster.get_versions"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.JSONHoster.get_versions">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">orig_version</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">releases_urls</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">req</span><span class="o">.</span><span class="n">get_text_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_versions_from_json</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">orig_version</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">match</span><span class="p">[</span><span class="s1">&#39;releases_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>
    <span class="n">link_pattern</span> <span class="o">=</span> <span class="s2">&quot;https://</span><span class="si">{url}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="JSONHoster.get_versions_from_json"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.JSONHoster.get_versions_from_json">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_versions_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">orig_version</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Extract matches from json data in **data**</span>
<span class="sd">        &quot;&quot;&quot;</span></div></div>


<div class="viewcode-block" id="PyPi"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.PyPi">[docs]</a><span class="k">class</span> <span class="nc">PyPi</span><span class="p">(</span><span class="n">JSONHoster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scans PyPi for updates&quot;&quot;&quot;</span>
<div class="viewcode-block" id="PyPi.get_versions_from_json"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.PyPi.get_versions_from_json">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_versions_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">orig_version</span><span class="p">):</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">][</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vers</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">latest</span><span class="p">,</span> <span class="n">orig_version</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">vers</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;releases&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;releases&#39;</span><span class="p">][</span><span class="n">vers</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;packagetype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sdist&quot;</span><span class="p">:</span>
                    <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
                    <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vers</span>
                    <span class="n">rel</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_requirements</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">digest</span><span class="p">,</span> <span class="n">python_version</span><span class="p">,</span> <span class="n">build_config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call into conda_build.skeletons.pypi to handle the ugly mess of extracting</span>
<span class="sd">        requirements from python packages.</span>

<span class="sd">        Note: It is not safe to call into conda multiple times parallel, and thus this</span>
<span class="sd">        function must not be called in parallel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">conda_build.skeletons.pypi</span> <span class="kn">import</span> <span class="n">get_pkginfo</span><span class="p">,</span> <span class="n">get_requirements</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/dev/null&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">devnull</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">devnull</span><span class="p">),</span> <span class="n">redirect_stderr</span><span class="p">(</span><span class="n">devnull</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pkg_info</span> <span class="o">=</span> <span class="n">get_pkginfo</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">digest</span><span class="p">,</span> <span class="n">python_version</span><span class="p">,</span>
                                           <span class="p">[],</span> <span class="n">build_config</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="n">requirements</span> <span class="o">=</span> <span class="n">get_requirements</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">pkg_info</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">requirements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">requirements</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">requirements</span> <span class="o">=</span> <span class="n">requirements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">requirements_fixed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">req</span><span class="p">:</span>
                <span class="n">requirements_fixed</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">requirements_fixed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pkg_info</span><span class="p">,</span> <span class="n">requirements_fixed</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_python_version</span><span class="p">(</span><span class="n">rel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to determine correct python version&quot;&quot;&quot;</span>
        <span class="n">choose_from</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;3.6&#39;</span><span class="p">,</span> <span class="s1">&#39;3.5&#39;</span><span class="p">,</span> <span class="s1">&#39;3.7&#39;</span><span class="p">,</span> <span class="s1">&#39;2.7&#39;</span><span class="p">)</span>

        <span class="n">requires_python</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;requires_python&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">requires_python</span><span class="p">:</span>
            <span class="n">requires_python</span> <span class="o">=</span> <span class="n">requires_python</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">checks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">requires_python</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="p">((</span><span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">),</span>
                                  <span class="p">(</span><span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">y</span><span class="p">),</span>
                                  <span class="p">(</span><span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">y</span><span class="p">),</span>
                                  <span class="p">(</span><span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">y</span><span class="p">),</span>
                                  <span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">),</span>
                                  <span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">),</span>
                                  <span class="p">(</span><span class="s1">&#39;~=&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">check</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                        <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">func</span><span class="p">,</span> <span class="n">check</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">):]))</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">checks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">,</span> <span class="n">check</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">vers</span> <span class="ow">in</span> <span class="n">choose_from</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="n">LooseVersion</span><span class="p">(</span><span class="n">vers</span><span class="p">),</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="n">check</span><span class="p">))</span>
                           <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">vers</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to compare </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vers</span><span class="p">,</span> <span class="n">requires_python</span><span class="p">)</span>

        <span class="n">python_versions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">classifier</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;::&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">classifier</span> <span class="ow">in</span> <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;classifiers&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">classifier</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Programming Language :: Python ::&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">vers</span> <span class="ow">in</span> <span class="n">choose_from</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vers</span> <span class="ow">in</span> <span class="n">python_versions</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">vers</span>

        <span class="k">return</span> <span class="s1">&#39;2.7&#39;</span>


<div class="viewcode-block" id="PyPi.get_deps"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.PyPi.get_deps">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">build_config</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">rel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get dependencies for **package** using version data **rel**</span>

<span class="sd">        This is messy even though we use conda_build.skeleton.pypi to</span>
<span class="sd">        extract the requirements from a setup.py. Since the setup.py</span>
<span class="sd">        actually gets executed, all manner of things can happen</span>
<span class="sd">        (e.g. for one Bioconda package, this triggers compilation</span>
<span class="sd">        of a binary module).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">req</span>
        <span class="c1"># We download ourselves to get async benefits</span>
        <span class="n">target_file</span> <span class="o">=</span> <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
        <span class="n">target_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build_config</span><span class="o">.</span><span class="n">src_cache</span><span class="p">,</span> <span class="n">target_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_path</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">req</span><span class="o">.</span><span class="n">get_file_from_url</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">],</span> <span class="n">target_file</span><span class="p">)</span>

        <span class="n">python_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_python_version</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>

        <span class="c1"># Run code from conda_build.skeletons in ProcessPoolExecutor</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">conda_sem</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pkg_info</span><span class="p">,</span> <span class="n">depends</span> <span class="o">=</span> <span class="k">await</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">run_sp</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_requirements</span><span class="p">,</span>
                    <span class="n">package</span><span class="p">,</span> <span class="n">target_file</span><span class="p">,</span> <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">],</span>
                    <span class="p">(</span><span class="s1">&#39;sha256&#39;</span><span class="p">,</span> <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;digests&#39;</span><span class="p">][</span><span class="s1">&#39;sha256&#39;</span><span class="p">]),</span>
                    <span class="n">python_version</span><span class="p">,</span> <span class="n">build_config</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to get depends for PyPi </span><span class="si">%s</span><span class="s2"> (py=</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                            <span class="n">target_file</span><span class="p">,</span> <span class="n">python_version</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exception data&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PyPi info for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">target_file</span><span class="p">,</span> <span class="n">pkg_info</span><span class="p">)</span>

        <span class="c1"># Convert into dict</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">depends</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([^&lt;&gt;= ]+)(.*)&#39;</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">deps</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Write to rel dict for return</span>
        <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;depends&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">deps</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="n">deps</span><span class="p">}</span></div>

    <span class="n">releases_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://pypi.org/pypi/</span><span class="si">{package}</span><span class="s2">/json&quot;</span><span class="p">]</span>
    <span class="n">package_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;package&gt;[\w\-\.]+)&quot;</span>
    <span class="n">source_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{package}</span><span class="s2">[-_]</span><span class="si">{version}{ext}</span><span class="s2">&quot;</span>
    <span class="n">hoster_pattern</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?P&lt;hoster&gt;&quot;</span>
                      <span class="sa">r</span><span class="s2">&quot;files.pythonhosted.org/packages|&quot;</span>
                      <span class="sa">r</span><span class="s2">&quot;pypi.python.org/packages|&quot;</span>
                      <span class="sa">r</span><span class="s2">&quot;pypi.io/packages)&quot;</span><span class="p">)</span>
    <span class="n">url_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{hoster}</span><span class="s2">/.*/</span><span class="si">{source}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="Bioarchive"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.Bioarchive">[docs]</a><span class="k">class</span> <span class="nc">Bioarchive</span><span class="p">(</span><span class="n">JSONHoster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scans for updates to packages hosted on bioarchive.galaxyproject.org&quot;&quot;&quot;</span>
<div class="viewcode-block" id="Bioarchive.get_versions_from_json"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.Bioarchive.get_versions_from_json">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_versions_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">orig_version</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">latest</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">][</span><span class="s2">&quot;Version&quot;</span><span class="p">]</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">}</span>
            <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latest</span>
            <span class="n">link</span> <span class="o">=</span> <span class="n">replace_named_capture_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link_pattern</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[{</span>
                <span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="n">link</span><span class="p">,</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">latest</span><span class="p">,</span>
            <span class="p">}]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>

    <span class="n">releases_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://bioarchive.galaxyproject.org/api/</span><span class="si">{package}</span><span class="s2">.json&quot;</span><span class="p">]</span>
    <span class="n">package_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;package&gt;[-\w.]+)&quot;</span>
    <span class="n">url_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;bioarchive.galaxyproject.org/</span><span class="si">{package}</span><span class="s2">_</span><span class="si">{version}{ext}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="CPAN"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.CPAN">[docs]</a><span class="k">class</span> <span class="nc">CPAN</span><span class="p">(</span><span class="n">JSONHoster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scans for updates to Perl packages hosted on CPAN&quot;&quot;&quot;</span>
<div class="viewcode-block" id="CPAN.parse_deps"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.CPAN.parse_deps">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_deps</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse CPAN format dependencies&quot;&quot;&quot;</span>
        <span class="n">run_deps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">host_deps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dep</span><span class="p">[</span><span class="s1">&#39;relationship&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;requires&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">dep</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;strict&#39;</span><span class="p">,</span> <span class="s1">&#39;warnings&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">dep</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;::&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;version&#39;</span> <span class="ow">in</span> <span class="n">dep</span> <span class="ow">and</span> <span class="n">dep</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;undef&#39;</span><span class="p">):</span>
                <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;&gt;=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dep</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;perl&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;perl-&#39;</span> <span class="o">+</span> <span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="k">if</span> <span class="n">dep</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;runtime&#39;</span><span class="p">:</span>
                <span class="n">run_deps</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>
            <span class="k">elif</span> <span class="n">dep</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="s1">&#39;configure&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">):</span>
                <span class="n">host_deps</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host_deps</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="n">run_deps</span><span class="p">}</span></div>

<div class="viewcode-block" id="CPAN.get_versions_from_json"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.CPAN.get_versions_from_json">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_versions_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">orig_version</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;download_url&#39;</span><span class="p">],</span>
                <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]),</span>
                <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_deps</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;dependency&#39;</span><span class="p">])</span>
            <span class="p">}</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">version</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">orig_version</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_release_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vers</span><span class="o">=</span><span class="n">orig_version</span><span class="p">,</span>
                                                      <span class="n">dist</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">])</span>
                <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">req</span><span class="o">.</span><span class="n">get_text_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="n">data2</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data2</span><span class="p">[</span><span class="s1">&#39;hits&#39;</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[</span><span class="s1">&#39;hits&#39;</span><span class="p">][</span><span class="s1">&#39;hits&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;_source&#39;</span><span class="p">]</span>
                <span class="n">orig_vers</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;download_url&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]),</span>
                    <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_deps</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;dependency&#39;</span><span class="p">])</span>
                <span class="p">}</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orig_vers</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>

    <span class="n">package_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;package&gt;[-\w.+]+)&quot;</span>
    <span class="n">author_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;author&gt;[A-Z]+)&quot;</span>
    <span class="n">url_pattern</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(www.cpan.org|cpan.metacpan.org|search.cpan.org/CPAN)&quot;</span>
                   <span class="sa">r</span><span class="s2">&quot;/authors/id/./../</span><span class="si">{author}</span><span class="s2">/([^/]+/|)</span><span class="si">{package}</span><span class="s2">-v?</span><span class="si">{version}{ext}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">releases_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://fastapi.metacpan.org/v1/release/</span><span class="si">{package}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="n">orig_release_format</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;https://fastapi.metacpan.org/v1/release/_search&quot;</span>
                           <span class="s2">&quot;?q=distribution:</span><span class="si">{dist}</span><span class="s2">%20AND%20version:</span><span class="si">{vers}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CRAN"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.CRAN">[docs]</a><span class="k">class</span> <span class="nc">CRAN</span><span class="p">(</span><span class="n">JSONHoster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;R packages hosted on r-project.org (CRAN)&quot;&quot;&quot;</span>
<div class="viewcode-block" id="CRAN.get_versions_from_json"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.CRAN.get_versions_from_json">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_versions_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">orig_version</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;latest&quot;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span> <span class="n">orig_version</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">vers</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vers</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;versions&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">vdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;versions&#39;</span><span class="p">][</span><span class="n">vers</span><span class="p">]</span>
            <span class="n">depends</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;r-&quot;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">pkg</span> <span class="o">!=</span> <span class="s1">&#39;R&#39;</span> <span class="k">else</span> <span class="s1">&#39;r-base&#39;</span><span class="p">:</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">vdata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Depends&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                       <span class="n">vdata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Imports&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                       <span class="n">vdata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LinkingTo&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="p">}</span>
            <span class="n">version</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;link&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">vers</span><span class="p">,</span>
                <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">depends</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="n">depends</span><span class="p">},</span>
            <span class="p">}</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>

    <span class="n">package_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;package&gt;[\w.]+)&quot;</span>
    <span class="n">url_pattern</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;r-project\.org/src/contrib&quot;</span>
                   <span class="sa">r</span><span class="s2">&quot;(/Archive)?/</span><span class="si">{package}</span><span class="s2">(?(1)/</span><span class="si">{package}</span><span class="s2">|)&quot;</span>
                   <span class="sa">r</span><span class="s2">&quot;_</span><span class="si">{version}{ext}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">releases_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://crandb.r-pkg.org/</span><span class="si">{package}</span><span class="s2">/all&quot;</span><span class="p">]</span></div>


<span class="c1"># pylint: disable=abstract-method</span>
<div class="viewcode-block" id="BitBucketBase"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.BitBucketBase">[docs]</a><span class="k">class</span> <span class="nc">BitBucketBase</span><span class="p">(</span><span class="n">OrderedHTMLHoster</span><span class="p">):</span>  <span class="c1"># abstract</span>
    <span class="sd">&quot;&quot;&quot;Base class for hosting at bitbucket.org&quot;&quot;&quot;</span>
    <span class="n">account_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;account&gt;[-\w]+)&quot;</span>
    <span class="n">project_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;project&gt;[-.\w]+)&quot;</span>
    <span class="n">prefix_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;prefix&gt;[-_./\w]+?)??&quot;</span>
    <span class="n">url_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;bitbucket\.org</span><span class="si">{link}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="BitBucketTag"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.BitBucketTag">[docs]</a><span class="k">class</span> <span class="nc">BitBucketTag</span><span class="p">(</span><span class="n">BitBucketBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tag based releases hosted at bitbucket.org&quot;&quot;&quot;</span>
    <span class="n">link_pattern</span> <span class="o">=</span> <span class="s2">&quot;/</span><span class="si">{account}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/get/</span><span class="si">{prefix}{version}{ext}</span><span class="s2">&quot;</span>
    <span class="n">releases_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://bitbucket.org/</span><span class="si">{account}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/downloads/?tab=tags&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;https://bitbucket.org/</span><span class="si">{account}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/downloads/?tab=branches&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="BitBucketDownload"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.BitBucketDownload">[docs]</a><span class="k">class</span> <span class="nc">BitBucketDownload</span><span class="p">(</span><span class="n">BitBucketBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Uploaded releases hosted at bitbucket.org&quot;&quot;&quot;</span>
    <span class="n">link_pattern</span> <span class="o">=</span> <span class="s2">&quot;/</span><span class="si">{account}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/downloads/</span><span class="si">{prefix}{version}{ext}</span><span class="s2">&quot;</span>
    <span class="n">releases_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://bitbucket.org/</span><span class="si">{account}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/downloads/?tab=downloads&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="GitlabTag"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.hosters.html#bioconda_utils.hosters.GitlabTag">[docs]</a><span class="k">class</span> <span class="nc">GitlabTag</span><span class="p">(</span><span class="n">OrderedHTMLHoster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tag based releases hosted at gitlab.com&quot;&quot;&quot;</span>
    <span class="n">account_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;account&gt;[-\w]+)&quot;</span>
    <span class="n">subgroup_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;subgroup&gt;(?:/[-\w]+|))&quot;</span>
    <span class="n">project_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;project&gt;[-.\w]+)&quot;</span>
    <span class="n">link_pattern</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/</span><span class="si">{account}{subgroup}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/(repository|-/archive)/&quot;</span>
                    <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{version}</span><span class="s2">/(archive|</span><span class="si">{project}</span><span class="s2">-</span><span class="si">{version}</span><span class="s2">)</span><span class="si">{ext}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">url_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;gitlab\.com</span><span class="si">{link}</span><span class="s2">&quot;</span>
    <span class="n">releases_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://gitlab.com/</span><span class="si">{account}{subgroup}</span><span class="s2">/</span><span class="si">{project}</span><span class="s2">/tags&quot;</span><span class="p">]</span></div>


<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hosters loaded: %s&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">HosterMeta</span><span class="o">.</span><span class="n">hoster_types</span><span class="p">])</span>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2016-2020, The Bioconda Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    <div class="git-ribbon">
      <a href="https://github.com/bioconda/bioconda-utils/edit/master/bioconda_utils/hosters.py" rel="me">Edit me on GitHub</a>
    </div>
  </body>
</html>