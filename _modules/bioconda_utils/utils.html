
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>bioconda_utils.utils &#8212; Bioconda  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/font-awesome-4.7.0/css/font-awesome.min.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="https://fonts.googleapis.com/css?family=Lato|Raleway" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">

    <link rel="apple-touch-icon" sizes="57x57" href="../../_static/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../../_static/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../../_static/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../../_static/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../../_static/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../../_static/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../../_static/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../../_static/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../_static/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="../../_static/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../_static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../../_static/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../_static/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="../../_static/ms-icon-144x144.png">

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />


  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo/bioconda_monochrome_small.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../updating.html">Updating recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../updating.html#updating-recipes-for-a-pinning-change">Updating recipes for a pinning change</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linting.html">Linting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faqs.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build-system.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cb3.html">Conda build v3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer.html">Developer Docs</a></li>
</ul>

<ul>
  
  <li class="toctree-l1"><a href="https://github.com/bioconda/bioconda-recipes">Bioconda @ Github</a></li>
  
  <li class="toctree-l1"><a href="../../conda-recipe_index.html">Recipe Index</a></li>
  
  <li class="toctree-l1"><a href="https://gitter.im/bioconda/Lobby"><img alt="Gitter" src="https://img.shields.io/gitter/room/bioconda/Lobby.svg"></a></li>
  
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bioconda_utils.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Utility Functions and Classes</span>

<span class="sd">This module collects small pieces of code used throughout :py:mod:`bioconda_utils`.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">product</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">zip_longest</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">PurePath</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">multiprocessing.pool</span> <span class="k">import</span> <span class="n">ThreadPool</span>
<span class="kn">import</span> <span class="nn">queue</span>

<span class="kn">from</span> <span class="nn">conda_build</span> <span class="k">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">conda.exports</span> <span class="k">import</span> <span class="n">VersionOrder</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">jsonschema</span> <span class="k">import</span> <span class="n">validate</span>
<span class="kn">from</span> <span class="nn">distutils.version</span> <span class="k">import</span> <span class="n">LooseVersion</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">jinja2</span>
<span class="kn">from</span> <span class="nn">jinja2</span> <span class="k">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">PackageLoader</span>
<span class="kn">from</span> <span class="nn">colorlog</span> <span class="k">import</span> <span class="n">ColoredFormatter</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">tqdm</span> <span class="k">as</span> <span class="nn">_tqdm</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="kn">import</span> <span class="nn">backoff</span>
<span class="kn">from</span> <span class="nn">boltons.funcutils</span> <span class="k">import</span> <span class="n">FunctionBuilder</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="TqdmHandler"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.TqdmHandler">[docs]</a><span class="k">class</span> <span class="nc">TqdmHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tqdm aware logging StreamHandler</span>

<span class="sd">    Passes all log writes through tqdm to allow progress bars and log</span>
<span class="sd">    messages to coexist without clobbering terminal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
         <span class="c1"># initialise internal tqdm lock so that we can use tqdm.write</span>
        <span class="n">_tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">disable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<div class="viewcode-block" id="TqdmHandler.emit"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.TqdmHandler.emit">[docs]</a>    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">_tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="tqdm"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.tqdm">[docs]</a><span class="k">def</span> <span class="nf">tqdm</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper around TQDM handling disable</span>

<span class="sd">    Logging is disabled if:</span>

<span class="sd">    - ``TERM`` is set to ``dumb``</span>
<span class="sd">    - ``CIRCLECI`` is set to ``true``</span>
<span class="sd">    - the effective log level of the is lower than set via ``loglevel``</span>

<span class="sd">    Args:</span>
<span class="sd">      loglevel: logging loglevel (the number, so logging.INFO)</span>
<span class="sd">      logger: local logger (in case it has different effective log level)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">term_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span>
               <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TERM&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;dumb&quot;</span>
               <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CIRCLECI&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
    <span class="n">loglevel_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logger&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span>
                   <span class="o">&lt;=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;loglevel&#39;</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">))</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;disable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">term_ok</span> <span class="ow">and</span> <span class="n">loglevel_ok</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="ensure_list"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.ensure_list">[docs]</a><span class="k">def</span> <span class="nf">ensure_list</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wraps **obj** in a list if necessary</span>

<span class="sd">    &gt;&gt;&gt; ensure_list(&quot;one&quot;)</span>
<span class="sd">    [&quot;one&quot;]</span>
<span class="sd">    &gt;&gt;&gt; ensure_list([&quot;one&quot;, &quot;two&quot;])</span>
<span class="sd">    [&quot;one&quot;, &quot;two&quot;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">obj</span><span class="p">]</span></div>


<div class="viewcode-block" id="wraps"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.wraps">[docs]</a><span class="k">def</span> <span class="nf">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Custom wraps() function for decorators</span>

<span class="sd">    This one differs from functiools.wraps and boltons.funcutils.wraps in</span>
<span class="sd">    that it allows *adding* keyword arguments to the function signature.</span>

<span class="sd">    &gt;&gt;&gt; def decorator(func):</span>
<span class="sd">    &gt;&gt;&gt;   @wraps(func)</span>
<span class="sd">    &gt;&gt;&gt;   def wrapper(*args, extra_param=None, **kwargs):</span>
<span class="sd">    &gt;&gt;&gt;      print(&quot;Called with extra_param=%s&quot; % extra_param)</span>
<span class="sd">    &gt;&gt;&gt;      func(*args, **kwargs)</span>
<span class="sd">    &gt;&gt;&gt;   return wrapper</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; @decorator()</span>
<span class="sd">    &gt;&gt;&gt; def test(arg1, arg2, arg3=&#39;default&#39;):</span>
<span class="sd">    &gt;&gt;&gt;     pass</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; test(&#39;val1&#39;, &#39;val2&#39;, extra_param=&#39;xyz&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fb</span> <span class="o">=</span> <span class="n">FunctionBuilder</span><span class="o">.</span><span class="n">from_func</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper_wrapper</span><span class="p">(</span><span class="n">wrapper_func</span><span class="p">):</span>
        <span class="n">fb_wrapper</span> <span class="o">=</span> <span class="n">FunctionBuilder</span><span class="o">.</span><span class="n">from_func</span><span class="p">(</span><span class="n">wrapper_func</span><span class="p">)</span>
        <span class="n">fb</span><span class="o">.</span><span class="n">kwonlyargs</span> <span class="o">+=</span> <span class="n">fb_wrapper</span><span class="o">.</span><span class="n">kwonlyargs</span>
        <span class="n">fb</span><span class="o">.</span><span class="n">kwonlydefaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fb_wrapper</span><span class="o">.</span><span class="n">kwonlydefaults</span><span class="p">)</span>
        <span class="n">fb</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;return _call(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">fb</span><span class="o">.</span><span class="n">get_invocation_str</span><span class="p">()</span>
        <span class="n">execdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_call</span><span class="o">=</span><span class="n">wrapper_func</span><span class="p">,</span> <span class="n">_func</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
        <span class="n">fully_wrapped</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">execdict</span><span class="p">)</span>
        <span class="n">fully_wrapped</span><span class="o">.</span><span class="n">__wrapped__</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">fully_wrapped</span>

    <span class="k">return</span> <span class="n">wrapper_wrapper</span></div>


<div class="viewcode-block" id="LogFuncFilter"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.LogFuncFilter">[docs]</a><span class="k">class</span> <span class="nc">LogFuncFilter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Logging filter capping the number of messages emitted from given function</span>

<span class="sd">    Arguments:</span>
<span class="sd">      func: The function for which to filter log messages</span>
<span class="sd">      trunc_msg: The message to emit when logging is truncated, to inform user that</span>
<span class="sd">                 messages will from now on be hidden.</span>
<span class="sd">      max_lines: Max number of log messages to allow to pass</span>
<span class="sd">      consectuctive: If try, filter applies to consectutive messages and resets</span>
<span class="sd">                     if a message from a different source is encountered.</span>

<span class="sd">    Fixme:</span>
<span class="sd">      The implementation  assumes that **func** uses a logger initialized with</span>
<span class="sd">      ``getLogger(__name__)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">trunc_msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_lines</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">consecutive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_lines</span> <span class="o">=</span> <span class="n">max_lines</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_max_lines</span> <span class="o">=</span> <span class="n">max_lines</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consecutive</span> <span class="o">=</span> <span class="n">consecutive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trunc_msg</span> <span class="o">=</span> <span class="n">trunc_msg</span>

<div class="viewcode-block" id="LogFuncFilter.filter"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.LogFuncFilter.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">LogRecord</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__module__</span> <span class="ow">and</span> <span class="n">record</span><span class="o">.</span><span class="n">funcName</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_max_lines</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur_max_lines</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_max_lines</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">trunc_msg</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur_max_lines</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">record</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trunc_msg</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">consecutive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur_max_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_lines</span>
        <span class="k">return</span> <span class="kc">True</span></div></div>

<div class="viewcode-block" id="setup_logger"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.setup_logger">[docs]</a><span class="k">def</span> <span class="nf">setup_logger</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">loglevel</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                 <span class="n">logfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">logfile_level</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                 <span class="n">log_command_max_lines</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;BIOCONDA &quot;</span><span class="p">,</span>
                 <span class="n">msgfmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2">&quot;</span>
                                <span class="s2">&quot;</span><span class="si">%(log_color)s{prefix}%(levelname)s%(reset)s</span><span class="s2"> &quot;</span>
                                <span class="s2">&quot;</span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">),</span>
                 <span class="n">datefmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s2">&quot;%H:%M:%S &quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Set up logging for bioconda-utils</span>

<span class="sd">    Args:</span>
<span class="sd">      name: Module name for which to get a logger (``__name__``)</span>
<span class="sd">      loglevel: Log level, can be name or int level</span>
<span class="sd">      logfile: File to log to as well</span>
<span class="sd">      logfile_level: Log level for file logging</span>
<span class="sd">      prefix: Prefix to add to our log messages</span>
<span class="sd">      msgfmt: Format for messages</span>
<span class="sd">      datefmt: Format for dates</span>

<span class="sd">    Returns:</span>
<span class="sd">      A new logger</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">logfile</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logfile_level</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">logfile_level</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">logfile_level</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="n">log_file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
        <span class="n">log_file_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logfile_level</span><span class="p">)</span>
        <span class="n">log_file_formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
            <span class="n">msgfmt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(log_color)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(reset)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">),</span>
            <span class="n">datefmt</span><span class="o">=</span><span class="n">datefmt</span>
        <span class="p">)</span>
        <span class="n">log_file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">log_file_formatter</span><span class="p">)</span>
        <span class="n">new_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_file_handler</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logfile_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FATAL</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">loglevel</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

    <span class="c1"># Base logger is set to the lowest of console or file logging</span>
    <span class="n">new_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="n">logfile_level</span><span class="p">))</span>

    <span class="n">new_logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Console logging is passed through TqdmHandler so that the progress bar does not</span>
    <span class="c1"># get broken by log lines emitted.</span>
    <span class="n">log_stream_handler</span> <span class="o">=</span> <span class="n">TqdmHandler</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">loglevel</span><span class="p">:</span>
        <span class="n">log_stream_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">loglevel</span><span class="p">)</span>

    <span class="n">log_stream_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">ColoredFormatter</span><span class="p">(</span>
        <span class="n">msgfmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">),</span>
        <span class="n">datefmt</span><span class="o">=</span><span class="n">datefmt</span><span class="p">,</span>
        <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">log_colors</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;DEBUG&#39;</span><span class="p">:</span> <span class="s1">&#39;cyan&#39;</span><span class="p">,</span>
            <span class="s1">&#39;INFO&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span>
            <span class="s1">&#39;WARNING&#39;</span><span class="p">:</span> <span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ERROR&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
            <span class="s1">&#39;CRITICAL&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
        <span class="p">}))</span>
    <span class="n">new_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_stream_handler</span><span class="p">)</span>

    <span class="c1"># Add filter for `utils.run` to truncate after n lines emitted.</span>
    <span class="c1"># We do this here rather than in `utils.run` so that it can be configured</span>
    <span class="c1"># from the CLI more easily</span>
    <span class="k">if</span> <span class="n">log_command_max_lines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_filter</span> <span class="o">=</span> <span class="n">LogFuncFilter</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="s2">&quot;Command output truncated&quot;</span><span class="p">,</span> <span class="n">log_command_max_lines</span><span class="p">)</span>
        <span class="n">log_stream_handler</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">log_filter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_logger</span></div>


<div class="viewcode-block" id="JinjaSilentUndefined"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.JinjaSilentUndefined">[docs]</a><span class="k">class</span> <span class="nc">JinjaSilentUndefined</span><span class="p">(</span><span class="n">jinja2</span><span class="o">.</span><span class="n">Undefined</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_fail_with_undefined_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="fm">__add__</span> <span class="o">=</span> <span class="fm">__radd__</span> <span class="o">=</span> <span class="fm">__mul__</span> <span class="o">=</span> <span class="fm">__rmul__</span> <span class="o">=</span> <span class="n">__div__</span> <span class="o">=</span> <span class="n">__rdiv__</span> <span class="o">=</span> \
        <span class="fm">__truediv__</span> <span class="o">=</span> <span class="fm">__rtruediv__</span> <span class="o">=</span> <span class="fm">__floordiv__</span> <span class="o">=</span> <span class="fm">__rfloordiv__</span> <span class="o">=</span> \
        <span class="fm">__mod__</span> <span class="o">=</span> <span class="fm">__rmod__</span> <span class="o">=</span> <span class="fm">__pos__</span> <span class="o">=</span> <span class="fm">__neg__</span> <span class="o">=</span> <span class="fm">__call__</span> <span class="o">=</span> \
        <span class="fm">__getitem__</span> <span class="o">=</span> <span class="fm">__lt__</span> <span class="o">=</span> <span class="fm">__le__</span> <span class="o">=</span> <span class="fm">__gt__</span> <span class="o">=</span> <span class="fm">__ge__</span> <span class="o">=</span> <span class="fm">__int__</span> <span class="o">=</span> \
        <span class="fm">__float__</span> <span class="o">=</span> <span class="fm">__complex__</span> <span class="o">=</span> <span class="fm">__pow__</span> <span class="o">=</span> <span class="fm">__rpow__</span> <span class="o">=</span> \
        <span class="n">_fail_with_undefined_error</span></div>


<span class="n">jinja</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
    <span class="n">loader</span><span class="o">=</span><span class="n">PackageLoader</span><span class="p">(</span><span class="s1">&#39;bioconda_utils&#39;</span><span class="p">,</span> <span class="s1">&#39;templates&#39;</span><span class="p">),</span>
    <span class="n">trim_blocks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">lstrip_blocks</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>


<span class="n">jinja_silent_undef</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
    <span class="n">undefined</span><span class="o">=</span><span class="n">JinjaSilentUndefined</span>
<span class="p">)</span>


<span class="c1"># Patterns of allowed environment variables that are allowed to be passed to</span>
<span class="c1"># conda-build.</span>
<span class="n">ENV_VAR_WHITELIST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;PATH&#39;</span><span class="p">,</span>
    <span class="s1">&#39;LC_*&#39;</span><span class="p">,</span>
    <span class="s1">&#39;LANG&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MACOSX_DEPLOYMENT_TARGET&#39;</span><span class="p">,</span>
    <span class="s1">&#39;HTTPS_PROXY&#39;</span><span class="p">,</span><span class="s1">&#39;HTTP_PROXY&#39;</span><span class="p">,</span> <span class="s1">&#39;https_proxy&#39;</span><span class="p">,</span> <span class="s1">&#39;http_proxy&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Of those that make it through the whitelist, remove these specific ones</span>
<span class="n">ENV_VAR_BLACKLIST</span> <span class="o">=</span> <span class="p">[</span>
<span class="p">]</span>

<span class="c1"># Of those, also remove these when we&#39;re running in a docker container</span>
<span class="n">ENV_VAR_DOCKER_BLACKLIST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;PATH&#39;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="get_free_space"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.get_free_space">[docs]</a><span class="k">def</span> <span class="nf">get_free_space</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return free space in MB on disk&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">statvfs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">f_frsize</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="n">f_bavail</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="allowed_env_var"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.allowed_env_var">[docs]</a><span class="k">def</span> <span class="nf">allowed_env_var</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">docker</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">ENV_VAR_WHITELIST</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">bpattern</span> <span class="ow">in</span> <span class="n">ENV_VAR_BLACKLIST</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">bpattern</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">docker</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dpattern</span> <span class="ow">in</span> <span class="n">ENV_VAR_DOCKER_BLACKLIST</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dpattern</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="bin_for"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.bin_for">[docs]</a><span class="k">def</span> <span class="nf">bin_for</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;conda&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;CONDA_ROOT&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CONDA_ROOT&#39;</span><span class="p">],</span> <span class="s1">&#39;bin&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span></div>


<div class="viewcode-block" id="temp_env"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.temp_env">[docs]</a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">temp_env</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager to temporarily set os.environ.</span>

<span class="sd">    Used to send values in **env** to processes that only read the os.environ,</span>
<span class="sd">    for example when filling in meta.yaml with jinja2 template variables.</span>

<span class="sd">    All values are converted to string before sending to os.environ</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">_env</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_env</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span></div>


<div class="viewcode-block" id="sandboxed_env"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.sandboxed_env">[docs]</a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">sandboxed_env</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager to temporarily set os.environ, only allowing env vars from</span>
<span class="sd">    the existing `os.environ` or the provided **env** that match</span>
<span class="sd">    ENV_VAR_WHITELIST globs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">_env</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">orig</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">allowed_env_var</span><span class="p">(</span><span class="n">k</span><span class="p">)}</span>
    <span class="n">_env</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">allowed_env_var</span><span class="p">(</span><span class="n">k</span><span class="p">)})</span>

    <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="n">_env</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_all_meta"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.load_all_meta">[docs]</a><span class="k">def</span> <span class="nf">load_all_meta</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each environment, yield the rendered meta.yaml.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    finalize : bool</span>
<span class="sd">        If True, do a full conda-build render. Determines exact package builds</span>
<span class="sd">        of build/host dependencies. It involves costly dependency resolution</span>
<span class="sd">        via conda and also download of those packages (to inspect possible</span>
<span class="sd">        run_exports). For fast-running tasks like linting, set to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_conda_build_config</span><span class="p">()</span>
    <span class="c1"># `bypass_env_check=True` prevents evaluating (=environment solving) the</span>
    <span class="c1"># package versions used for `pin_compatible` and the like.</span>
    <span class="c1"># To avoid adding a separate `bypass_env_check` alongside every `finalize`</span>
    <span class="c1"># parameter, just assume we always want to bypass if `finalize is True`.</span>
    <span class="n">bypass_env_check</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">finalize</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">meta</span> <span class="k">for</span> <span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">api</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span>
                                                <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                                                <span class="n">finalize</span><span class="o">=</span><span class="n">finalize</span><span class="p">,</span>
                                                <span class="n">bypass_env_check</span><span class="o">=</span><span class="n">bypass_env_check</span><span class="p">,</span>
                                                <span class="p">)]</span></div>



<div class="viewcode-block" id="load_meta_fast"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.load_meta_fast">[docs]</a><span class="k">def</span> <span class="nf">load_meta_fast</span><span class="p">(</span><span class="n">recipe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a package name, find the current meta.yaml file, parse it, and return</span>
<span class="sd">    the dict.</span>

<span class="sd">    Args:</span>
<span class="sd">      recipe: Path to recipe (directory containing the meta.yaml file)</span>
<span class="sd">      env: Optional variables to expand</span>

<span class="sd">    Returns:</span>
<span class="sd">      Tuple of original recipe string and rendered dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="s1">&#39;meta.yaml&#39;</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">jinja_silent_undef</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">pth</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">env</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">recipe</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Problem inspecting </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recipe</span><span class="p">))</span></div>


<div class="viewcode-block" id="load_conda_build_config"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.load_conda_build_config">[docs]</a><span class="k">def</span> <span class="nf">load_conda_build_config</span><span class="p">(</span><span class="n">platform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trim_skip</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load conda build config while considering global pinnings from conda-forge.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span>
        <span class="n">no_download_source</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">set_build_id</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># get environment root</span>
    <span class="n">env_root</span> <span class="o">=</span> <span class="n">PurePath</span><span class="p">(</span><span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;bioconda-utils&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># set path to pinnings from conda forge package</span>
    <span class="n">config</span><span class="o">.</span><span class="n">exclusive_config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env_root</span><span class="p">,</span>
                                                <span class="s2">&quot;conda_build_config.yaml&quot;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">variant_config_files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
            <span class="s1">&#39;bioconda_utils-conda_build_config.yaml&#39;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">variant_config_files</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfg</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;error: </span><span class="si">{0}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">exclusive_config_file</span><span class="p">),</span> <span class="p">(</span>
        <span class="s2">&quot;error: conda_build_config.yaml not found in environment root&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">platform</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span>
    <span class="n">config</span><span class="o">.</span><span class="n">trim_skip</span> <span class="o">=</span> <span class="n">trim_skip</span>
    <span class="k">return</span> <span class="n">config</span></div>


<span class="n">CondaBuildConfigFile</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;CondaBuildConfigFile&#39;</span><span class="p">,</span> <span class="p">(</span>
    <span class="s1">&#39;arg&#39;</span><span class="p">,</span>  <span class="c1"># either &#39;-e&#39; or &#39;-m&#39;</span>
    <span class="s1">&#39;path&#39;</span><span class="p">,</span>
<span class="p">))</span>


<div class="viewcode-block" id="get_conda_build_config_files"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.get_conda_build_config_files">[docs]</a><span class="k">def</span> <span class="nf">get_conda_build_config_files</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_conda_build_config</span><span class="p">()</span>
    <span class="c1"># TODO: open PR upstream for conda-build to support multiple exclusive_config_files</span>
    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="p">([</span><span class="n">config</span><span class="o">.</span><span class="n">exclusive_config_file</span><span class="p">]</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">exclusive_config_file</span> <span class="k">else</span> <span class="p">[]):</span>
        <span class="k">yield</span> <span class="n">CondaBuildConfigFile</span><span class="p">(</span><span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">variant_config_files</span> <span class="ow">or</span> <span class="p">[]):</span>
        <span class="k">yield</span> <span class="n">CondaBuildConfigFile</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_first_metadata"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.load_first_metadata">[docs]</a><span class="k">def</span> <span class="nf">load_first_metadata</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns just the first of possibly many metadata files. Used for when you</span>
<span class="sd">    need to do things like check a package name or version number (which are</span>
<span class="sd">    not expected to change between variants).</span>

<span class="sd">    If the recipe will be skipped, then returns None</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    finalize : bool</span>
<span class="sd">        If True, do a full conda-build render. Determines exact package builds</span>
<span class="sd">        of build/host dependencies. It involves costly dependency resolution</span>
<span class="sd">        via conda and also download of those packages (to inspect possible</span>
<span class="sd">        run_exports). For fast-running tasks like linting, set to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metas</span> <span class="o">=</span> <span class="n">load_all_meta</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="n">finalize</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">metas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="temp_os"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.temp_os">[docs]</a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">temp_os</span><span class="p">(</span><span class="n">platform</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager to temporarily set sys.platform.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">original</span></div>


<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">cmds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">live</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">mylogger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="n">loglevel</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">sp</span><span class="o">.</span><span class="n">CompletedProcess</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a command (with logging, masking, etc)</span>

<span class="sd">    - Explicitly decodes stdout to avoid UnicodeDecodeErrors that can occur when</span>
<span class="sd">      using the ``universal_newlines=True`` argument in the standard</span>
<span class="sd">      subprocess.run.</span>
<span class="sd">    - Masks secrets</span>
<span class="sd">    - Passed live output to `logging`</span>

<span class="sd">    Arguments:</span>
<span class="sd">      cmd: List of command and arguments</span>
<span class="sd">      env: Optional environment for command</span>
<span class="sd">      mask: List of terms to mask (secrets)</span>
<span class="sd">      live: Whether output should be sent to log</span>
<span class="sd">      kwargs: Additional arguments to `subprocess.Popen`</span>

<span class="sd">    Returns:</span>
<span class="sd">      CompletedProcess object</span>

<span class="sd">    Raises:</span>
<span class="sd">      subprocess.CalledProcessError if the process failed</span>
<span class="sd">      FileNotFoundError if the command could not be found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logq</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pushqueue</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">pipe</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads from a pipe and pushes into a queue, pushing &quot;None&quot; to</span>
<span class="sd">        indicate closed pipe&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">readline</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">pipe</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># End-of-data-token</span>

    <span class="k">def</span> <span class="nf">do_mask</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Masks secrets in **arg**&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># caller has not considered masking, hide the entire command</span>
            <span class="c1"># for security reasons</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;hidden&gt;&#39;</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># masking has been deactivated</span>
            <span class="k">return</span> <span class="n">arg</span>
        <span class="k">for</span> <span class="n">mitem</span> <span class="ow">in</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">mitem</span><span class="p">,</span> <span class="s1">&#39;&lt;hidden&gt;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arg</span>

    <span class="c1"># bufsize=4 result of manual experimentation. Changing it can</span>
    <span class="c1"># drop performance drastically.</span>
    <span class="k">with</span> <span class="n">sp</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                  <span class="n">close_fds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>
        <span class="c1"># Start threads reading stdout/stderr and pushing it into queue q</span>
        <span class="n">out_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">pushqueue</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">logq</span><span class="p">,</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">))</span>
        <span class="n">err_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">pushqueue</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">logq</span><span class="p">,</span> <span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="p">))</span>
        <span class="n">out_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Do not wait for these threads to terminate</span>
        <span class="n">err_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">out_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">err_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">output_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># Run until we&#39;ve got both `None` tokens</span>
                <span class="k">for</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">logq</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">do_mask</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                    <span class="n">output_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">live</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pipe</span> <span class="o">==</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;OUT&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;ERR&quot;</span>
                        <span class="n">mylogger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">) </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="k">raise</span>

        <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_lines</span><span class="p">)</span>
        <span class="n">returncode</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">masked_cmds</span> <span class="o">=</span> <span class="n">do_mask</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">masked_cmds</span> <span class="o">=</span> <span class="p">[</span><span class="n">do_mask</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">returncode</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;COMMAND FAILED: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">masked_cmds</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">live</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;STDOUT+STDERR:</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">sp</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">(</span><span class="n">returncode</span><span class="p">,</span> <span class="n">masked_cmds</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">CompletedProcess</span><span class="p">(</span><span class="n">returncode</span><span class="p">,</span> <span class="n">masked_cmds</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span></div>


<div class="viewcode-block" id="envstr"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.envstr">[docs]</a><span class="k">def</span> <span class="nf">envstr</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="n">env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;=&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span></div>


<div class="viewcode-block" id="flatten_dict"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.flatten_dict">[docs]</a><span class="k">def</span> <span class="nf">flatten_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>
        <span class="k">yield</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span></div>


<div class="viewcode-block" id="EnvMatrix"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.EnvMatrix">[docs]</a><span class="k">class</span> <span class="nc">EnvMatrix</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Intended to be initialized with a YAML file and iterated over to yield all</span>
<span class="sd">    combinations of environments.</span>

<span class="sd">    YAML file has the following format::</span>

<span class="sd">        CONDA_PY:</span>
<span class="sd">          - &quot;2.7&quot;</span>
<span class="sd">          - &quot;3.5&quot;</span>
<span class="sd">        CONDA_BOOST: &quot;1.60&quot;</span>
<span class="sd">        CONDA_PERL: &quot;5.22.0&quot;</span>
<span class="sd">        CONDA_NPY: &quot;110&quot;</span>
<span class="sd">        CONDA_NCURSES: &quot;5.9&quot;</span>
<span class="sd">        CONDA_GSL: &quot;1.16&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        env : str or dict</span>
<span class="sd">            If str, assume it&#39;s a path to a YAML-format filename and load it</span>
<span class="sd">            into a dict. If a dict is provided, use it directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;CONDA_PY&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;All versions except CONDA_PY must be strings.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given the YAML::</span>

<span class="sd">            CONDA_PY:</span>
<span class="sd">              - &quot;2.7&quot;</span>
<span class="sd">              - &quot;3.5&quot;</span>
<span class="sd">            CONDA_BOOST: &quot;1.60&quot;</span>
<span class="sd">            CONDA_NPY: &quot;110&quot;</span>

<span class="sd">        We get the following sets of env vars::</span>

<span class="sd">          [(&#39;CONDA_BOOST&#39;, &#39;1.60&#39;), (&#39;CONDA_PY&#39;, &#39;2.7&#39;), (&#39;CONDA_NPY&#39;, &#39;110&#39;)]</span>
<span class="sd">          [(&#39;CONDA_BOOST&#39;, &#39;1.60&#39;), (&#39;CONDA_PY&#39;, &#39;3.5&#39;), (&#39;CONDA_NPY&#39;, &#39;110&#39;)]</span>

<span class="sd">        A copy of the entire os.environ dict is updated and yielded for each of</span>
<span class="sd">        these sets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">flatten_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">env</span></div>


<div class="viewcode-block" id="get_deps"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.get_deps">[docs]</a><span class="k">def</span> <span class="nf">get_deps</span><span class="p">(</span><span class="n">recipe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator of dependencies for a single recipe</span>

<span class="sd">    Only names (not versions) of dependencies are yielded.</span>

<span class="sd">    If the variant/version matrix yields multiple instances of the metadata,</span>
<span class="sd">    the union of these dependencies is returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    recipe : str or MetaData</span>
<span class="sd">        If string, it is a path to the recipe; otherwise assume it is a parsed</span>
<span class="sd">        conda_build.metadata.MetaData instance.</span>

<span class="sd">    build : bool</span>
<span class="sd">        If True yield build dependencies, if False yield run dependencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">recipe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">load_all_meta</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either meta or recipe has to be specified.&quot;</span><span class="p">)</span>

    <span class="n">all_deps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">build</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;requirements/build&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;requirements/run&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">all_deps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_deps</span></div>


<span class="n">_max_threads</span> <span class="o">=</span> <span class="mi">1</span>


<div class="viewcode-block" id="set_max_threads"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.set_max_threads">[docs]</a><span class="k">def</span> <span class="nf">set_max_threads</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_max_threads</span>
    <span class="n">_max_threads</span> <span class="o">=</span> <span class="n">n</span></div>


<div class="viewcode-block" id="threads_to_use"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.threads_to_use">[docs]</a><span class="k">def</span> <span class="nf">threads_to_use</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns the number of cores we are allowed to run on&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">&#39;sched_getaffinity&#39;</span><span class="p">):</span>
        <span class="n">cores</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sched_getaffinity</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cores</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">_max_threads</span><span class="p">,</span> <span class="n">cores</span><span class="p">)</span></div>


<div class="viewcode-block" id="parallel_iter"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.parallel_iter">[docs]</a><span class="k">def</span> <span class="nf">parallel_iter</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">pfunc</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">threads_to_use</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">pfunc</span><span class="p">,</span> <span class="n">items</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="p">)</span></div>




<div class="viewcode-block" id="get_recipes"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.get_recipes">[docs]</a><span class="k">def</span> <span class="nf">get_recipes</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator of recipes.</span>

<span class="sd">    Finds (possibly nested) directories containing a ``meta.yaml`` file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    recipe_folder : str</span>
<span class="sd">        Top-level dir of the recipes</span>

<span class="sd">    package : str or iterable</span>
<span class="sd">        Pattern or patterns to restrict the results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">package</span> <span class="o">=</span> <span class="p">[</span><span class="n">package</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="n">exclude</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">package</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;get_recipes(</span><span class="si">%s</span><span class="s2">, package=&#39;</span><span class="si">%s</span><span class="s2">&#39;): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">new_dir</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dir_path</span><span class="p">,</span> <span class="n">dir_names</span><span class="p">,</span> <span class="n">file_names</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">new_dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">dir_path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">):],</span> <span class="n">pat</span><span class="p">)</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="s2">&quot;meta.yaml&quot;</span> <span class="ow">in</span> <span class="n">file_names</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">dir_path</span></div>


<div class="viewcode-block" id="get_latest_recipes"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.get_latest_recipes">[docs]</a><span class="k">def</span> <span class="nf">get_latest_recipes</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator of recipes.</span>

<span class="sd">    Finds (possibly nested) directories containing a ``meta.yaml`` file and returns</span>
<span class="sd">    the latest version of each recipe.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    recipe_folder : str</span>
<span class="sd">        Top-level dir of the recipes</span>

<span class="sd">    config : dict or filename</span>

<span class="sd">    package : str or iterable</span>
<span class="sd">        Pattern or patterns to restrict the results.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">toplevel</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">recipe_folder</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">recipes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">get_recipes</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">package</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">toplevel</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">package</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">recipes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">toplevel</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">get_version</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="n">meta_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;meta.yaml&#39;</span><span class="p">)</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">load_first_metadata</span><span class="p">(</span><span class="n">meta_path</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">version</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;package/version&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">VersionOrder</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
            <span class="n">sorted_versions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">get_version</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sorted_versions</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">sorted_versions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="DivergentBuildsError"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.DivergentBuildsError">[docs]</a><span class="k">class</span> <span class="nc">DivergentBuildsError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<span class="k">def</span> <span class="nf">_string_or_float_to_integer_python</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    conda-build 2.0.4 expects CONDA_PY values to be integers (e.g., 27, 35) but</span>
<span class="sd">    older versions were OK with strings or even floats.</span>

<span class="sd">    To avoid editing existing config files, we support those values here.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># it&#39;ll be a looong time before we hit Python 10.0</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is an unrecognized Python version&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">s</span>


<div class="viewcode-block" id="built_package_paths"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.built_package_paths">[docs]</a><span class="k">def</span> <span class="nf">built_package_paths</span><span class="p">(</span><span class="n">recipe</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the path to which a recipe would be built.</span>

<span class="sd">    Does not necessarily exist; equivalent to ``conda build --output recipename``</span>
<span class="sd">    but without the subprocess.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">load_conda_build_config</span><span class="p">()</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_output_file_paths</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">paths</span></div>


<div class="viewcode-block" id="last_commit_to_master"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.last_commit_to_master">[docs]</a><span class="k">def</span> <span class="nf">last_commit_to_master</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identifies the day of the last commit to master branch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s1">&#39;git&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;git not found&quot;</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="s1">&#39;git log master --date=iso | grep &quot;^Date:&quot; | head -n1&#39;</span><span class="p">,</span>
        <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">date</span></div>


<div class="viewcode-block" id="file_from_commit"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.file_from_commit">[docs]</a><span class="k">def</span> <span class="nf">file_from_commit</span><span class="p">(</span><span class="n">commit</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the contents of a file at a particular commit as a string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    commit : commit-like string</span>

<span class="sd">    filename : str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">commit</span> <span class="o">==</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">run</span><span class="p">([</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">commit</span><span class="p">,</span> <span class="n">filename</span><span class="p">)],</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span></div>


<div class="viewcode-block" id="newly_unblacklisted"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.newly_unblacklisted">[docs]</a><span class="k">def</span> <span class="nf">newly_unblacklisted</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">git_range</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the set of recipes that were blacklisted in master branch but have</span>
<span class="sd">    since been removed from the blacklist. Considers the contents of all</span>
<span class="sd">    blacklists in the current config file and all blacklists in the same config</span>
<span class="sd">    file in master branch.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    config_file : str</span>
<span class="sd">        Needs filename (and not dict) because we check what the contents of the</span>
<span class="sd">        config file were in the master branch.</span>

<span class="sd">    recipe_folder : str</span>
<span class="sd">        Path to recipe dir, needed by get_blacklist</span>

<span class="sd">    git_range : str or list</span>
<span class="sd">        If str or single-item list. If ``&#39;HEAD&#39;`` or ``[&#39;HEAD&#39;]`` or ``[&#39;master&#39;,</span>
<span class="sd">        &#39;HEAD&#39;]``, compares the current changes to master. If other commits are</span>
<span class="sd">        specified, then use those commits directly via ``git show``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># &#39;HEAD&#39; becomes [&#39;HEAD&#39;] and then [&#39;master&#39;, &#39;HEAD&#39;].</span>
    <span class="c1"># [&#39;HEAD&#39;] becomes [&#39;master&#39;, &#39;HEAD&#39;]</span>
    <span class="c1"># [&#39;HEAD~~&#39;, &#39;HEAD&#39;] stays the same</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">git_range</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">git_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">git_range</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">git_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">git_range</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;master&#39;</span><span class="p">,</span> <span class="n">git_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="c1"># Get the set of previously blacklisted recipes by reading the original</span>
    <span class="c1"># config file and then all the original blacklists it had listed</span>
    <span class="n">previous</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">orig_config</span> <span class="o">=</span> <span class="n">file_from_commit</span><span class="p">(</span><span class="n">git_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">config_file</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">bl</span> <span class="ow">in</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">orig_config</span><span class="p">)[</span><span class="s1">&#39;blacklists&#39;</span><span class="p">]:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;.tmp.blacklist&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_from_commit</span><span class="p">(</span><span class="n">git_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bl</span><span class="p">))</span>
        <span class="n">previous</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_blacklist</span><span class="p">([</span><span class="s1">&#39;.tmp.blacklist&#39;</span><span class="p">],</span> <span class="n">recipe_folder</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="s1">&#39;.tmp.blacklist&#39;</span><span class="p">)</span>

    <span class="n">current</span> <span class="o">=</span> <span class="n">get_blacklist</span><span class="p">(</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span>
            <span class="n">file_from_commit</span><span class="p">(</span><span class="n">git_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">config_file</span><span class="p">))[</span><span class="s1">&#39;blacklists&#39;</span><span class="p">],</span>
        <span class="n">recipe_folder</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Recipes newly unblacklisted:</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="changed_since_master"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.changed_since_master">[docs]</a><span class="k">def</span> <span class="nf">changed_since_master</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return filenames changed since master branch.</span>

<span class="sd">    Note that this uses ``origin``, so if you are working on a fork of the main</span>
<span class="sd">    repo and have added the main repo as ``upstream``, then you&#39;ll have to do</span>
<span class="sd">    a ``git checkout master &amp;&amp; git pull upstream master`` to update your fork.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">run</span><span class="p">([</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;master&#39;</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">run</span><span class="p">([</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="s1">&#39;FETCH_HEAD&#39;</span><span class="p">,</span> <span class="s1">&#39;--name-only&#39;</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="p">]</span></div>


<span class="k">def</span> <span class="nf">_load_platform_metas</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># check if package is noarch, if so, build only on linux</span>
    <span class="c1"># with temp_os, we can fool the MetaData if needed.</span>
    <span class="n">platform</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OSTYPE&#39;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;darwin&quot;</span><span class="p">):</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="s1">&#39;osx&#39;</span>
    <span class="k">elif</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;linux-gnu&quot;</span><span class="p">:</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="s2">&quot;linux&quot;</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">load_conda_build_config</span><span class="p">(</span><span class="n">platform</span><span class="o">=</span><span class="n">platform</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">platform</span><span class="p">,</span> <span class="n">load_all_meta</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="n">finalize</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_meta_subdir</span><span class="p">(</span><span class="n">meta</span><span class="p">):</span>
    <span class="c1"># logic extracted from conda_build.variants.bldpkg_path</span>
    <span class="k">return</span> <span class="s1">&#39;noarch&#39;</span> <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">noarch</span> <span class="ow">or</span> <span class="n">meta</span><span class="o">.</span><span class="n">noarch_python</span> <span class="k">else</span> <span class="n">meta</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">host_subdir</span>



<div class="viewcode-block" id="check_recipe_skippable"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.check_recipe_skippable">[docs]</a><span class="k">def</span> <span class="nf">check_recipe_skippable</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">check_channels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return True if the same number of builds (per subdir) defined by the recipe</span>
<span class="sd">    are already in channel_packages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">platform</span><span class="p">,</span> <span class="n">metas</span> <span class="o">=</span> <span class="n">_load_platform_metas</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">packages</span> <span class="o">=</span>  <span class="nb">set</span><span class="p">(</span>
        <span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">meta</span><span class="o">.</span><span class="n">version</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">build_number</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">metas</span>
    <span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">RepoData</span><span class="p">()</span>
    <span class="n">num_existing_pkg_builds</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">build_number</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">build_number</span> <span class="ow">in</span> <span class="n">packages</span>
        <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">get_package_data</span><span class="p">(</span><span class="s2">&quot;subdir&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                                         <span class="n">build_number</span><span class="o">=</span><span class="n">build_number</span><span class="p">,</span>
                                         <span class="n">channels</span><span class="o">=</span><span class="n">check_channels</span><span class="p">,</span> <span class="n">native</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">num_existing_pkg_builds</span> <span class="o">==</span> <span class="n">Counter</span><span class="p">():</span>
        <span class="c1"># No packages with same version + build num in channels: no need to skip</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">num_new_pkg_builds</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">meta</span><span class="o">.</span><span class="n">version</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">build_number</span><span class="p">())</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_meta_subdir</span><span class="p">(</span><span class="n">meta</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">metas</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">num_new_pkg_builds</span> <span class="o">==</span> <span class="n">num_existing_pkg_builds</span></div>


<span class="k">def</span> <span class="nf">_filter_existing_packages</span><span class="p">(</span><span class="n">metas</span><span class="p">,</span> <span class="n">check_channels</span><span class="p">):</span>
    <span class="n">new_metas</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># MetaData instances of packages not yet in channel</span>
    <span class="n">existing_metas</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># MetaData instances of packages already in channel</span>
    <span class="n">divergent_builds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of Dist (i.e., name-version-build) strings</span>

    <span class="n">key_build_meta</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">metas</span><span class="p">:</span>
        <span class="n">pkg_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">meta</span><span class="o">.</span><span class="n">version</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">build_number</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">pkg_build</span> <span class="o">=</span> <span class="p">(</span><span class="n">_meta_subdir</span><span class="p">(</span><span class="n">meta</span><span class="p">),</span> <span class="n">meta</span><span class="o">.</span><span class="n">build_id</span><span class="p">())</span>
        <span class="n">key_build_meta</span><span class="p">[</span><span class="n">pkg_key</span><span class="p">][</span><span class="n">pkg_build</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">RepoData</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">pkg_key</span><span class="p">,</span> <span class="n">build_meta</span> <span class="ow">in</span> <span class="n">key_build_meta</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">existing_pkg_builds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get_package_data</span><span class="p">([</span><span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;build&#39;</span><span class="p">],</span>
                                                     <span class="n">name</span><span class="o">=</span><span class="n">pkg_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                     <span class="n">version</span><span class="o">=</span><span class="n">pkg_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                     <span class="n">build_number</span><span class="o">=</span><span class="n">pkg_key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                     <span class="n">channels</span><span class="o">=</span><span class="n">check_channels</span><span class="p">,</span>
                                                     <span class="n">native</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">pkg_build</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">build_meta</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pkg_build</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_pkg_builds</span><span class="p">:</span>
                <span class="n">new_metas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">existing_metas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">divergent_build</span> <span class="ow">in</span> <span class="p">(</span><span class="n">existing_pkg_builds</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">build_meta</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="n">divergent_builds</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">pkg_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pkg_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">divergent_build</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">new_metas</span><span class="p">,</span> <span class="n">existing_metas</span><span class="p">,</span> <span class="n">divergent_builds</span>


<div class="viewcode-block" id="get_package_paths"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.get_package_paths">[docs]</a><span class="k">def</span> <span class="nf">get_package_paths</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">check_channels</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">check_recipe_skippable</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">check_channels</span><span class="p">):</span>
            <span class="c1"># NB: If we skip early here, we don&#39;t detect possible divergent builds.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;FILTER: not building recipe </span><span class="si">%s</span><span class="s1"> because &#39;</span>
                <span class="s1">&#39;the same number of builds are in channel(s) and it is not forced.&#39;</span><span class="p">,</span>
                <span class="n">recipe</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
    <span class="n">platform</span><span class="p">,</span> <span class="n">metas</span> <span class="o">=</span> <span class="n">_load_platform_metas</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># The recipe likely defined skip: True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">metas</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># If on CI, handle noarch.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CI&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="n">first_meta</span> <span class="o">=</span> <span class="n">metas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">first_meta</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;build/noarch&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;linux&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;FILTER: only building </span><span class="si">%s</span><span class="s1"> on &#39;</span>
                             <span class="s1">&#39;linux because it defines noarch.&#39;</span><span class="p">,</span>
                             <span class="n">recipe</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

    <span class="n">new_metas</span><span class="p">,</span> <span class="n">existing_metas</span><span class="p">,</span> <span class="n">divergent_builds</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_filter_existing_packages</span><span class="p">(</span><span class="n">metas</span><span class="p">,</span> <span class="n">check_channels</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">divergent_builds</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DivergentBuildsError</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">divergent_builds</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">existing_metas</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;FILTER: not building </span><span class="si">%s</span><span class="s1"> because &#39;</span>
            <span class="s1">&#39;it is in channel(s) and it is not forced.&#39;</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">pkg_fn</span><span class="p">())</span>
    <span class="c1"># yield all pkgs that do not yet exist</span>
    <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">build_metas</span> <span class="o">=</span> <span class="n">new_metas</span> <span class="o">+</span> <span class="n">existing_metas</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">build_metas</span> <span class="o">=</span> <span class="n">new_metas</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
        <span class="n">api</span><span class="o">.</span><span class="n">get_output_file_paths</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span> <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">build_metas</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_blacklist"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.get_blacklist">[docs]</a><span class="k">def</span> <span class="nf">get_blacklist</span><span class="p">(</span><span class="n">blacklists</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">):</span>
    <span class="s2">&quot;Return list of recipes to skip from blacklists&quot;</span>
    <span class="n">blacklist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">blacklists</span><span class="p">:</span>
        <span class="n">blacklist</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">recipe_folder</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">blacklist</span></div>


<div class="viewcode-block" id="validate_config"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.validate_config">[docs]</a><span class="k">def</span> <span class="nf">validate_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate config against schema</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : str or dict</span>
<span class="sd">        If str, assume it&#39;s a path to YAML file and load it. If dict, use it</span>
<span class="sd">        directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span>
        <span class="s1">&#39;bioconda_utils&#39;</span><span class="p">,</span> <span class="s1">&#39;config.schema.yaml&#39;</span>
    <span class="p">)</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
    <span class="n">validate</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_config"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.load_config">[docs]</a><span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses config file, building paths to relevant blacklists</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to YAML config file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">validate_config</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">relpath</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">p</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">relpath</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_list</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="c1"># always return empty list, also if NoneType is defined in yaml</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="n">default_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;blacklists&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;conda-forge&#39;</span><span class="p">,</span> <span class="s1">&#39;bioconda&#39;</span><span class="p">,</span> <span class="s1">&#39;defaults&#39;</span><span class="p">],</span>
        <span class="s1">&#39;requirements&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;upload_channel&#39;</span><span class="p">:</span> <span class="s1">&#39;bioconda&#39;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="s1">&#39;blacklists&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;blacklists&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">relpath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">get_list</span><span class="p">(</span><span class="s1">&#39;blacklists&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="s1">&#39;channels&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_list</span><span class="p">(</span><span class="s1">&#39;channels&#39;</span><span class="p">)</span>

    <span class="n">default_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># register config object in RepoData</span>
    <span class="n">RepoData</span><span class="o">.</span><span class="n">register_config</span><span class="p">(</span><span class="n">default_config</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">default_config</span></div>


<div class="viewcode-block" id="BiocondaUtilsWarning"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.BiocondaUtilsWarning">[docs]</a><span class="k">class</span> <span class="nc">BiocondaUtilsWarning</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="modified_recipes"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.modified_recipes">[docs]</a><span class="k">def</span> <span class="nf">modified_recipes</span><span class="p">(</span><span class="n">git_range</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns files under the recipes dir that have been modified within the git</span>
<span class="sd">    range. Includes meta.yaml files for recipes that have been unblacklisted in</span>
<span class="sd">    the git range. Filenames are returned with the ``recipe_folder`` included.</span>

<span class="sd">    git_range : list or tuple of length 1 or 2</span>
<span class="sd">        For example, ``[&#39;00232ffe&#39;, &#39;10fab113&#39;]``, or commonly ``[&#39;master&#39;, &#39;HEAD&#39;]``</span>
<span class="sd">        or ``[&#39;master&#39;]``. If length 2, then the commits are provided to ``git diff``</span>
<span class="sd">        using the triple-dot syntax, ``commit1...commit2``. If length 1, the</span>
<span class="sd">        comparison is any changes in the working tree relative to the commit.</span>

<span class="sd">    recipe_folder : str</span>
<span class="sd">        Top-level recipes dir in which to search for meta.yaml files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orig_git_range</span> <span class="o">=</span> <span class="n">git_range</span><span class="p">[:]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">git_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">git_range</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">git_range</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">git_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">git_range</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">git_range</span> <span class="o">=</span> <span class="n">git_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Expected 1 or 2 args for git_range; got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">git_range</span><span class="p">))</span>

    <span class="n">cmds</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span>
            <span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="s1">&#39;--relative=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">),</span>
            <span class="s1">&#39;--name-only&#39;</span><span class="p">,</span>
            <span class="n">git_range</span><span class="p">,</span>
            <span class="s2">&quot;--&quot;</span>
        <span class="p">]</span> <span class="o">+</span>
        <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">modified</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># exclude recipes that were deleted in the git-range</span>
    <span class="n">existing</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">,</span> <span class="n">modified</span><span class="p">))</span>

    <span class="c1"># if the only diff is that files were deleted, we can have [&#39;recipes/&#39;], so</span>
    <span class="c1"># filter on existing *files*</span>
    <span class="n">existing</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">,</span> <span class="n">existing</span><span class="p">))</span>

    <span class="n">unblacklisted</span> <span class="o">=</span> <span class="n">newly_unblacklisted</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">orig_git_range</span><span class="p">)</span>
    <span class="n">unblacklisted</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;meta.yaml&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unblacklisted</span><span class="p">]</span>
    <span class="n">existing</span> <span class="o">+=</span> <span class="n">unblacklisted</span>

    <span class="k">return</span> <span class="n">existing</span></div>


<div class="viewcode-block" id="Progress"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.Progress">[docs]</a><span class="k">class</span> <span class="nc">Progress</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>

<div class="viewcode-block" id="Progress.progress"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.Progress.progress">[docs]</a>    <span class="k">def</span> <span class="nf">progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">60</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>


<div class="viewcode-block" id="AsyncRequests"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.AsyncRequests">[docs]</a><span class="k">class</span> <span class="nc">AsyncRequests</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Download a bunch of files in parallel</span>

<span class="sd">    This is not really a class, more a name space encapsulating a bunch of calls.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#: Identify ourselves</span>
    <span class="n">USER_AGENT</span> <span class="o">=</span> <span class="s2">&quot;bioconda/bioconda-utils&quot;</span>
    <span class="c1">#: Max connections to each server</span>
    <span class="n">CONNECTIONS_PER_HOST</span> <span class="o">=</span> <span class="mi">4</span>

<div class="viewcode-block" id="AsyncRequests.fetch"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.AsyncRequests.fetch">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">urls</span><span class="p">,</span> <span class="n">descs</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">datas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch data from URLs.</span>

<span class="sd">        This will use asyncio to manage a pool of connections at once, speeding</span>
<span class="sd">        up download as compared to iterative use of ``requests`` significantly.</span>
<span class="sd">        It will also retry on non-permanent HTTP error codes (i.e. 429, 502,</span>
<span class="sd">        503 and 504).</span>

<span class="sd">        Args:</span>
<span class="sd">          urls: List of URLS</span>
<span class="sd">          descs: Matching list of descriptions (for progress display)</span>
<span class="sd">          cb: As each download is completed, data is passed through this function.</span>
<span class="sd">              Use to e.g. offload json parsing into download loop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Running AsyncRequests.fetch from within running loop&quot;</span><span class="p">)</span>
            <span class="c1"># Workaround the fact that asyncio&#39;s loop is marked as not-reentrant</span>
            <span class="c1"># (it is apparently easy to patch, but not desired by the devs,</span>
            <span class="k">with</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">fetch</span><span class="p">,</span> <span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="n">descs</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">async_fetch</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="n">descs</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
            <span class="n">task</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">()</span></div>

<div class="viewcode-block" id="AsyncRequests.async_fetch"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.AsyncRequests.async_fetch">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">async_fetch</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">urls</span><span class="p">,</span> <span class="n">descs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">descs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">descs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">datas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">fds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">(</span><span class="n">limit_per_host</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">CONNECTIONS_PER_HOST</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span>
                <span class="n">connector</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">USER_AGENT</span><span class="p">}</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">coros</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_async_fetch_one</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fd</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">url</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="n">descs</span><span class="p">,</span> <span class="n">datas</span><span class="p">,</span> <span class="n">fds</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">coros</span><span class="p">),</span>
                      <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">coros</span><span class="p">),</span>
                      <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Downloading&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="k">await</span> <span class="n">coro</span> <span class="k">for</span> <span class="n">coro</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="nd">@staticmethod</span>
    <span class="nd">@backoff</span><span class="o">.</span><span class="n">on_exception</span><span class="p">(</span><span class="n">backoff</span><span class="o">.</span><span class="n">fibo</span><span class="p">,</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientResponseError</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                          <span class="n">giveup</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ex</span><span class="p">:</span> <span class="n">ex</span><span class="o">.</span><span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">429</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">504</span><span class="p">])</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_async_fetch_one</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">unit_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit_divisor</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
                      <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">miniters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">disable</span><span class="o">=</span><span class="n">logger</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">block</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">block</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">fd</span><span class="p">:</span>
                        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cb</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cb</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>


<div class="viewcode-block" id="RepoData"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.RepoData">[docs]</a><span class="k">class</span> <span class="nc">RepoData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Singleton providing access to package directory on anaconda cloud</span>

<span class="sd">    If the first call provides a filename as **cache** argument, the</span>
<span class="sd">    file is used to cache the directory in CSV format.</span>

<span class="sd">    Data structure:</span>

<span class="sd">    Each **channel** hosted at anaconda cloud comprises a number of</span>
<span class="sd">    **subdirs** in which the individual package files reside. The</span>
<span class="sd">    **subdirs** can be one of **noarch**, **osx-64** and **linux-64**</span>
<span class="sd">    for Bioconda. (Technically ``(noarch|(linux|osx|win)-(64|32))``</span>
<span class="sd">    appears to be the schema).</span>

<span class="sd">    For **channel/subdir** (aka **channel/platform**) combination, a</span>
<span class="sd">    **repodata.json** contains a **package** key describing each</span>
<span class="sd">    package file with at least the following information:</span>

<span class="sd">    name: Package name (lowercase, alphanumeric + dash)</span>

<span class="sd">    version: Version (no dash, PEP440)</span>

<span class="sd">    build_number: Non negative integer indicating packaging revisions</span>

<span class="sd">    build: String comprising hash of pinned dependencies and build</span>
<span class="sd">      number. Used to distinguish different builds of the same</span>
<span class="sd">      package/version combination.</span>

<span class="sd">    depends: Runtime requirements for package as list of strings. We</span>
<span class="sd">      do not currently load this.</span>

<span class="sd">    arch: Architecture key (x86_64). Not used by conda and not loaded</span>
<span class="sd">      here.</span>

<span class="sd">    platform: Platform of package (osx, linux, noarch). Optional</span>
<span class="sd">      upstream, not used by conda. We generate this from the subdir</span>
<span class="sd">      information to have it available.</span>


<span class="sd">    Repodata versions:</span>

<span class="sd">    The version is indicated by the key **repodata_version**, with</span>
<span class="sd">    absence of that key indication version 0.</span>

<span class="sd">    In version 0, the **info** key contains the **subdir**,</span>
<span class="sd">    **platform**, **arch**, **default_python_version** and</span>
<span class="sd">    **default_numpy_version** keys. In version 1 it only contains the</span>
<span class="sd">    **subdir** key.</span>

<span class="sd">    In version 1, a key **removed** was added, listing packages</span>
<span class="sd">    removed from the repository.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">REPODATA_URL</span> <span class="o">=</span> <span class="s1">&#39;https://conda.anaconda.org/</span><span class="si">{channel}</span><span class="s1">/</span><span class="si">{subdir}</span><span class="s1">/repodata.json&#39;</span>
    <span class="n">REPODATA_LABELED_URL</span> <span class="o">=</span> <span class="s1">&#39;https://conda.anaconda.org/</span><span class="si">{channel}</span><span class="s1">/label/</span><span class="si">{label}</span><span class="s1">/</span><span class="si">{subdir}</span><span class="s1">/repodata.json&#39;</span>
    <span class="n">REPODATA_DEFAULTS_URL</span> <span class="o">=</span> <span class="s1">&#39;https://repo.anaconda.com/pkgs/main/</span><span class="si">{subdir}</span><span class="s1">/repodata.json&#39;</span>

    <span class="n">_load_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="s1">&#39;build_number&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;depends&#39;</span><span class="p">]</span>

    <span class="c1">#: Columns available in internal dataframe</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">_load_columns</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">,</span> <span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;platform&#39;</span><span class="p">]</span>
    <span class="c1">#: Platforms loaded</span>
    <span class="n">platforms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="s1">&#39;osx&#39;</span><span class="p">,</span> <span class="s1">&#39;noarch&#39;</span><span class="p">]</span>
    <span class="c1"># config object</span>
    <span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">cache_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_df</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_df_ts</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: default lifetime for repodata cache</span>
    <span class="n">cache_timeout</span> <span class="o">=</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">8</span>

<div class="viewcode-block" id="RepoData.register_config"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.RepoData.register_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span></div>

    <span class="n">__instance</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes RepoData a singleton&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">RepoData</span><span class="o">.</span><span class="n">__instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">RepoData</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;bug: ensure to load config &quot;</span>
                                                 <span class="s2">&quot;before instantiating RepoData.&quot;</span><span class="p">)</span>
            <span class="n">RepoData</span><span class="o">.</span><span class="n">__instance</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RepoData</span><span class="o">.</span><span class="n">__instance</span>

<div class="viewcode-block" id="RepoData.set_cache"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.RepoData.set_cache">[docs]</a>    <span class="k">def</span> <span class="nf">set_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;RepoData cache set after first use&quot;</span><span class="p">,</span> <span class="n">BiocondaUtilsWarning</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache</span></div>

<div class="viewcode-block" id="RepoData.set_timeout"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.RepoData.set_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">set_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the timeout after which the repodata should be reloaded&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_timeout</span> <span class="o">=</span> <span class="n">timeout</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">channels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return channels to load.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal Pandas DataFrame object</span>

<span class="sd">        Try not to use this ... the point of this class is to be able to</span>
<span class="sd">        change the structure in which the data is held.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_ts</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">seconds</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_timeout</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_channel_dataframe_cached</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df_ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>

    <span class="k">def</span> <span class="nf">_make_repodata_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="s2">&quot;defaults&quot;</span><span class="p">:</span>
            <span class="c1"># caveat: this only gets defaults main, not &#39;free&#39;, &#39;r&#39; or &#39;pro&#39;</span>
            <span class="n">url_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">REPODATA_DEFAULTS_URL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">REPODATA_URL</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
                                  <span class="n">subdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">platform2subdir</span><span class="p">(</span><span class="n">platform</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">url</span>

    <span class="k">def</span> <span class="nf">_load_channel_dataframe_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="p">):</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="p">))</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
            <span class="k">if</span> <span class="n">seconds</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_timeout</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading repodata from cache </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Repodata cache file too old. Reloading&quot;</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_channel_dataframe</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_load_channel_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">repos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">platforms</span><span class="p">))</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_repodata_url</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">repos</span><span class="p">]</span>
        <span class="n">descs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">repos</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">meta_data</span><span class="p">):</span>
            <span class="n">channel</span><span class="p">,</span> <span class="n">platform</span> <span class="o">=</span> <span class="n">meta_data</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">repo</span><span class="p">[</span><span class="s1">&#39;packages&#39;</span><span class="p">],</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span>
                                        <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_columns</span><span class="p">)</span>
            <span class="c1"># Ensure that version is always a string.</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;subdir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repo</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">][</span><span class="s1">&#39;subdir&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="n">dfs</span> <span class="o">=</span> <span class="n">AsyncRequests</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="n">descs</span><span class="p">,</span> <span class="n">to_dataframe</span><span class="p">,</span> <span class="n">repos</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;channel&#39;</span><span class="p">,</span> <span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;build&#39;</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="RepoData.native_platform"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.RepoData.native_platform">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">native_platform</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;linux&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;linux&quot;</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;darwin&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;osx&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Running on unsupported platform&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RepoData.platform2subdir"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.RepoData.platform2subdir">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">platform2subdir</span><span class="p">(</span><span class="n">platform</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;linux&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;linux-64&#39;</span>
        <span class="k">elif</span> <span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;osx&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;osx-64&#39;</span>
        <span class="k">elif</span> <span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;noarch&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;noarch&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Unsupported platform: bioconda only supports linux, osx and noarch.&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="RepoData.get_versions"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.RepoData.get_versions">[docs]</a>    <span class="k">def</span> <span class="nf">get_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get versions available for package</span>

<span class="sd">        Args:</span>
<span class="sd">          name: package name</span>

<span class="sd">        Returns:</span>
<span class="sd">          Dictionary mapping version numbers to list of architectures</span>
<span class="sd">          e.g. {&#39;0.1&#39;: [&#39;linux&#39;], &#39;0.2&#39;: [&#39;linux&#39;, &#39;osx&#39;], &#39;0.3&#39;: [&#39;noarch&#39;]}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># called from doc generator</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">][[</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;platform&#39;</span><span class="p">]]</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="n">packages</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">versions</span><span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="RepoData.get_latest_versions"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.RepoData.get_latest_versions">[docs]</a>    <span class="k">def</span> <span class="nf">get_latest_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the latest version for each package in **channel**&quot;&quot;&quot;</span>
        <span class="c1"># called from pypi module</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">max_vers</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">VersionOrder</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">vers</span> <span class="o">=</span> <span class="n">packages</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">max_vers</span><span class="p">)</span></div>

<div class="viewcode-block" id="RepoData.get_package_data"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.utils.html#bioconda_utils.utils.RepoData.get_package_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_package_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">build_number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">native</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get **key** for each package in **channels**</span>

<span class="sd">        If **key** is not give, returns bool whether there are matches.</span>
<span class="sd">        If **key** is a string, returns list of strings.</span>
<span class="sd">        If **key** is a list of string, returns tuple iterator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">native</span><span class="p">:</span>
            <span class="n">platform</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;noarch&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">native_platform</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="c1"># We iteratively drill down here, starting with the (probably)</span>
        <span class="c1"># most specific columns. Filtering this way on a large data frame</span>
        <span class="c1"># is much faster than executing the comparisons for all values</span>
        <span class="c1"># every time, in particular if we are looking at a specific package.</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>         <span class="c1"># thousands of different values</span>
                <span class="p">(</span><span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="n">build</span><span class="p">),</span>       <span class="c1"># build string should vary a lot</span>
                <span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="n">version</span><span class="p">),</span>   <span class="c1"># still pretty good variety</span>
                <span class="p">(</span><span class="s1">&#39;channel&#39;</span><span class="p">,</span> <span class="n">channels</span><span class="p">),</span>  <span class="c1"># 3 values</span>
                <span class="p">(</span><span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="n">platform</span><span class="p">),</span> <span class="c1"># 3 values</span>
                <span class="p">(</span><span class="s1">&#39;build_number&#39;</span><span class="p">,</span> <span class="n">build_number</span><span class="p">),</span> <span class="c1"># most values 0</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2016-2019, The Bioconda Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    <div class="git-ribbon">
      <a href="https://github.com/bioconda/bioconda-utils/edit/master/bioconda_utils/utils.py" rel="me">Edit me on GitHub</a>
    </div>
  </body>
</html>