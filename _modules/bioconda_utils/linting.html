
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>bioconda_utils.linting &#8212; Bioconda  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/font-awesome-4.7.0/css/font-awesome.min.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="https://fonts.googleapis.com/css?family=Lato|Raleway" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">

    <link rel="apple-touch-icon" sizes="57x57" href="../../_static/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../../_static/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../../_static/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../../_static/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../../_static/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../../_static/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../../_static/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../../_static/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../_static/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="../../_static/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../_static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../../_static/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../_static/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="../../_static/ms-icon-144x144.png">

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />


  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo/bioconda_monochrome_small.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../updating.html">Updating recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../updating.html#updating-recipes-for-a-pinning-change">Updating recipes for a pinning change</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linting.html">Linting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faqs.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build-system.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cb3.html">Conda build v3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer.html">Developer Docs</a></li>
</ul>

<ul>
  
  <li class="toctree-l1"><a href="https://github.com/bioconda/bioconda-recipes">Bioconda @ Github</a></li>
  
  <li class="toctree-l1"><a href="../../conda-recipe_index.html">Recipe Index</a></li>
  
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bioconda_utils.linting</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Recipe Linter</span>

<span class="sd">QC checks (linter) for recipes, returning a TSV of issues identified.</span>

<span class="sd">The strategy here is to use simple functions that do a single check on</span>
<span class="sd">a recipe. When run on a single recipe it can be used for linting new</span>
<span class="sd">contributions; when run on all recipes it helps highlight entire classes of</span>
<span class="sd">problems to be addressed.</span>

<span class="sd">See the `lint_functions` module for these.</span>

<span class="sd">After writing the function, register it in the global ``registry`` dict,</span>
<span class="sd">``lint_functions.registry``.</span>

<span class="sd">The output is a TSV where the &quot;info&quot; column contains the dicts returned by</span>
<span class="sd">each check function, and this column is expanded into multiple extra colums.</span>
<span class="sd">While this results in a lot of NaNs, it makes it easy to drop non-interesting</span>
<span class="sd">cases with pandas, e.g.,</span>

<span class="sd">.. code:: python</span>

<span class="sd">   recipes_with_missing_tests = df.dropna(subset=[&#39;no_tests&#39;])</span>

<span class="sd">or</span>

<span class="sd">.. code:: python</span>

<span class="sd">    def not_in_bioconda(x):</span>
<span class="sd">        if not isinstance(x, set):</span>
<span class="sd">            return np.nan</span>
<span class="sd">        res = set(x).difference([&#39;bioconda&#39;])</span>
<span class="sd">        if len(res):</span>
<span class="sd">            return(res)</span>
<span class="sd">        return np.nan</span>

<span class="sd">    df[&#39;other&#39;] = df.exists_in_channel.apply(not_in_bioconda)</span>
<span class="sd">    other_channels = df[[&#39;recipe&#39;, &#39;other&#39;]].dropna()</span>


<span class="sd">TODO:</span>
<span class="sd">~~~~~</span>

<span class="sd">- check version and build number against master branch. I think there&#39;s stuff</span>
<span class="sd">  in bioconductor updating to handle this sort of thing. Also bioconda_utils</span>
<span class="sd">  has utils for checking against master branch.</span>

<span class="sd">  - if version changed, ensure build number is 0</span>
<span class="sd">  - if version unchanged, ensure build number incremented</span>

<span class="sd">- currently we don&#39;t pay attention to py27/py3. It would be nice to handle</span>
<span class="sd">  that.</span>

<span class="sd">- how to define valid licenses?</span>
<span class="sd">  (conda_build.metadata.ensure_valid_license_family is for family)</span>

<span class="sd">- gcc/llvm have their respective preprocessing selectors</span>

<span class="sd">- excessive comments (from skeletons?)</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">ruamel_yaml</span> <span class="k">as</span> <span class="nn">yaml</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">lint_functions</span>
<span class="kn">from</span> <span class="nn">.recipe</span> <span class="k">import</span> <span class="n">Recipe</span><span class="p">,</span> <span class="n">RecipeError</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>



<span class="n">usage</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Perform various checks on recipes.</span>
<span class="s2">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="select_recipes"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.linting.html#bioconda_utils.linting.select_recipes">[docs]</a><span class="k">def</span> <span class="nf">select_recipes</span><span class="p">(</span><span class="n">packages</span><span class="p">,</span> <span class="n">git_range</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">force</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">git_range</span><span class="p">:</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">modified_recipes</span><span class="p">(</span><span class="n">git_range</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">modified</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No recipe modified according to git, exiting.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Recipes with changed `meta.yaml` or `build.sh` files</span>
        <span class="n">changed_recipes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">modified</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;meta.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;build.sh&#39;</span><span class="p">]</span> <span class="ow">and</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Recipes to consider according to git: </span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">changed_recipes</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">changed_recipes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">blacklisted_recipes</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_blacklist</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;blacklists&#39;</span><span class="p">],</span> <span class="n">recipe_folder</span><span class="p">)</span>

    <span class="n">selected_recipes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_recipes</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">packages</span><span class="p">))</span>
    <span class="n">_recipes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="n">selected_recipes</span><span class="p">:</span>
        <span class="n">stripped</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stripped</span> <span class="ow">in</span> <span class="n">blacklisted_recipes</span> <span class="ow">and</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="n">changed_recipes</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is blacklisted but also has changed. Consider &#39;</span>
                           <span class="s1">&#39;removing from blacklist if you want to build it&#39;</span><span class="p">,</span> <span class="n">recipe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">_recipes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recipe</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;forced: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">recipe</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">stripped</span> <span class="ow">in</span> <span class="n">blacklisted_recipes</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;blacklisted: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">recipe</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">git_range</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">recipe</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">changed_recipes</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="n">_recipes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recipe</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">recipe</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Recipes to lint:</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_recipes</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">_recipes</span></div>


<div class="viewcode-block" id="LintArgs"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.linting.html#bioconda_utils.linting.LintArgs">[docs]</a><span class="k">class</span> <span class="nc">LintArgs</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;LintArgs&#39;</span><span class="p">,</span> <span class="p">(</span>
    <span class="s1">&#39;exclude&#39;</span><span class="p">,</span> <span class="s1">&#39;registry&#39;</span><span class="p">,</span>
<span class="p">))):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    exclude : list</span>
<span class="sd">        List of function names in ``registry`` to skip globally. When running on</span>
<span class="sd">        CI, this will be merged with anything else detected from the commit</span>
<span class="sd">        message or LINT_SKIP environment variable using the special string</span>
<span class="sd">        &quot;[skip lint &lt;function name&gt; for &lt;recipe name&gt;]&quot;. While those other</span>
<span class="sd">        mechanisms define skipping on a recipe-specific basis, this argument</span>
<span class="sd">        can be used to skip tests for all recipes. Use sparingly.</span>

<span class="sd">    registry : list or tuple</span>
<span class="sd">        List of functions to apply to each recipe. If None, defaults to</span>
<span class="sd">        `bioconda_utils.lint_functions.registry`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">registry</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exclude</span><span class="p">,</span> <span class="n">registry</span><span class="p">)</span></div>


<div class="viewcode-block" id="lint"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.linting.html#bioconda_utils.linting.lint">[docs]</a><span class="k">def</span> <span class="nf">lint</span><span class="p">(</span><span class="n">recipes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">lint_args</span><span class="p">,</span> <span class="n">basedir</span><span class="o">=</span><span class="s2">&quot;recipes&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    recipes : list</span>
<span class="sd">        List of recipes to lint</span>

<span class="sd">    lint_args : LintArgs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="n">lint_args</span><span class="o">.</span><span class="n">exclude</span>
    <span class="n">registry</span> <span class="o">=</span> <span class="n">lint_args</span><span class="o">.</span><span class="n">registry</span>

    <span class="k">if</span> <span class="n">registry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">registry</span> <span class="o">=</span> <span class="n">lint_functions</span><span class="o">.</span><span class="n">registry</span>

    <span class="n">skip_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="n">commit_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;LINT_SKIP&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="c1"># Allow overwriting of commit message</span>
        <span class="n">commit_message</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LINT_SKIP&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Obtain commit message from last commit.</span>
        <span class="n">commit_message</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;--format=%B&#39;</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">stdout</span>

    <span class="c1"># For example the following text in the commit message will skip</span>
    <span class="c1"># lint_functions.uses_setuptools for recipe argparse:</span>
    <span class="c1">#</span>
    <span class="c1"># [ lint skip uses_setuptools for argparse ]</span>

    <span class="n">skip_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;\[\s*lint skip (?P&lt;func&gt;\w+) for (?P&lt;recipe&gt;.*?)\s*\]&#39;</span><span class="p">)</span>
    <span class="n">to_skip</span> <span class="o">=</span> <span class="n">skip_re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">commit_message</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># exclude arg is used to skip test for *all* packages</span>
        <span class="n">to_skip</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">exclude</span><span class="p">,</span> <span class="n">recipes</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="n">to_skip</span><span class="p">:</span>
        <span class="n">skip_dict</span><span class="p">[</span><span class="n">recipe</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="n">hits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">recipes</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Linting: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">recipe</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">recipe_obj</span> <span class="o">=</span> <span class="n">Recipe</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="n">recipe</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RecipeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;load_recipe&#39;</span><span class="p">:</span>  <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="s1">&#39;fix&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)}</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;start_line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;end_line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
            <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;recipe&#39;</span><span class="p">:</span> <span class="n">recipe</span><span class="p">,</span>
                <span class="s1">&#39;check&#39;</span><span class="p">:</span> <span class="s1">&#39;load_recipe&#39;</span><span class="p">,</span>
                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">,</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="n">result</span>
            <span class="p">})</span>
            <span class="k">continue</span>

        <span class="c1"># Since lint functions need a parsed meta.yaml, checking for parsing</span>
        <span class="c1"># errors can&#39;t be a lint function.</span>
        <span class="c1">#</span>
        <span class="c1"># TODO: do we need a way to skip this the same way we can skip lint</span>
        <span class="c1"># functions? I can&#39;t think of a reason we&#39;d want to keep an unparseable</span>
        <span class="c1"># YAML.</span>
        <span class="n">metas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">platform</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;linux&quot;</span><span class="p">,</span> <span class="s2">&quot;osx&quot;</span><span class="p">]:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_conda_build_config</span><span class="p">(</span><span class="n">platform</span><span class="o">=</span><span class="n">platform</span><span class="p">,</span> <span class="n">trim_skip</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">metas</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">load_all_meta</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">finalize</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span>
                <span class="n">yaml</span><span class="o">.</span><span class="n">scanner</span><span class="o">.</span><span class="n">ScannerError</span><span class="p">,</span> <span class="n">yaml</span><span class="o">.</span><span class="n">constructor</span><span class="o">.</span><span class="n">ConstructorError</span><span class="p">,</span> <span class="ne">SystemExit</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;recipe&#39;</span><span class="p">:</span> <span class="n">recipe</span><span class="p">,</span>
                <span class="s1">&#39;check&#39;</span><span class="p">:</span> <span class="s1">&#39;parse_error&#39;</span><span class="p">,</span>
                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">,</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;parse_error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="s1">&#39;fix&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="s1">&#39;_exc&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
                         <span class="s1">&#39;test1&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;test2&#39;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">args</span> <span class="p">}</span>
            <span class="p">})</span>
            <span class="k">continue</span>

        <span class="c1"># skips defined in commit message</span>
        <span class="n">skip_for_this_recipe</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">skip_dict</span><span class="p">[</span><span class="n">recipe</span><span class="p">])</span>

        <span class="c1"># skips defined in meta.yaml</span>
        <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">metas</span><span class="p">:</span>
            <span class="n">persistent</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;extra/skip-lints&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">skip_for_this_recipe</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">persistent</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">registry</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="n">skip_for_this_recipe</span><span class="p">:</span>
                <span class="n">skip_sources</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;Commit message&#39;</span><span class="p">,</span> <span class="n">skip_dict</span><span class="p">[</span><span class="n">recipe</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s1">&#39;skip-lints&#39;</span><span class="p">,</span> <span class="n">persistent</span><span class="p">),</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">skips</span> <span class="ow">in</span> <span class="n">skip_sources</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skips</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> defines skip lint test </span><span class="si">%s</span><span class="s1"> for recipe </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">source</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">recipe</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">recipe_obj</span><span class="p">,</span> <span class="n">metas</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;recipe&#39;</span><span class="p">:</span> <span class="n">recipe</span><span class="p">,</span>
                     <span class="s1">&#39;check&#39;</span><span class="p">:</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                     <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">hits</span><span class="p">:</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hits</span><span class="p">)[[</span><span class="s1">&#39;recipe&#39;</span><span class="p">,</span> <span class="s1">&#39;check&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">]]</span>

        <span class="c1"># expand out the info into more columns</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">report</span><span class="p">,</span> <span class="n">info</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">report</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="markdown_report"><a class="viewcode-back" href="../../_autosummary/bioconda_utils.linting.html#bioconda_utils.linting.markdown_report">[docs]</a><span class="k">def</span> <span class="nf">markdown_report</span><span class="p">(</span><span class="n">report</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a rendered Markdown string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    report : None or pandas.DataFrame</span>
<span class="sd">        If None, linting assumed to be successful. If dataframe, it&#39;s provided</span>
<span class="sd">        to the lint failure template.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">report</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">jinja</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s2">&quot;lint_success.md&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

    <span class="k">if</span> <span class="s1">&#39;check&#39;</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
        <span class="c1"># we have the unsummarized report</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">failed_tests</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;recipe&#39;</span><span class="p">)[</span><span class="s1">&#39;check&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s1">&#39;unique&#39;</span><span class="p">)</span>
        <span class="p">))</span>

    <span class="n">tmpl</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">jinja</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s2">&quot;lint_failure.md&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2016-2019, The Bioconda Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    <div class="git-ribbon">
      <a href="https://github.com/bioconda/bioconda-utils/edit/master/bioconda_utils/linting.py" rel="me">Edit me on GitHub</a>
    </div>
  </body>
</html>