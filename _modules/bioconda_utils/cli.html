
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bioconda_utils.cli &#8212; Bioconda  documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/font-awesome-4.7.0/css/font-awesome.min.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="https://fonts.googleapis.com/css?family=Lato|Raleway" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">

    <link rel="apple-touch-icon" sizes="57x57" href="../../_static/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../../_static/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../../_static/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../../_static/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../../_static/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../../_static/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../../_static/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../../_static/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../_static/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="../../_static/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../_static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../../_static/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../_static/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="../../_static/ms-icon-144x144.png">

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />


  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo/bioconda_monochrome_small.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user/index.html">User Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributor/index.html">Contributing to Bioconda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
</ul>

<ul>
  
  <li class="toctree-l1"><a href="https://github.com/bioconda/bioconda-recipes">Bioconda @ Github</a></li>
  
  <li class="toctree-l1"><a href="../../conda-package_index.html">Package Index</a></li>
  
  <li class="toctree-l1"><a href="https://gitter.im/bioconda/Lobby"><img alt="Gitter" src="https://img.shields.io/gitter/room/bioconda/Lobby.svg"></a></li>
  
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bioconda_utils.cli</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Bioconda Utils Command Line Interface</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Workaround for spurious numpy warning message</span>
<span class="c1"># &quot;.../importlib/_bootstrap.py:219: RuntimeWarning: numpy.dtype size \</span>
<span class="c1"># changed, may indicate binary incompatibility. Expected 96, got 88&quot;</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;numpy.dtype size changed&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">argh</span>
<span class="kn">from</span> <span class="nn">argh</span> <span class="kn">import</span> <span class="n">arg</span><span class="p">,</span> <span class="n">named</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">networkx.drawing.nx_pydot</span> <span class="kn">import</span> <span class="n">write_dot</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">VERSION</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">.build</span> <span class="kn">import</span> <span class="n">build_recipes</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">docker_utils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">lint</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">bioconductor_skeleton</span> <span class="k">as</span> <span class="n">_bioconductor_skeleton</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">cran_skeleton</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">update_pinnings</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">graph</span>
<span class="kn">from</span> <span class="nn">.githandler</span> <span class="kn">import</span> <span class="n">BiocondaRepo</span><span class="p">,</span> <span class="n">install_gpg_key</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="enable_logging"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.enable_logging">[docs]</a><span class="k">def</span> <span class="nf">enable_logging</span><span class="p">(</span><span class="n">default_loglevel</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">default_file_loglevel</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds the parameter ``--loglevel`` and sets up logging</span>

<span class="sd">    Args:</span>
<span class="sd">      default_loglevel: loglevel used when --loglevel is not passed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--loglevel&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set logging level (debug, info, warning, error, critical)&quot;</span><span class="p">)</span>
        <span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--logfile&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Write log to file&quot;</span><span class="p">)</span>
        <span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--logfile-level&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Log level for log file&quot;</span><span class="p">)</span>
        <span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--log-command-max-lines&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Limit lines emitted for commands executed&quot;</span><span class="p">)</span>
        <span class="nd">@utils</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="n">default_loglevel</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">logfile_level</span><span class="o">=</span><span class="n">default_file_loglevel</span><span class="p">,</span>
                    <span class="n">log_command_max_lines</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">max_lines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">log_command_max_lines</span><span class="p">)</span> <span class="k">if</span> <span class="n">log_command_max_lines</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">setup_logger</span><span class="p">(</span><span class="s1">&#39;bioconda_utils&#39;</span><span class="p">,</span> <span class="n">loglevel</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">logfile_level</span><span class="p">,</span>
                               <span class="n">max_lines</span><span class="p">)</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="enable_debugging"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.enable_debugging">[docs]</a><span class="k">def</span> <span class="nf">enable_debugging</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Adds the paremeter ``--pdb`` (or ``-P``) to enable dropping into PDB&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;-P&#39;</span><span class="p">,</span> <span class="s1">&#39;--pdb&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Drop into debugger on exception&quot;</span><span class="p">)</span>
        <span class="nd">@utils</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">pdb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Dropping into debugger&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pdb</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">pdb</span>
                    <span class="n">pdb</span><span class="o">.</span><span class="n">post_mortem</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="enable_threads"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.enable_threads">[docs]</a><span class="k">def</span> <span class="nf">enable_threads</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Adds the parameter ``--threads`` (or ``-t``) to limit parallelism&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--threads&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Limit maximum number of processes used.&quot;</span><span class="p">)</span>
        <span class="nd">@utils</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">set_max_threads</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="recipe_folder_and_config"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.recipe_folder_and_config">[docs]</a><span class="k">def</span> <span class="nf">recipe_folder_and_config</span><span class="p">(</span><span class="n">allow_missing_for</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds optional positional arguments recipe_folder and config</span>

<span class="sd">    Requires that func has synopsis ``def x(recipe_folder, config,...)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">check_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">allow_missing</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">default</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_missing</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Argument &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; points to missing file &#39;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">args</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">lst</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">recipe_folder_idx</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;recipe_folder&#39;</span><span class="p">)</span>
            <span class="n">config_idx</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">)</span>
            <span class="n">allow_missing_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">allow_missing_for</span> <span class="ow">or</span> <span class="p">[]]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> must have &#39;recipe_folder&#39; and &#39;config&#39; args&quot;</span><span class="p">)</span>
        <span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;recipe_folder&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to folder containing recipes (default: recipes/)&#39;</span><span class="p">)</span>
        <span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to Bioconda config (default: config.yml)&#39;</span><span class="p">)</span>
        <span class="nd">@utils</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">allow</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">allow_missing_idx</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">check_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">recipe_folder_idx</span><span class="p">,</span> <span class="s1">&#39;recipe_folder&#39;</span><span class="p">,</span> <span class="s1">&#39;recipes/&#39;</span><span class="p">,</span> <span class="n">allow</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">check_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">config_idx</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;config.yml&#39;</span><span class="p">,</span> <span class="n">allow</span><span class="p">)</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="get_recipes_to_build"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.get_recipes_to_build">[docs]</a><span class="k">def</span> <span class="nf">get_recipes_to_build</span><span class="p">(</span><span class="n">git_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">recipe_folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Gets list of modified recipes according to git_range and blacklist</span>

<span class="sd">    See `BiocondaRepoMixin.get_recipes_to_build()`.</span>

<span class="sd">    Arguments:</span>
<span class="sd">      git_range: one or two-tuple containing &quot;from&quot; and &quot;to&quot; git refs,</span>
<span class="sd">                 with &quot;to&quot; defaulting to &quot;HEAD&quot;</span>
<span class="sd">    Returns:</span>
<span class="sd">      List of recipes for which meta.yaml or build.sh was modified or</span>
<span class="sd">      which were unblacklisted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">git_range</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">git_range</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;--git-range may have only one or two arguments&quot;</span><span class="p">)</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">git_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="s2">&quot;HEAD&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">git_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">git_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">BiocondaRepo</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_recipes_to_build</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_recipes"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.get_recipes">[docs]</a><span class="k">def</span> <span class="nf">get_recipes</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">packages</span><span class="p">,</span> <span class="n">git_range</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Gets list of paths to recipe folders to be built</span>

<span class="sd">    Considers all recipes matching globs in packages, constrains to</span>
<span class="sd">    recipes modified or unblacklisted in the git_range if given, then</span>
<span class="sd">    removes blacklisted recipes.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">recipes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_recipes</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">packages</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Considering total of </span><span class="si">%s</span><span class="s2"> recipes</span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">recipes</span><span class="p">),</span> <span class="n">utils</span><span class="o">.</span><span class="n">ellipsize_recipes</span><span class="p">(</span><span class="n">recipes</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">git_range</span><span class="p">:</span>
        <span class="n">changed_recipes</span> <span class="o">=</span> <span class="n">get_recipes_to_build</span><span class="p">(</span><span class="n">git_range</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Constraining to </span><span class="si">%s</span><span class="s2"> git modified recipes</span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">changed_recipes</span><span class="p">),</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">ellipsize_recipes</span><span class="p">(</span><span class="n">changed_recipes</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">))</span>
        <span class="n">recipes</span> <span class="o">=</span> <span class="p">[</span><span class="n">recipe</span> <span class="k">for</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="n">recipes</span> <span class="k">if</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">changed_recipes</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">changed_recipes</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Overlap was </span><span class="si">%s</span><span class="s2"> recipes</span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipes</span><span class="p">),</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">ellipsize_recipes</span><span class="p">(</span><span class="n">recipes</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">))</span>

    <span class="n">blacklist</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_blacklist</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">)</span>
    <span class="n">blacklisted</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="n">recipes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">)</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">:</span>
            <span class="n">blacklisted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recipe</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">blacklisted</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ignoring </span><span class="si">%s</span><span class="s2"> blacklisted recipes</span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">blacklisted</span><span class="p">),</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">ellipsize_recipes</span><span class="p">(</span><span class="n">blacklisted</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">))</span>
        <span class="n">recipes</span> <span class="o">=</span> <span class="p">[</span><span class="n">recipe</span> <span class="k">for</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="n">recipes</span> <span class="k">if</span> <span class="n">recipe</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">blacklisted</span><span class="p">)]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing </span><span class="si">%s</span><span class="s2"> recipes</span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">recipes</span><span class="p">),</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">ellipsize_recipes</span><span class="p">(</span><span class="n">recipes</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">recipes</span></div>


<span class="c1"># NOTE:</span>
<span class="c1">#</span>
<span class="c1"># A package is the name of the software package, like `bowtie`.</span>
<span class="c1">#</span>
<span class="c1"># A recipe is the path to the recipe of one version of a package, like</span>
<span class="c1"># `recipes/bowtie` or `recipes/bowtie/1.0.1`.</span>


<div class="viewcode-block" id="duplicates"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.duplicates">[docs]</a><span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to yaml file specifying the configuration&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--strict-version&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Require version to strictly match.&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--strict-build&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Require version and build to strictly match.&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--remove&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Remove packages from anaconda.&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--dryrun&#39;</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Only print removal plan.&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--url&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Print anaconda urls.&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--channel&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Channel to check for duplicates&quot;</span><span class="p">)</span>
<span class="nd">@enable_logging</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">duplicates</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
               <span class="n">strict_version</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">strict_build</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">url</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">channel</span><span class="o">=</span><span class="s1">&#39;bioconda&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect packages in bioconda that have duplicates in the other defined</span>
<span class="sd">    channels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">remove</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">strict_build</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Removing packages is only supported in case of &#39;</span>
                         <span class="s1">&#39;--strict-build.&#39;</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">channel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Channel given with --channel must be in config channels&quot;</span><span class="p">)</span>
    <span class="n">our_channel</span> <span class="o">=</span> <span class="n">channel</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">our_channel</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking for packages from </span><span class="si">%s</span><span class="s2"> also present in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">our_channel</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>

    <span class="n">check_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">strict_version</span> <span class="ow">or</span> <span class="n">strict_build</span><span class="p">:</span>
        <span class="n">check_fields</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">strict_build</span><span class="p">:</span>
        <span class="n">check_fields</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">remove_package</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">.tar.bz2&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">subcmd</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="si">{channel}</span><span class="s1">/</span><span class="si">{name}</span><span class="s1">/</span><span class="si">{version}</span><span class="s1">/</span><span class="si">{fn}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">our_channel</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">utils</span><span class="o">.</span><span class="n">bin_for</span><span class="p">(</span><span class="s1">&#39;anaconda&#39;</span><span class="p">)]</span> <span class="o">+</span> <span class="n">subcmd</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ANACONDA_TOKEN&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="n">token</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">utils</span><span class="o">.</span><span class="n">bin_for</span><span class="p">(</span><span class="s1">&#39;anaconda&#39;</span><span class="p">)]</span> <span class="o">+</span> <span class="n">token</span> <span class="o">+</span> <span class="n">subcmd</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">[</span><span class="n">token</span><span class="p">])</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

    <span class="c1"># packages in our channel</span>
    <span class="n">repodata</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">RepoData</span><span class="p">()</span>
    <span class="n">our_package_specs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">repodata</span><span class="o">.</span><span class="n">get_package_data</span><span class="p">(</span><span class="n">check_fields</span><span class="p">,</span> <span class="n">our_channel</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> unique packages specs to consider in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">our_package_specs</span><span class="p">),</span> <span class="n">our_channel</span><span class="p">)</span>

    <span class="c1"># packages in channels we depend on</span>
    <span class="n">duplicate</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">package_specs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">repodata</span><span class="o">.</span><span class="n">get_package_data</span><span class="p">(</span><span class="n">check_fields</span><span class="p">,</span> <span class="n">channel</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> unique packages specs to consider in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">package_specs</span><span class="p">),</span> <span class="n">channel</span><span class="p">)</span>
        <span class="n">dups</span> <span class="o">=</span> <span class="n">our_package_specs</span> <span class="o">&amp;</span> <span class="n">package_specs</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  (of which </span><span class="si">%s</span><span class="s2"> are duplicate)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dups</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">dups</span><span class="p">:</span>
            <span class="n">duplicate</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">check_fields</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">spec</span><span class="p">,</span> <span class="n">dup_channels</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">duplicate</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
            <span class="n">remove_package</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">strict_version</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">strict_build</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;https://anaconda.org/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                          <span class="n">our_channel</span><span class="p">,</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;https://anaconda.org/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/files?version=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">our_channel</span><span class="p">,</span> <span class="o">*</span><span class="n">spec</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">spec</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dup_channels</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="do_lint"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.do_lint">[docs]</a><span class="nd">@recipe_folder_and_config</span><span class="p">(</span><span class="n">allow_missing_for</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;list_checks&#39;</span><span class="p">])</span>
<span class="nd">@arg</span><span class="p">(</span>
    <span class="s1">&#39;--packages&#39;</span><span class="p">,</span>
    <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Glob for package[s] to build. Default is to build all packages. Can &#39;</span>
    <span class="s1">&#39;be specified more than once&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--cache&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;To speed up debugging, use repodata cached locally in</span>
<span class="s1">     the provided filename. If the file does not exist, it will be created the</span>
<span class="s1">     first time.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--list-checks&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;List the linting functions to be used and then</span>
<span class="s1">     exit&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--exclude&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Exclude this linting function. Can be used</span>
<span class="s1">     multiple times.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--push-status&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;If set, the lint status will</span>
<span class="s1">     be sent to the current commit on github. Also needs --user and --repo to</span>
<span class="s1">     be set. Requires the env var GITHUB_TOKEN to be set. Note that pull</span>
<span class="s1">     requests from forks will not have access to encrypted variables on</span>
<span class="s1">     ci, so this feature may be of limited use.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--commit&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Commit on github on which to update status&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--push-comment&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;If set, the lint status</span>
<span class="s1">     will be posted as a comment in the corresponding pull request (given by</span>
<span class="s1">     --pull-request). Also needs --user and --repo to be set. Requires the env</span>
<span class="s1">     var GITHUB_TOKEN to be set.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--pull-request&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Pull request id on github on which to</span>
<span class="s1">     post a comment.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--user&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Github user&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--repo&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Github repo&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--git-range&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Git range (e.g. commits or something like</span>
<span class="s1">     &quot;master HEAD&quot; to check commits in HEAD vs master, or just &quot;HEAD&quot; to</span>
<span class="s1">     include uncommitted changes). All recipes modified within this range will</span>
<span class="s1">     be built if not present in the channel.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--full-report&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Default behavior is to</span>
<span class="s1">     summarize the linting results; use this argument to get the full</span>
<span class="s1">     results as a TSV printed to stdout.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--try-fix&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Attempt to fix problems where found&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@enable_logging</span><span class="p">()</span>
<span class="nd">@enable_debugging</span><span class="p">()</span>
<span class="nd">@named</span><span class="p">(</span><span class="s1">&#39;lint&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">do_lint</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">packages</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_checks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">push_status</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s1">&#39;bioconda&#39;</span><span class="p">,</span>
            <span class="n">commit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">push_comment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pull_request</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">repo</span><span class="o">=</span><span class="s1">&#39;bioconda-recipes&#39;</span><span class="p">,</span> <span class="n">git_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">full_report</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">try_fix</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lint recipes</span>

<span class="sd">    If --push-status is not set, reports a TSV of linting results to stdout.</span>
<span class="sd">    Otherwise pushes a commit status to the specified commit on github.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">list_checks</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">check</span><span class="p">)</span> <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">lint</span><span class="o">.</span><span class="n">get_checks</span><span class="p">()))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">RepoData</span><span class="p">()</span><span class="o">.</span><span class="n">set_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>

    <span class="n">recipes</span> <span class="o">=</span> <span class="n">get_recipes</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">packages</span><span class="p">,</span> <span class="n">git_range</span><span class="p">)</span>
    <span class="n">linter</span> <span class="o">=</span> <span class="n">lint</span><span class="o">.</span><span class="n">Linter</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">linter</span><span class="o">.</span><span class="n">lint</span><span class="p">(</span><span class="n">recipes</span><span class="p">,</span> <span class="n">fix</span><span class="o">=</span><span class="n">try_fix</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="n">linter</span><span class="o">.</span><span class="n">get_messages</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The following problems have been found:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">linter</span><span class="o">.</span><span class="n">get_report</span><span class="p">())</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All checks OK&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Errors were found&quot;</span><span class="p">)</span></div>


<span class="nd">@recipe_folder_and_config</span><span class="p">()</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--packages&#39;</span><span class="p">,</span>
     <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Glob for package[s] to build. Default is to build all packages. Can &#39;</span>
    <span class="s1">&#39;be specified more than once&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--git-range&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Git range (e.g. commits or something like</span>
<span class="s1">     &quot;master HEAD&quot; to check commits in HEAD vs master, or just &quot;HEAD&quot; to</span>
<span class="s1">     include uncommitted changes). All recipes modified within this range will</span>
<span class="s1">     be built if not present in the channel.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--testonly&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Test packages instead of building&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--force&#39;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Force building the recipe even if it already exists in the</span>
<span class="s1">     bioconda channel. If --force is specified, --git-range is ignored and only</span>
<span class="s1">     those packages matching --packages globs will be built.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--docker&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Build packages in docker container.&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--mulled-test&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run a mulled-build test on the built package&quot;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--mulled-upload-target&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Provide a quay.io target to push mulled docker images to.&quot;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--build_script_template&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Filename to optionally replace build</span>
<span class="s1">     script template used by the Docker container. By default use</span>
<span class="s1">     docker_utils.BUILD_SCRIPT_TEMPLATE. Only used if --docker is True.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--pkg_dir&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Specifies the directory to which container-built</span>
<span class="s1">     packages should be stored on the host. Default is to use the host&#39;s</span>
<span class="s1">     conda-bld dir. If --docker is not specified, then this argument is</span>
<span class="s1">     ignored.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--anaconda-upload&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;After building recipes, upload</span>
<span class="s1">     them to Anaconda. This requires $ANACONDA_TOKEN to be set.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--build-image&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Build temporary docker build</span>
<span class="s1">     image with conda/conda-build version matching local versions&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--keep-image&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;After building recipes, the</span>
<span class="s1">     created Docker image is removed by default to save disk space. Use this</span>
<span class="s1">     argument to disable this behavior.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--lint&#39;</span><span class="p">,</span> <span class="s1">&#39;--prelint&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Just before each recipe, apply</span>
<span class="s1">     the linting functions to it. This can be used as an alternative to linting</span>
<span class="s1">     all recipes before any building takes place with the `bioconda-utils lint`</span>
<span class="s1">     command.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--lint-exclude&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Exclude this linting function. Can be used multiple times.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--check-channels&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Channels to check recipes against before building. Any recipe</span>
<span class="s1">     already present in one of these channels will be skipped. The default is</span>
<span class="s1">     the first two channels specified in the config file. Note that this is</span>
<span class="s1">     ignored if you specify --git-range.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--n-workers&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;The number of parallel workers that are in use. This is intended</span>
<span class="s1">     for use in cases such as the &quot;bulk&quot; branch, where there are multiple</span>
<span class="s1">     parallel workers building and uploading recipes. In essence, this causes</span>
<span class="s1">     bioconda-utils to process every Nth sub-DAG, where N is the value you give</span>
<span class="s1">     to this option. The default is 1, which is intended for cases where there</span>
<span class="s1">     are NOT parallel workers (i.e., the majority of cases). This should</span>
<span class="s1">     generally NOT be used in conjunctions with the --packages or --git-range</span>
<span class="s1">     options!&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--worker-offset&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;This is only used if --nWorkers is &gt;1. In that case, then each</span>
<span class="s1">     instance of bioconda-utils will process every Nth sub-DAG. This option</span>
<span class="s1">     gives the 0-based offset for that. For example, if &quot;--n-workers 5 --worker-offset 0&quot;</span>
<span class="s1">     is used, then this instance of bioconda-utils will process the 1st, 6th,</span>
<span class="s1">     11th, etc. sub-DAGs. Equivalently, using &quot;--n-workers 5 --worker-offset 1&quot;</span>
<span class="s1">     will result in sub-DAGs 2, 7, 12, etc. being processed. If you use more</span>
<span class="s1">     than one worker, then make sure to give each a different offset!&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--keep-old-work&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Do not remove anything</span>
<span class="s1">from environment, even after successful build and test.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@enable_logging</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">packages</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">git_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">testonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
          <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">docker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mulled_test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">build_script_template</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">pkg_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">anaconda_upload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mulled_upload_target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">build_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keep_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lint_exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">check_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">worker_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keep_old_work</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">setup</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">setup</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Running setup: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">setup</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">setup</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">recipes</span> <span class="o">=</span> <span class="n">get_recipes</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">packages</span><span class="p">,</span> <span class="n">git_range</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">docker</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">build_script_template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">build_script_template</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">build_script_template</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">build_script_template</span> <span class="o">=</span> <span class="n">docker_utils</span><span class="o">.</span><span class="n">BUILD_SCRIPT_TEMPLATE</span>
        <span class="k">if</span> <span class="n">pkg_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_host_conda_bld</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_host_conda_bld</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">docker_builder</span> <span class="o">=</span> <span class="n">docker_utils</span><span class="o">.</span><span class="n">RecipeBuilder</span><span class="p">(</span>
            <span class="n">build_script_template</span><span class="o">=</span><span class="n">build_script_template</span><span class="p">,</span>
            <span class="n">pkg_dir</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">,</span>
            <span class="n">use_host_conda_bld</span><span class="o">=</span><span class="n">use_host_conda_bld</span><span class="p">,</span>
            <span class="n">keep_image</span><span class="o">=</span><span class="n">keep_image</span><span class="p">,</span>
            <span class="n">build_image</span><span class="o">=</span><span class="n">build_image</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">docker_builder</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">lint_exclude</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lint</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;--lint-exclude has no effect unless --lint is specified.&#39;</span><span class="p">)</span>

    <span class="n">label</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BIOCONDA_LABEL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>

    <span class="n">success</span> <span class="o">=</span> <span class="n">build_recipes</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">recipes</span><span class="p">,</span>
                            <span class="n">testonly</span><span class="o">=</span><span class="n">testonly</span><span class="p">,</span>
                            <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span>
                            <span class="n">mulled_test</span><span class="o">=</span><span class="n">mulled_test</span><span class="p">,</span>
                            <span class="n">docker_builder</span><span class="o">=</span><span class="n">docker_builder</span><span class="p">,</span>
                            <span class="n">anaconda_upload</span><span class="o">=</span><span class="n">anaconda_upload</span><span class="p">,</span>
                            <span class="n">mulled_upload_target</span><span class="o">=</span><span class="n">mulled_upload_target</span><span class="p">,</span>
                            <span class="n">do_lint</span><span class="o">=</span><span class="n">lint</span><span class="p">,</span>
                            <span class="n">lint_exclude</span><span class="o">=</span><span class="n">lint_exclude</span><span class="p">,</span>
                            <span class="n">check_channels</span><span class="o">=</span><span class="n">check_channels</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                            <span class="n">n_workers</span><span class="o">=</span><span class="n">n_workers</span><span class="p">,</span>
                            <span class="n">worker_offset</span><span class="o">=</span><span class="n">worker_offset</span><span class="p">,</span>
                            <span class="n">keep_old_work</span><span class="o">=</span><span class="n">keep_old_work</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>


<div class="viewcode-block" id="dag"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.dag">[docs]</a><span class="nd">@recipe_folder_and_config</span><span class="p">()</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--packages&#39;</span><span class="p">,</span>
     <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Glob for package[s] to show in DAG. Default is to show all &#39;</span>
     <span class="s1">&#39;packages. Can be specified more than once&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--format&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gml&#39;</span><span class="p">,</span> <span class="s1">&#39;dot&#39;</span><span class="p">,</span> <span class="s1">&#39;txt&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Set format to print</span>
<span class="s1">     graph. &quot;gml&quot; and &quot;dot&quot; can be imported into graph visualization tools</span>
<span class="s1">     (graphviz, gephi, cytoscape). &quot;txt&quot; will print out recipes grouped by</span>
<span class="s1">     independent subdags, largest subdag first, each in topologically sorted</span>
<span class="s1">     order. Singleton subdags (if not hidden with --hide-singletons) are</span>
<span class="s1">     reported as one large group at the end.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--hide-singletons&#39;</span><span class="p">,</span>
     <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Hide singletons in the printed graph.&#39;</span><span class="p">)</span>
<span class="nd">@enable_logging</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">dag</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">packages</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;gml&#39;</span><span class="p">,</span> <span class="n">hide_singletons</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export the DAG of packages to a graph format file for visualization</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dag</span><span class="p">,</span> <span class="n">name2recipes</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_recipes</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">),</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">packages</span> <span class="o">!=</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
        <span class="n">dag</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dag</span><span class="p">,</span> <span class="n">packages</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hide_singletons</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">dag</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dag</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dag</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;gml&#39;</span><span class="p">:</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">write_gml</span><span class="p">(</span><span class="n">dag</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;dot&#39;</span><span class="p">:</span>
        <span class="n">write_dot</span><span class="p">(</span><span class="n">dag</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;txt&#39;</span><span class="p">:</span>
        <span class="n">subdags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">sorted</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">dag</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">())))</span>
        <span class="n">subdags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">subdags</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">singletons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subdags</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">singletons</span> <span class="o">+=</span> <span class="n">s</span>
                <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# subdag </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">subdag</span> <span class="o">=</span> <span class="n">dag</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">recipes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">recipe</span> <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="n">subdag</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="n">name2recipes</span><span class="p">[</span><span class="n">package</span><span class="p">]]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recipes</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hide_singletons</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# singletons&#39;</span><span class="p">)</span>
            <span class="n">recipes</span> <span class="o">=</span> <span class="p">[</span><span class="n">recipe</span> <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">singletons</span> <span class="k">for</span> <span class="n">recipe</span> <span class="ow">in</span>
                       <span class="n">name2recipes</span><span class="p">[</span><span class="n">package</span><span class="p">]]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recipes</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_pinning"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.update_pinning">[docs]</a><span class="nd">@recipe_folder_and_config</span><span class="p">()</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--packages&#39;</span><span class="p">,</span>
     <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Glob for package[s] to update, as needed due to a change in pinnings&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--skip-additional-channels&#39;</span><span class="p">,</span>
     <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Skip updating/bumping packges that are already built with</span>
<span class="s2">     compatible pinnings in one of the given channels in addition to those</span>
<span class="s2">     listed in &#39;config&#39;.&quot;&quot;&quot;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--skip-variants&#39;</span><span class="p">,</span>
     <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Skip packages that use one of the given variant keys.&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--max-bumps&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Maximum number of recipes that will be updated.&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--no-leaves&#39;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Only update recipes with dependent packages.&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--cache&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;To speed up debugging, use repodata cached locally in</span>
<span class="s1">     the provided filename. If the file does not exist, it will be created the</span>
<span class="s1">     first time.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@enable_logging</span><span class="p">()</span>
<span class="nd">@enable_threads</span><span class="p">()</span>
<span class="nd">@enable_debugging</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">update_pinning</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">packages</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
                   <span class="n">skip_additional_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">skip_variants</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">max_bumps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">no_leaves</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bump a package build number and all dependencies as required due</span>
<span class="sd">    to a change in pinnings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">skip_additional_channels</span><span class="p">:</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">skip_additional_channels</span>
    <span class="n">skip_variants</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">skip_variants</span> <span class="ow">or</span> <span class="p">())</span>

    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">RepoData</span><span class="p">()</span><span class="o">.</span><span class="n">set_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">RepoData</span><span class="p">()</span><span class="o">.</span><span class="n">df</span>  <span class="c1"># trigger load</span>

    <span class="n">build_config</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_conda_build_config</span><span class="p">()</span>
    <span class="n">blacklist</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_blacklist</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">recipe</span>
    <span class="n">dag</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">build_from_recipes</span><span class="p">(</span>
        <span class="n">recip</span> <span class="k">for</span> <span class="n">recip</span> <span class="ow">in</span> <span class="n">recipe</span><span class="o">.</span><span class="n">load_parallel_iter</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">recip</span><span class="o">.</span><span class="n">reldir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">)</span>

    <span class="n">dag</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">filter_recipe_dag</span><span class="p">(</span><span class="n">dag</span><span class="p">,</span> <span class="n">packages</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="n">no_leaves</span><span class="p">:</span>
        <span class="n">dag</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span>
            <span class="n">dag</span><span class="p">,</span>
            <span class="p">(</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">degree</span> <span class="ow">in</span> <span class="n">dag</span><span class="o">.</span><span class="n">out_degree_iter</span><span class="p">()</span> <span class="k">if</span> <span class="n">degree</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Considering </span><span class="si">%i</span><span class="s2"> recipes&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dag</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">max_bumps</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_bumps</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">max_bumps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dag</span><span class="p">)</span>

    <span class="n">stats</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
    <span class="n">hadErrors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">bumpErrors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">needs_bump</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">update_pinnings</span><span class="o">.</span><span class="n">check</span><span class="p">,</span> <span class="n">build_config</span><span class="o">=</span><span class="n">build_config</span><span class="p">,</span> <span class="n">skip_variant_keys</span><span class="o">=</span><span class="n">skip_variants</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">State</span> <span class="o">=</span> <span class="n">update_pinnings</span><span class="o">.</span><span class="n">State</span>

    <span class="n">num_recipes_needing_bump</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">status</span><span class="p">,</span> <span class="n">recip</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">parallel_iter</span><span class="p">(</span><span class="n">needs_bump</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span> <span class="s2">&quot;Processing...&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Recipe </span><span class="si">%s</span><span class="s2"> status: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">recip</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">needs_bump</span><span class="p">():</span>
            <span class="n">num_recipes_needing_bump</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">num_recipes_needing_bump</span> <span class="o">&lt;=</span> <span class="n">max_bumps</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bumping </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">recip</span><span class="p">)</span>
                <span class="n">recip</span><span class="o">.</span><span class="n">reset_buildnumber</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">recip</span><span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">][</span><span class="s1">&#39;number&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">recip</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Bumping </span><span class="si">%s</span><span class="s2"> -- theoretically (</span><span class="si">%d</span><span class="s2"> out of </span><span class="si">%d</span><span class="s2"> allowed bumps)&quot;</span><span class="p">,</span>
                    <span class="n">recip</span><span class="p">,</span> <span class="n">num_recipes_needing_bump</span><span class="p">,</span> <span class="n">max_bumps</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">status</span><span class="o">.</span><span class="n">failed</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to inspect </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">recip</span><span class="p">)</span>
            <span class="n">hadErrors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">recip</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;OK: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">recip</span><span class="p">)</span>

    <span class="c1"># Print some information</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Packages requiring the following:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
    <span class="c1">#print(&quot;  No build number change needed: {}&quot;.format(stats[STATE.ok]))</span>
    <span class="c1">#print(&quot;  A rebuild for a new python version: {}&quot;.format(stats[STATE.bump_python]))</span>
    <span class="c1">#print(&quot;  A build number increment: {}&quot;.format(stats[STATE.bump]))</span>

    <span class="k">if</span> <span class="n">num_recipes_needing_bump</span> <span class="o">&gt;</span> <span class="n">max_bumps</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Only bumped </span><span class="si">{</span><span class="n">max_bumps</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="n">num_recipes_needing_bump</span><span class="si">}</span><span class="s2"> recipes&quot;</span>
            <span class="s2">&quot; that needed a build number bump.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">hadErrors</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> packages produced an error &quot;</span>
              <span class="s2">&quot;in conda-build: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hadErrors</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">hadErrors</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">bumpErrors</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The build numbers in the following recipes &quot;</span>
              <span class="s2">&quot;could not be incremented: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">bumpErrors</span><span class="p">)))</span></div>


<div class="viewcode-block" id="dependent"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.dependent">[docs]</a><span class="nd">@recipe_folder_and_config</span><span class="p">()</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--dependencies&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Return recipes in `recipe_folder` in the dependency chain for the</span>
<span class="s1">     packages listed here. Answers the question &quot;what does PACKAGE need?&quot;&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--reverse-dependencies&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Return recipes in `recipe_folder` in the reverse dependency chain</span>
<span class="s1">     for packages listed here. Answers the question &quot;what depends on</span>
<span class="s1">     PACKAGE?&quot;&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--restrict&#39;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Restrict --dependencies to packages in `recipe_folder`. Has no</span>
<span class="s1">     effect if --reverse-dependencies, which always looks just in the recipe</span>
<span class="s1">     dir.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@enable_logging</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">dependent</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">restrict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">dependencies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reverse_dependencies</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print recipes dependent on a package</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dependencies</span> <span class="ow">and</span> <span class="n">reverse_dependencies</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;`dependencies` and `reverse_dependencies` are mutually exclusive&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">reverse_dependencies</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;One of `--dependencies` or `--reverse-dependencies` is required.&#39;</span><span class="p">)</span>

    <span class="n">d</span><span class="p">,</span> <span class="n">n2r</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_recipes</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">),</span> <span class="n">config</span><span class="p">,</span> <span class="n">restrict</span><span class="o">=</span><span class="n">restrict</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reverse_dependencies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">descendants</span><span class="p">,</span> <span class="n">reverse_dependencies</span>
    <span class="k">elif</span> <span class="n">dependencies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">ancestors</span><span class="p">,</span> <span class="n">dependencies</span>

    <span class="n">pkgs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
        <span class="n">pkgs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pkgs</span><span class="p">)))))</span></div>


<div class="viewcode-block" id="bioconductor_skeleton"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.bioconductor_skeleton">[docs]</a><span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;package&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Bioconductor package name. This is case-sensitive, and</span>
<span class="s1">     must match the package name on the Bioconductor site. If &quot;update-all-packages&quot;</span>
<span class="s1">     is specified, then all packages in a given bioconductor release will be</span>
<span class="s1">     created/updated (--force is then implied).&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@recipe_folder_and_config</span><span class="p">()</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--versioned&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;If specified, recipe will be</span>
<span class="s1">     created in RECIPES/&lt;package&gt;/&lt;version&gt;&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--force&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Overwrite the contents of an</span>
<span class="s1">     existing recipe. If --recursive is also used, then overwrite *all* recipes</span>
<span class="s1">     created.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--pkg-version&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Package version to use instead of the current</span>
<span class="s1">     one&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--bioc-version&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Version of Bioconductor to target. If not</span>
<span class="s2">     specified, then automatically finds the latest version of Bioconductor</span>
<span class="s2">     with the specified version in --pkg-version, or if --pkg-version not</span>
<span class="s2">     specified, then finds the the latest package version in the latest</span>
<span class="s2">     Bioconductor version&quot;&quot;&quot;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--recursive&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Creates the recipes for all</span>
<span class="s2">     Bioconductor and CRAN dependencies of the specified package.&quot;&quot;&quot;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--skip-if-in-channels&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;When --recursive is used, it will build</span>
<span class="s2">     *all* recipes. Use this argument to skip recursive building for packages</span>
<span class="s2">     that already exist in the packages listed here.&quot;&quot;&quot;</span><span class="p">)</span>
<span class="nd">@enable_logging</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bioconductor_skeleton</span><span class="p">(</span>
    <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">versioned</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">pkg_version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bioc_version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">skip_if_in_channels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;conda-forge&#39;</span><span class="p">,</span> <span class="s1">&#39;bioconda&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a Bioconductor recipe. The recipe will be created in the &#39;recipes&#39;</span>
<span class="sd">    directory and will be prefixed by &quot;bioconductor-&quot;. If --recursive is set,</span>
<span class="sd">    then any R dependency recipes will be prefixed by &quot;r-&quot;.</span>

<span class="sd">    These R recipes must be evaluated on a case-by-case basis to determine if</span>
<span class="sd">    they are relevant to biology (in which case they should be submitted to</span>
<span class="sd">    bioconda) or not (submit to conda-forge).</span>

<span class="sd">    Biology-related:</span>
<span class="sd">        &#39;bioconda-utils clean-cran-skeleton &lt;recipe&gt; --no-windows&#39;</span>
<span class="sd">        and submit to Bioconda.</span>

<span class="sd">    Not bio-related:</span>
<span class="sd">        &#39;bioconda-utils clean-cran-skeleton &lt;recipe&gt;&#39;</span>
<span class="sd">        and submit to conda-forge.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seen_dependencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">package</span> <span class="o">==</span> <span class="s2">&quot;update-all-packages&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bioc_version</span><span class="p">:</span>
            <span class="n">bioc_version</span> <span class="o">=</span> <span class="n">_bioconductor_skeleton</span><span class="o">.</span><span class="n">latest_bioconductor_release_version</span><span class="p">()</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="n">_bioconductor_skeleton</span><span class="o">.</span><span class="n">fetchPackages</span><span class="p">(</span><span class="n">bioc_version</span><span class="p">)</span>
        <span class="n">needs_x</span> <span class="o">=</span> <span class="n">_bioconductor_skeleton</span><span class="o">.</span><span class="n">packagesNeedingX</span><span class="p">(</span><span class="n">packages</span><span class="p">)</span>
        <span class="n">problems</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">packages</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_bioconductor_skeleton</span><span class="o">.</span><span class="n">write_recipe</span><span class="p">(</span>
                    <span class="n">k</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bioc_version</span><span class="o">=</span><span class="n">bioc_version</span><span class="p">,</span>
                    <span class="n">pkg_version</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;Version&#39;</span><span class="p">],</span> <span class="n">versioned</span><span class="o">=</span><span class="n">versioned</span><span class="p">,</span> <span class="n">packages</span><span class="o">=</span><span class="n">packages</span><span class="p">,</span>
                    <span class="n">skip_if_in_channels</span><span class="o">=</span><span class="n">skip_if_in_channels</span><span class="p">,</span> <span class="n">needs_x</span> <span class="o">=</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">needs_x</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">problems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">problems</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;The following recipes had problems and were not finished: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">problems</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_bioconductor_skeleton</span><span class="o">.</span><span class="n">write_recipe</span><span class="p">(</span>
            <span class="n">package</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">bioc_version</span><span class="o">=</span><span class="n">bioc_version</span><span class="p">,</span>
            <span class="n">pkg_version</span><span class="o">=</span><span class="n">pkg_version</span><span class="p">,</span> <span class="n">versioned</span><span class="o">=</span><span class="n">versioned</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
            <span class="n">seen_dependencies</span><span class="o">=</span><span class="n">seen_dependencies</span><span class="p">,</span>
            <span class="n">skip_if_in_channels</span><span class="o">=</span><span class="n">skip_if_in_channels</span><span class="p">)</span></div>


<div class="viewcode-block" id="clean_cran_skeleton"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.clean_cran_skeleton">[docs]</a><span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;recipe&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Path to recipe to be cleaned&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--no-windows&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Use this when submitting an</span>
<span class="s2">     R package to Bioconda. After a CRAN skeleton is created, any</span>
<span class="s2">     Windows-related lines will be removed and the bld.bat file will be</span>
<span class="s2">     removed.&quot;&quot;&quot;</span><span class="p">)</span>
<span class="nd">@enable_logging</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">clean_cran_skeleton</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">no_windows</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans skeletons created by ``conda skeleton cran``.</span>

<span class="sd">    Before submitting to conda-forge or Bioconda, recipes generated with ``conda</span>
<span class="sd">    skeleton cran`` need to be cleaned up: comments removed, licenses fixed, and</span>
<span class="sd">    other linting.</span>

<span class="sd">    Use --no-windows for a Bioconda submission.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cran_skeleton</span><span class="o">.</span><span class="n">clean_skeleton_files</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">no_windows</span><span class="o">=</span><span class="n">no_windows</span><span class="p">)</span></div>


<div class="viewcode-block" id="autobump"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.autobump">[docs]</a><span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;recipe_folder&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to recipes directory&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to yaml file specifying the configuration&#39;</span><span class="p">)</span>
<span class="nd">@recipe_folder_and_config</span><span class="p">()</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--packages&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Glob(s) for package[s] to scan. Can be specified more than once&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--exclude&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Globs for package[s] to exclude from scan. Can be specified more than once&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--exclude-subrecipes&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;By default, only subrecipes explicitly</span>
<span class="s1">     enabled for watch in meta.yaml are considered. Set to &#39;always&#39; to</span>
<span class="s1">     exclude all subrecipes.  Set to &#39;never&#39; to include all subrecipes&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--exclude-channels&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Exclude recipes</span>
<span class="s1">     building packages present in other channels. Set to &#39;none&#39; to disable</span>
<span class="s1">     check.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--ignore-blacklists&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Do not exclude recipes from blacklist&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--fetch-requirements&#39;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Try to fetch python requirements. Please note that this requires</span>
<span class="s1">     downloading packages and executing setup.py, so presents a potential</span>
<span class="s1">     security problem.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--cache&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;To speed up debugging, use repodata cached locally in</span>
<span class="s1">     the provided filename. If the file does not exist, it will be created</span>
<span class="s1">     the first time. Caution: The cache will not be updated if</span>
<span class="s1">     exclude-channels is changed&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--unparsed-urls&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Write unrecognized urls to this file&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--failed-urls&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Write urls with permanent failure to this file&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--recipe-status&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Write status for each recipe to this file&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--check-branch&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Check if recipe has active branch&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s2">&quot;--only-active&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Check only recipes with active update&quot;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s2">&quot;--create-branch&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Create branch for each</span>
<span class="s1">     update&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s2">&quot;--create-pr&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Create PR for each update.</span>
<span class="s1">     Implies create-branch.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s2">&quot;--max-updates&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Exit after ARG updates&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s2">&quot;--no-shuffle&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Do not shuffle recipe order&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s2">&quot;--dry-run&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Don&#39;t update remote git or github&quot;&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s2">&quot;--no-check-pinnings&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Don&#39;t check for pinning updates&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s2">&quot;--no-follow-graph&quot;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Don&#39;t process recipes in graph order or add dependent recipes</span>
<span class="s1">     to checks. Implies --no-skip-pending-deps.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s2">&quot;--no-check-pending-deps&quot;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Don&#39;t check for recipes having a dependency with a pending update.</span>
<span class="s1">     Update all recipes, including those having deps in need or rebuild.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s2">&quot;--no-check-version-update&quot;</span><span class="p">,</span>
     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Don&#39;t check for version updates to recipes&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--sign&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Enable signing. Optionally takes keyid.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--commit-as&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Set user and email to use for committing. &#39;&#39;&#39;</span>
     <span class="sd">&#39;&#39;&#39;Takes exactly two arguments.&#39;&#39;&#39;</span><span class="p">)</span>
<span class="nd">@enable_logging</span><span class="p">()</span>
<span class="nd">@enable_debugging</span><span class="p">()</span>
<span class="nd">@enable_threads</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">autobump</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">packages</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">failed_urls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unparsed_urls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recipe_status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">exclude_subrecipes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_channels</span><span class="o">=</span><span class="s1">&#39;conda-forge&#39;</span><span class="p">,</span>
             <span class="n">ignore_blacklists</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">fetch_requirements</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">check_branch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">create_branch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">create_pr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">only_active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">max_updates</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">no_check_pinnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_follow_graph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">no_check_version_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">no_check_pending_deps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">sign</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">commit_as</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates recipes in recipe_folder</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># load and register config</span>
    <span class="n">config_dict</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">autobump</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">githubhandler</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">hosters</span>

    <span class="k">if</span> <span class="n">no_follow_graph</span><span class="p">:</span>
        <span class="n">recipe_source</span> <span class="o">=</span> <span class="n">autobump</span><span class="o">.</span><span class="n">RecipeSource</span><span class="p">(</span>
            <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">packages</span><span class="p">,</span> <span class="n">exclude</span> <span class="ow">or</span> <span class="p">[],</span> <span class="ow">not</span> <span class="n">no_shuffle</span><span class="p">)</span>
        <span class="n">no_skip_pending_deps</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">recipe_source</span> <span class="o">=</span> <span class="n">autobump</span><span class="o">.</span><span class="n">RecipeGraphSource</span><span class="p">(</span>
            <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">packages</span><span class="p">,</span> <span class="n">exclude</span> <span class="ow">or</span> <span class="p">[],</span> <span class="ow">not</span> <span class="n">no_shuffle</span><span class="p">,</span>
            <span class="n">config_dict</span><span class="p">,</span> <span class="n">cache_fn</span><span class="o">=</span><span class="n">cache</span> <span class="ow">and</span> <span class="n">cache</span> <span class="o">+</span> <span class="s2">&quot;_dag.pkl&quot;</span><span class="p">)</span>

    <span class="c1"># Setup scanning pipeline</span>
    <span class="n">scanner</span> <span class="o">=</span> <span class="n">autobump</span><span class="o">.</span><span class="n">Scanner</span><span class="p">(</span><span class="n">recipe_source</span><span class="p">,</span>
                               <span class="n">cache_fn</span><span class="o">=</span><span class="n">cache</span> <span class="ow">and</span> <span class="n">cache</span> <span class="o">+</span> <span class="s2">&quot;_scan.pkl&quot;</span><span class="p">,</span>
                               <span class="n">status_fn</span><span class="o">=</span><span class="n">recipe_status</span><span class="p">)</span>

    <span class="c1"># Always exclude recipes that were explicitly disabled</span>
    <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">ExcludeDisabled</span><span class="p">)</span>

    <span class="c1"># Exclude packages that are on the blacklist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_blacklists</span><span class="p">:</span>
        <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">ExcludeBlacklisted</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">)</span>

    <span class="c1"># Exclude sub-recipes</span>
    <span class="k">if</span> <span class="n">exclude_subrecipes</span> <span class="o">!=</span> <span class="s2">&quot;never&quot;</span><span class="p">:</span>
        <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">ExcludeSubrecipe</span><span class="p">,</span>
                    <span class="n">always</span><span class="o">=</span><span class="n">exclude_subrecipes</span> <span class="o">==</span> <span class="s2">&quot;always&quot;</span><span class="p">)</span>

    <span class="c1"># Exclude recipes with dependencies pending an update</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_check_pending_deps</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">no_follow_graph</span><span class="p">:</span>
        <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">ExcludeDependencyPending</span><span class="p">,</span> <span class="n">recipe_source</span><span class="o">.</span><span class="n">dag</span><span class="p">)</span>

    <span class="c1"># Load recipe</span>
    <span class="n">git_handler</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">check_branch</span> <span class="ow">or</span> <span class="n">create_branch</span> <span class="ow">or</span> <span class="n">create_pr</span> <span class="ow">or</span> <span class="n">only_active</span><span class="p">:</span>
        <span class="c1"># We need to take the recipe from the git repo. This</span>
        <span class="c1"># loads the bump/&lt;recipe&gt; branch if available</span>
        <span class="n">git_handler</span> <span class="o">=</span> <span class="n">BiocondaRepo</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">)</span>
        <span class="n">git_handler</span><span class="o">.</span><span class="n">checkout_master</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">only_active</span><span class="p">:</span>
            <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">ExcludeNoActiveUpdate</span><span class="p">,</span> <span class="n">git_handler</span><span class="p">)</span>
        <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">GitLoadRecipe</span><span class="p">,</span> <span class="n">git_handler</span><span class="p">)</span>

        <span class="n">env_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CODE_SIGNING_KEY&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sign</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">git_handler</span><span class="o">.</span><span class="n">enable_signing</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">sign</span><span class="p">:</span>
            <span class="n">git_handler</span><span class="o">.</span><span class="n">enable_signing</span><span class="p">(</span><span class="n">sign</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">env_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">git_handler</span><span class="o">.</span><span class="n">enable_signing</span><span class="p">(</span><span class="n">install_gpg_key</span><span class="p">(</span><span class="n">env_key</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to use CODE_SIGNING_KEY from environment: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                             <span class="n">exc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">commit_as</span><span class="p">:</span>
            <span class="n">git_handler</span><span class="o">.</span><span class="n">set_user</span><span class="p">(</span><span class="o">*</span><span class="n">commit_as</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Just load from local file system</span>
        <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">LoadRecipe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sign</span> <span class="ow">or</span> <span class="n">sign</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not using git. --sign has no effect&quot;</span><span class="p">)</span>

    <span class="c1"># Exclude recipes that are present in &quot;other channels&quot;</span>
    <span class="k">if</span> <span class="n">exclude_channels</span> <span class="o">!=</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude_channels</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">exclude_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">exclude_channels</span><span class="p">]</span>
        <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">ExcludeOtherChannel</span><span class="p">,</span> <span class="n">exclude_channels</span><span class="p">,</span>
                    <span class="n">cache</span> <span class="ow">and</span> <span class="n">cache</span> <span class="o">+</span> <span class="s2">&quot;_repodata.txt&quot;</span><span class="p">)</span>

    <span class="c1"># Test if due to pinnings, the package hash would change and a rebuild</span>
    <span class="c1"># has become necessary. If so, bump the buildnumber.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_check_pinnings</span><span class="p">:</span>
        <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">CheckPinning</span><span class="p">)</span>

    <span class="c1"># Check for new versions and update the SHA afterwards</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_check_version_update</span><span class="p">:</span>
        <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">UpdateVersion</span><span class="p">,</span> <span class="n">hosters</span><span class="o">.</span><span class="n">Hoster</span><span class="o">.</span><span class="n">select_hoster</span><span class="p">,</span> <span class="n">unparsed_urls</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fetch_requirements</span><span class="p">:</span>
            <span class="c1"># This attempts to determine dependencies exported by PyPi packages,</span>
            <span class="c1"># requires running setup.py, so only enabled on request.</span>
            <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">FetchUpstreamDependencies</span><span class="p">)</span>
        <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">UpdateChecksums</span><span class="p">,</span> <span class="n">failed_urls</span><span class="p">)</span>

    <span class="c1"># Write the recipe. For making PRs, the recipe should be written to a branch</span>
    <span class="c1"># of its own.</span>
    <span class="k">if</span> <span class="n">create_branch</span> <span class="ow">or</span> <span class="n">create_pr</span><span class="p">:</span>
        <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">GitWriteRecipe</span><span class="p">,</span> <span class="n">git_handler</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">WriteRecipe</span><span class="p">)</span>

    <span class="c1"># Create a PR for the branch</span>
    <span class="k">if</span> <span class="n">create_pr</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN required to create PRs&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">github_handler</span> <span class="o">=</span> <span class="n">githubhandler</span><span class="o">.</span><span class="n">AiohttpGitHubHandler</span><span class="p">(</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">,</span> <span class="s2">&quot;bioconda&quot;</span><span class="p">,</span> <span class="s2">&quot;bioconda-recipes&quot;</span><span class="p">)</span>
        <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">CreatePullRequest</span><span class="p">,</span> <span class="n">git_handler</span><span class="p">,</span> <span class="n">github_handler</span><span class="p">)</span>

    <span class="c1"># Terminate the scanning pipeline after x recipes have reached this point.</span>
    <span class="k">if</span> <span class="n">max_updates</span><span class="p">:</span>
        <span class="n">scanner</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">autobump</span><span class="o">.</span><span class="n">MaxUpdates</span><span class="p">,</span> <span class="n">max_updates</span><span class="p">)</span>

    <span class="c1"># And go.</span>
    <span class="n">scanner</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Cleanup</span>
    <span class="k">if</span> <span class="n">git_handler</span><span class="p">:</span>
        <span class="n">git_handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="bot"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.cli.html#bioconda_utils.cli.bot">[docs]</a><span class="nd">@arg</span><span class="p">(</span><span class="s1">&#39;--loglevel&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Log level&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bot</span><span class="p">(</span><span class="n">loglevel</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Locally accedd bioconda-bot command API</span>

<span class="sd">    To run the bot locally, use:</span>

<span class="sd">    $ gunicorn bioconda_utils.bot:init_app_internal_celery --worker-class aiohttp.worker.GunicornWebWorker</span>

<span class="sd">    You can append --reload to have gunicorn reload if any of the python files change.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">utils</span><span class="o">.</span><span class="n">setup_logger</span><span class="p">(</span><span class="s1">&#39;bioconda_utils&#39;</span><span class="p">,</span> <span class="n">loglevel</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Nothing here yet&quot;</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="s1">&#39;--version&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This is bioconda-utils version&quot;</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">argh</span><span class="o">.</span><span class="n">dispatch_commands</span><span class="p">([</span>
        <span class="n">build</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span> <span class="n">dependent</span><span class="p">,</span> <span class="n">do_lint</span><span class="p">,</span> <span class="n">duplicates</span><span class="p">,</span> <span class="n">update_pinning</span><span class="p">,</span>
        <span class="n">bioconductor_skeleton</span><span class="p">,</span> <span class="n">clean_cran_skeleton</span><span class="p">,</span> <span class="n">autobump</span><span class="p">,</span> <span class="n">bot</span>
    <span class="p">])</span>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2016-2021, The Bioconda Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    <div class="git-ribbon">
      <a href="https://github.com/bioconda/bioconda-utils/edit/master/bioconda_utils/cli.py" rel="me">Edit me on GitHub</a>
    </div>
  </body>
</html>