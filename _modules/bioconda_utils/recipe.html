
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bioconda_utils.recipe &#8212; Bioconda  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/font-awesome-4.7.0/css/font-awesome.min.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/vega.min.js"></script>
    <script src="../../_static/vega-lite.min.js"></script>
    <script src="../../_static/vega-embed.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="https://fonts.googleapis.com/css?family=Lato|Raleway" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">

    <link rel="apple-touch-icon" sizes="57x57" href="../../_static/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../../_static/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../../_static/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../../_static/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../../_static/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../../_static/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../../_static/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../../_static/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../_static/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="../../_static/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../_static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../../_static/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../_static/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="../../_static/ms-icon-144x144.png">

    <script>
        const openDetailsIfAnchorHidden = evt => {
          const targetDiv = document.querySelector(evt.target.getAttribute("href"));

          // Detect if the target is hidden, in which case do nothing
          const props = window.getComputedStyle(targetDiv);
          if (props.display === 'none' || props.visibility === 'hidden') return;

          // otherwise, find the closest <details> element and open it
          targetDiv.closest("details").open = true;
        }

        [...document.querySelectorAll("[href^='#']")].forEach( 
           el => el.addEventListener("click", openDetailsIfAnchorHidden )
        );
    </script>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />


  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo/bioconda_monochrome_small.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faqs.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributor/index.html">Contributing to Bioconda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a></li>
</ul>

<ul>
  
  <li class="toctree-l1"><a href="../../conda-package_index.html">Browse packages</a></li>
  
  <li class="toctree-l1"><a href="https://github.com/bioconda/bioconda-recipes">Bioconda @ Github</a></li>
  
  <li class="toctree-l1"><a href="https://gitter.im/bioconda/Lobby"><img alt="Gitter" src="https://img.shields.io/gitter/room/bioconda/Lobby.svg"></a></li>
  
</ul>
<div id="searchbox" style="display: none" role="search">
    <h3 id="searchlabel">Search</h3>
    <p id="searchdesc">packages & docs</p>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bioconda_utils.recipe</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Editable Recipe (``meta.yaml``)</span>

<span class="sd">The **meta.yaml** format used by conda to describe how a package</span>
<span class="sd">is built has diverged from standard YAML format significantly. This</span>
<span class="sd">module implements a class `Recipe` that in contrast to the **Meta**</span>
<span class="sd">object resulting from parsing by **conda_build** offers functions to</span>
<span class="sd">edit the meta.yaml.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">types</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">redirect_stdout</span><span class="p">,</span> <span class="n">redirect_stderr</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Pattern</span>


<span class="kn">import</span> <span class="nn">conda_build.api</span>
<span class="kn">from</span> <span class="nn">conda_build.metadata</span> <span class="kn">import</span> <span class="n">MetaData</span>
<span class="kn">from</span> <span class="nn">boa.cli.mambabuild</span> <span class="kn">import</span> <span class="n">prepare</span> <span class="k">as</span> <span class="n">insert_mambabuild</span>

<span class="kn">import</span> <span class="nn">jinja2</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ruamel.yaml</span> <span class="kn">import</span> <span class="n">YAML</span>
    <span class="kn">from</span> <span class="nn">ruamel.yaml.constructor</span> <span class="kn">import</span> <span class="n">DuplicateKeyError</span>
    <span class="kn">from</span> <span class="nn">ruamel.yaml.error</span> <span class="kn">import</span> <span class="n">YAMLError</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ruamel_yaml</span> <span class="kn">import</span> <span class="n">YAML</span>
    <span class="kn">from</span> <span class="nn">ruamel_yaml.constructor</span> <span class="kn">import</span> <span class="n">DuplicateKeyError</span>
    <span class="kn">from</span> <span class="nn">ruamel_yaml.error</span> <span class="kn">import</span> <span class="n">YAMLError</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">.aiopipe</span> <span class="kn">import</span> <span class="n">EndProcessingItem</span>


<span class="n">yaml</span> <span class="o">=</span> <span class="n">YAML</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="s2">&quot;rt&quot;</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-name</span>

<span class="c1"># Hack: mirror stringify from conda-build in removing implicit</span>
<span class="c1">#       resolution of numbers</span>
<span class="k">for</span> <span class="n">digit</span> <span class="ow">in</span> <span class="s1">&#39;0123456789&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">digit</span> <span class="ow">in</span> <span class="n">yaml</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">versioned_resolver</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">yaml</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">versioned_resolver</span><span class="p">[</span><span class="n">digit</span><span class="p">]</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-name</span>


<div class="viewcode-block" id="RecipeError"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.RecipeError">[docs]</a><span class="k">class</span> <span class="nc">RecipeError</span><span class="p">(</span><span class="n">EndProcessingItem</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot; (at line </span><span class="si">%i</span><span class="s2"> / column </span><span class="si">%i</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot; (at line </span><span class="si">%i</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">line</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>


<div class="viewcode-block" id="DuplicateKey"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.DuplicateKey">[docs]</a><span class="k">class</span> <span class="nc">DuplicateKey</span><span class="p">(</span><span class="n">RecipeError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised for recipes with duplicate keys in the meta.yaml. YAML</span>
<span class="sd">    does not allow those, but the PyYAML parser silently overwrites</span>
<span class="sd">    previous keys.</span>

<span class="sd">    For duplicate keys that are a result of ``# [osx]`` style line selectors,</span>
<span class="sd">    `Recipe` attempts to resolve them as a list of dictionaries instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;has duplicate key&quot;</span></div>


<div class="viewcode-block" id="MissingKey"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.MissingKey">[docs]</a><span class="k">class</span> <span class="nc">MissingKey</span><span class="p">(</span><span class="n">RecipeError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised if a recipe is missing package/version or package/name&quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;has missing key&quot;</span></div>


<div class="viewcode-block" id="EmptyRecipe"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.EmptyRecipe">[docs]</a><span class="k">class</span> <span class="nc">EmptyRecipe</span><span class="p">(</span><span class="n">RecipeError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised if the recipe file is empty&quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;is empty&quot;</span></div>


<div class="viewcode-block" id="MissingBuild"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.MissingBuild">[docs]</a><span class="k">class</span> <span class="nc">MissingBuild</span><span class="p">(</span><span class="n">RecipeError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised if the recipe is missing the build section&quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;is missing build section&quot;</span></div>


<div class="viewcode-block" id="HasSelector"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.HasSelector">[docs]</a><span class="k">class</span> <span class="nc">HasSelector</span><span class="p">(</span><span class="n">RecipeError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when recplacements fail due to ``# [cond]`` line selectors</span>
<span class="sd">    FIXME: This should no longer be an error</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;has selector in line </span><span class="si">%i</span><span class="s2"> (replace failed)&quot;</span></div>


<div class="viewcode-block" id="MissingMetaYaml"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.MissingMetaYaml">[docs]</a><span class="k">class</span> <span class="nc">MissingMetaYaml</span><span class="p">(</span><span class="n">RecipeError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when FileNotFoundError is encountered</span>

<span class="sd">    self.item is NOT a Recipe but a str here</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;has missing file `meta.yaml`&quot;</span></div>

<div class="viewcode-block" id="CondaRenderFailure"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.CondaRenderFailure">[docs]</a><span class="k">class</span> <span class="nc">CondaRenderFailure</span><span class="p">(</span><span class="n">RecipeError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when conda_build.api.render fails&quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;could not be rendered by conda-build: </span><span class="si">%s</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="RenderFailure"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.RenderFailure">[docs]</a><span class="k">class</span> <span class="nc">RenderFailure</span><span class="p">(</span><span class="n">RecipeError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised on Jinja rendering problems</span>

<span class="sd">    May have self.line</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;failed to render in Jinja2. Error was: </span><span class="si">%s</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="Recipe"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe">[docs]</a><span class="k">class</span> <span class="nc">Recipe</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a recipe (meta.yaml) in editable form</span>

<span class="sd">    Using conda-build to render recipe is slow and a one-way</span>
<span class="sd">    process. We need to be able to load **and** save recipes, which is</span>
<span class="sd">    handled by the representation in this class.</span>

<span class="sd">    Recipes undergo two manipulation rounds before parsed as YAML:</span>
<span class="sd">     1. Selecting lines using ``# [expression]``</span>
<span class="sd">     2. Rendering as Jinja2 template</span>

<span class="sd">    (1) is currently unhandled, leading to recipes with repeated mapping keys</span>
<span class="sd">    (commonly two ``url`` keys). Those recipes are ignored for the time being.</span>

<span class="sd">    Arguments:</span>
<span class="sd">      recipe_folder: base recipes folder</span>
<span class="sd">      recipe_dir: path to specific recipe</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1">#: Variables to pass to Jinja when rendering recipe</span>
    <span class="n">JINJA_VARS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;cran_mirror&quot;</span><span class="p">:</span> <span class="s2">&quot;https://cloud.r-project.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;compiler&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;compiler_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pin_compatible&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">max_pin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_pin</span><span class="o">=</span><span class="kc">None</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cdt&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
    <span class="p">}</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recipe_dir</span><span class="p">,</span> <span class="n">recipe_folder</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recipe_dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">recipe_dir</span><span class="si">}</span><span class="s2">&#39; not inside &#39;</span><span class="si">{</span><span class="n">recipe_folder</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>


        <span class="c1">#: path to folder containing recipes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">=</span> <span class="n">recipe_folder</span>
        <span class="c1">#: relative path to recipe dir from folder containing recipes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reldir</span> <span class="o">=</span> <span class="n">recipe_dir</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="c1"># Filled in by render()</span>
        <span class="c1">#: Parsed recipe YAML</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conda_build_config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_scripts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># These will be filled in by load_from_string()</span>
        <span class="c1">#: Lines of the raw recipe file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Filled in by update filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#: Original recipe before modifications (updated by load_from_string)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig</span><span class="p">:</span> <span class="n">Recipe</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1">#: Whether the recipe was loaded from a branch (update in progress)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_branch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#: For passing data around</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># for conda_render() and conda_release()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conda_meta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conda_tempdir</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Full path to ``meta.yaml``&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reldir</span><span class="p">,</span> <span class="s2">&quot;meta.yaml&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">relpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Relative path to ``meta.yaml`` (from ``basedir``)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reldir</span><span class="p">,</span> <span class="s2">&quot;meta.yaml&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Path to recipe folder&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reldir</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reldir</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reldir</span><span class="si">}</span><span class="s1">&quot;&#39;</span>

<div class="viewcode-block" id="Recipe.load_from_string"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.load_from_string">[docs]</a>    <span class="k">def</span> <span class="nf">load_from_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Recipe&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load and `render` recipe contents from disk&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EmptyRecipe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">read_conda_build_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Cache contents of conda_build_config.yaml for conda_render.</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s1">&#39;conda_build_config.yaml&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conda_build_config</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conda_build_config</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">read_build_scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Cache contents of build scripts for conda_render since conda-build</span>
        <span class="c1"># inspects build scripts for used variant variables.</span>
        <span class="n">scripts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;build.sh&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outputs&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">()</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_scripts</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">scripts</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">script</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="ow">in</span> <span class="n">script</span><span class="p">:</span>
                <span class="c1"># Only support flat folder structure.</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">script</span><span class="p">)</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_scripts</span><span class="p">[</span><span class="n">script</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>

<div class="viewcode-block" id="Recipe.from_file"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">recipe_dir</span><span class="p">,</span> <span class="n">recipe_fname</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Recipe&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new `Recipe` object from file</span>

<span class="sd">        Args:</span>
<span class="sd">           recipe_dir: Path to recipes folder</span>
<span class="sd">           recipe_fname: Relative path to recipe (folder or meta.yaml)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">recipe_fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;meta.yaml&quot;</span><span class="p">):</span>
            <span class="n">recipe_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">recipe_fname</span><span class="p">)</span>
        <span class="n">recipe</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">recipe_fname</span><span class="p">,</span> <span class="n">recipe_dir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">recipe_fname</span><span class="p">,</span> <span class="s1">&#39;meta.yaml&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">text</span><span class="p">:</span>
                <span class="n">recipe</span><span class="o">.</span><span class="n">load_from_string</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">MissingMetaYaml</span><span class="p">(</span><span class="n">recipe_fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_exceptions</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">exc</span>
            <span class="k">raise</span> <span class="n">exc</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_exceptions</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">exc</span>
            <span class="k">raise</span> <span class="n">exc</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">recipe</span><span class="o">.</span><span class="n">read_conda_build_config</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_exceptions</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">exc</span>
            <span class="k">raise</span> <span class="n">exc</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">recipe</span><span class="o">.</span><span class="n">read_build_scripts</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_exceptions</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">exc</span>
            <span class="k">raise</span> <span class="n">exc</span>
        <span class="n">recipe</span><span class="o">.</span><span class="n">set_original</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">recipe</span></div>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fdes</span><span class="p">:</span>
            <span class="n">fdes</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">())</span>

<div class="viewcode-block" id="Recipe.set_original"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.set_original">[docs]</a>    <span class="k">def</span> <span class="nf">set_original</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store the current state of the recipe as &quot;original&quot; version&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">is_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig</span><span class="o">.</span><span class="n">meta_yaml</span>

<div class="viewcode-block" id="Recipe.dump"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dump recipe content&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_rewrite_selector_block</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">block_top</span><span class="p">,</span> <span class="n">block_left</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">block_left</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># never the whole yaml</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">block_height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">variants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">block_height</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">block_top</span><span class="p">:]):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">block_left</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">selector</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">selector</span><span class="p">:</span>
                <span class="n">variants</span><span class="p">[</span><span class="n">selector</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;[] &quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
                    <span class="n">variants</span><span class="p">[</span><span class="n">variant</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># end of file, need to add one to block height</span>
            <span class="n">block_height</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">block_height</span><span class="p">:</span>  <span class="c1"># empty lines?</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">variants</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">):</span>
            <span class="c1"># can&#39;t handle &quot;[py2k or osx]&quot; style things</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">new_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">variants</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">variant</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                    <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">block_left</span><span class="p">,</span> <span class="s2">&quot;- &quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)))</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">block_left</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">line</span><span class="p">)))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Replacing: lines </span><span class="si">%i</span><span class="s2"> - </span><span class="si">%i</span><span class="s2"> with </span><span class="si">%i</span><span class="s2"> lines:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="n">block_top</span><span class="p">,</span> <span class="n">block_top</span><span class="o">+</span><span class="n">block_height</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_lines</span><span class="p">),</span>
                     <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">block_top</span><span class="p">:</span><span class="n">block_top</span><span class="o">+</span><span class="n">block_height</span><span class="p">]),</span>
                     <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_lines</span><span class="p">))</span>

        <span class="n">lines</span><span class="p">[</span><span class="n">block_top</span><span class="p">:</span><span class="n">block_top</span><span class="o">+</span><span class="n">block_height</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_lines</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<div class="viewcode-block" id="Recipe.get_template"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.get_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a Jinja2 template from the current raw recipe&quot;&quot;&quot;</span>
        <span class="c1"># This function exists because the template cannot be pickled.</span>
        <span class="c1"># Storing it means the recipe cannot be pickled, which in turn</span>
        <span class="c1"># means we cannot pass it to ProcessExecutors.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">jinja_silent_undef</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">jinja2</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TemplateSyntaxError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RenderFailure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">jinja2</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TemplateError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RenderFailure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="Recipe.get_simple_modules"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.get_simple_modules">[docs]</a>    <span class="k">def</span> <span class="nf">get_simple_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield simple replacement values from template</span>

<span class="sd">        E.g. those set with ``{% set version=&#39;1.2.3&#39; %}```</span>

<span class="sd">        Returns:</span>
<span class="sd">          a dictionary of replacements (e.g. version: 1.2.3)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># unused</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">attr</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="s1">&#39;__call__&#39;</span><span class="p">)</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="Recipe.render"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert recipe text into data structure</span>

<span class="sd">        - create jinja template from recipe content</span>
<span class="sd">        - render template</span>
<span class="sd">        - parse yaml</span>
<span class="sd">        - normalize</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">yaml_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">JINJA_VARS</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">yaml_text</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">DuplicateKeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">problem_mark</span><span class="o">.</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">column</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">problem_mark</span><span class="o">.</span><span class="n">column</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;fixing duplicate key at </span><span class="si">%i</span><span class="s2">:</span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
            <span class="c1"># We may have encountered a recipe with linux/osx variants using line selectors</span>
            <span class="n">yaml_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_selector_block</span><span class="p">(</span><span class="n">yaml_text</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">context_mark</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                                                     <span class="n">err</span><span class="o">.</span><span class="n">context_mark</span><span class="o">.</span><span class="n">column</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">yaml_text</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">yaml_text</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">DuplicateKeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DuplicateKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DuplicateKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;package&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> \
           <span class="ow">or</span> <span class="s2">&quot;version&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;package&quot;</span><span class="p">]</span> \
           <span class="ow">or</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;package&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">MissingKey</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">maintainers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of recipe maintainers&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;extra&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="ow">and</span> <span class="s1">&#39;recipe-maintainers&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;extra&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">ensure_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;extra&#39;</span><span class="p">][</span><span class="s1">&#39;recipe-maintainers&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The name of the toplevel package built by this recipe&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;package&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The version of the package build by this recipe&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;package&quot;</span><span class="p">][</span><span class="s2">&quot;version&quot;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">build_number</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The current build number&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;build&quot;</span><span class="p">][</span><span class="s2">&quot;number&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">noraise</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">noraise</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">number</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last</span><span class="p">[</span><span class="n">number</span><span class="p">])</span>
                    <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">noraise</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">keys</span>

<div class="viewcode-block" id="Recipe.get_raw_range"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.get_raw_range">[docs]</a>    <span class="k">def</span> <span class="nf">get_raw_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Locate the position of a node in the YAML within the raw text</span>

<span class="sd">        See also `get_raw()` if you want to get the content of the unparsed</span>
<span class="sd">        meta.yaml at a specific key.</span>

<span class="sd">        Args:</span>
<span class="sd">          path: The &quot;path&quot; to the node. Use numbers for lists (&#39;source/1/url&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">          a tuple of first_row, first_column, last_row, last_column</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">nodes</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_walk</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># pop parsed value</span>

        <span class="c1"># get the start row/col for the value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">start_row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># getting the end is more complicated, we need to move</span>
        <span class="c1"># up the tree to the next item in order until one is not the last</span>
        <span class="c1"># item in its collection</span>
        <span class="k">while</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                    <span class="n">end_row</span><span class="p">,</span> <span class="n">end_col</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">node_keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">next_key</span> <span class="o">=</span> <span class="n">node_keys</span><span class="p">[</span><span class="n">node_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">end_row</span><span class="p">,</span> <span class="n">end_col</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">next_key</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># reached end of file</span>
            <span class="n">end_row</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">end_col</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">end_row</span><span class="p">])</span>

        <span class="c1"># now go backward</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">start_row</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">end_row</span><span class="p">,</span> <span class="n">end_col</span><span class="p">)</span></div>

<div class="viewcode-block" id="Recipe.get_raw"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.get_raw">[docs]</a>    <span class="k">def</span> <span class="nf">get_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extracts the unparsed text for a node in the meta.yaml</span>

<span class="sd">        This may contain separators and other characters from</span>
<span class="sd">        the yaml!</span>

<span class="sd">        Args:</span>
<span class="sd">          path: Slash-separated path to the node. Numbers can be used</span>
<span class="sd">                to access indices in lists. A number &#39;0&#39; is ignored if</span>
<span class="sd">                the node is a dict (so &#39;source/0/url&#39; will work even if</span>
<span class="sd">                there is only one url).</span>

<span class="sd">        Returns:</span>
<span class="sd">          Extracted raw text</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_row</span><span class="p">,</span> <span class="n">start_col</span><span class="p">,</span> <span class="n">end_row</span><span class="p">,</span> <span class="n">end_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_raw_range</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_row</span> <span class="o">==</span> <span class="n">end_row</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">start_row</span><span class="p">][</span><span class="n">start_col</span><span class="p">:</span><span class="n">end_col</span><span class="p">]</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># first row</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">start_row</span><span class="p">][</span><span class="n">start_col</span><span class="p">:])</span>
        <span class="c1"># middle rows if any</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_row</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">end_row</span><span class="p">][:</span><span class="n">end_col</span><span class="p">])</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>

<div class="viewcode-block" id="Recipe.get"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Any</span><span class="o">=</span><span class="ne">KeyError</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a value or section from the recipe</span>

<span class="sd">        &gt;&gt;&gt; recipe.get(&#39;requirements/build&#39;)</span>
<span class="sd">        [&#39;setuptools]</span>
<span class="sd">        &gt;&gt;&gt; recipe.get(&#39;source/0/url&#39;)</span>
<span class="sd">        &#39;https://somewhere&#39;</span>

<span class="sd">        The **path** is a ``/`` separated list of dictionary keys to</span>
<span class="sd">        be walked in the recipe meta data. Numeric sections in the path</span>
<span class="sd">        access list elements. Using ``0`` in the path will get the first</span>
<span class="sd">        element in a list or the contents directly if there is no list.</span>
<span class="sd">        I.e., `source/0/url` will always get the first url, whether or</span>
<span class="sd">        not the source section is a list.</span>

<span class="sd">        Args:</span>
<span class="sd">          path: Path through YAML</span>
<span class="sd">          default: If not KeyError, this value will be returned</span>
<span class="sd">                   if the path does not exist in the recipe</span>
<span class="sd">        Raises:</span>
<span class="sd">          KeyError if no default given and the path does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nodes</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_walk</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; in Recipe </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="ne">KeyError</span> <span class="ow">and</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Recipe.set"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a value or section in the recipe</span>

<span class="sd">        See `get` for a description of how **path** works.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># walk path into nodes/keys</span>
        <span class="n">nodes</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_walk</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">noraise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># &quot;mkdir -p&quot;</span>
        <span class="n">found_path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">found_path</span> <span class="o">!=</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_raw_range</span><span class="p">(</span><span class="n">found_path</span><span class="p">)</span>
            <span class="n">backup</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">):]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">col</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">col</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">row</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; marker&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

        <span class="c1"># get old content</span>
        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">end_row</span><span class="p">,</span> <span class="n">end_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_raw_range</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">row</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">row</span><span class="p">][:</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">package_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of the packages built by this recipe (including outputs)&quot;&quot;&quot;</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;outputs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">:</span>
            <span class="n">packages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">output</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">packages</span>

<div class="viewcode-block" id="Recipe.replace"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">before</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">after</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">within</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;package&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">),</span>
                <span class="n">with_fuzz</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs string replace on parts of recipe text.</span>

<span class="sd">        - Lines considered are those containing Jinja set statements</span>
<span class="sd">          (``{% set var=&quot;val&quot; %}``) and those defining the top level</span>
<span class="sd">          Mapping entries given by **within** (default:``package`` and</span>
<span class="sd">          ``source``).</span>
<span class="sd">        - Cowardly refuses to modify lines with ``# [expression]``</span>
<span class="sd">          selectors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trying to replace </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span>

        <span class="c1"># get lines starting with &quot;{%&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;{%&quot;</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lineno</span><span class="p">)</span>

        <span class="c1"># get lines covered by keys listed in ``within``</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">key</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">within</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">lineno</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">lineno</span><span class="p">))</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">Pattern</span><span class="p">):</span>
            <span class="n">re_before</span> <span class="o">=</span> <span class="n">before</span>
            <span class="n">re_select</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">before</span><span class="o">.</span><span class="n">pattern</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;.*#.*\[&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">before_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">before</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">with_fuzz</span><span class="p">:</span>
                <span class="n">before_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(-|</span><span class="se">\\</span><span class="s2">\.|_)&quot;</span><span class="p">,</span> <span class="s2">&quot;[-_.]&quot;</span><span class="p">,</span> <span class="n">before_pattern</span><span class="p">)</span>
            <span class="n">re_before</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">before_pattern</span><span class="p">)</span>
            <span class="n">re_select</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">before_pattern</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;.*#.*\[&quot;</span><span class="p">)</span>

        <span class="c1"># replace within those lines, erroring on &quot;# [asd]&quot; selectors</span>
        <span class="n">replacements</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">lineno</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re_before</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">re_select</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">HasSelector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">lineno</span><span class="p">)</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">re_before</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">after</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">lineno</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> + </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
            <span class="n">replacements</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">replacements</span></div>

<div class="viewcode-block" id="Recipe.reset_buildnumber"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.reset_buildnumber">[docs]</a>    <span class="k">def</span> <span class="nf">reset_buildnumber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resets the build number</span>

<span class="sd">        If the build number is missing, it is added after build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;build&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>  <span class="c1"># no build number?</span>
            <span class="k">if</span> <span class="s2">&quot;build&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;build&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">build</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;build&quot;</span><span class="p">]</span>
                <span class="n">first_in_build</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">build</span><span class="p">))</span>
                <span class="n">lineno</span><span class="p">,</span> <span class="n">colno</span> <span class="o">=</span> <span class="n">build</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">first_in_build</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="n">colno</span> <span class="o">+</span> <span class="s2">&quot;number: 0&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingBuild</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;number: [0-9]+&quot;</span><span class="p">,</span> <span class="s2">&quot;number: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">get_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_deps_dict</span><span class="p">(</span><span class="n">sections</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_deps_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sections</span><span class="p">:</span>
            <span class="n">sections</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sections</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ensure_list</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
        <span class="n">check_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
            <span class="n">check_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;requirements/</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outputs&#39;</span><span class="p">,</span> <span class="p">[]))):</span>
                    <span class="n">check_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;outputs/</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">/requirements/</span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">check_paths</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="p">[])):</span>
                <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Fixme: lint this</span>
                    <span class="k">continue</span>
                <span class="n">dep</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\s&lt;=&gt;]&#39;</span><span class="p">,</span> <span class="n">spec</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">deps</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">deps</span>

<div class="viewcode-block" id="Recipe.conda_render"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.conda_render">[docs]</a>    <span class="k">def</span> <span class="nf">conda_render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">bypass_env_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">finalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">permit_unsatisfiable_variants</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">MetaData</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handles calling conda_build.api.render</span>

<span class="sd">        ``conda_build.api.render`` is fragile, loud and slow. Avoid using this</span>
<span class="sd">        whenever you can.</span>

<span class="sd">        This function will create a temporary directory, write out the</span>
<span class="sd">        current ``meta.yaml`` contents, redirect stdout and stderr to silence</span>
<span class="sd">        needless prints, ultimately call the `render` function, catching</span>
<span class="sd">        various exceptions and rewriting them into `CondaRenderFailure`, then</span>
<span class="sd">        cache the result.</span>

<span class="sd">        Since the ``MetaData`` objects returned expect the on-disk ``meta.yaml``</span>
<span class="sd">        to persist (it can get reloaded later on), clients of this function</span>
<span class="sd">        must **make sure to call `conda_release` once you are done** with those</span>
<span class="sd">        objects.</span>

<span class="sd">        Args:</span>
<span class="sd">          bypass_env_check:</span>
<span class="sd">             Avoids calling solver to fill in values for ``pin_compatible``</span>
<span class="sd">             and ``resolved_packages`` in Jinja2 expansion.</span>
<span class="sd">             **Changed default:** ``conda-build.api.render`` defaults to False,</span>
<span class="sd">             we set this to True as it is very slow.</span>
<span class="sd">          finalize:</span>
<span class="sd">             Has ``render()`` run ``finalize_metadata``, which fills in</span>
<span class="sd">             versions for host/run dependencies.</span>
<span class="sd">          permit_unsatisfiable_variants:</span>
<span class="sd">             Avoids raising ``UnsatisfiableError`` or</span>
<span class="sd">             ``DependencyNeedsBuildingError`` when determining package</span>
<span class="sd">             dependencies.</span>
<span class="sd">             **Changed default:** Set to True upstream, we set this to False</span>
<span class="sd">             to be informed about dependency problems.</span>
<span class="sd">          kwargs:</span>
<span class="sd">             passed on to ``conda_build.api.render``</span>

<span class="sd">        Raises:</span>
<span class="sd">          `CondaRenderfailure`: Some of the exceptions raised are rewritten</span>
<span class="sd">                                to simplify handling. The list will grow, but</span>
<span class="sd">                                is likely incomplete.</span>
<span class="sd">        Returns:</span>
<span class="sd">          List of 3-tuples each comprising the rendered MetaData and the flags</span>
<span class="sd">          ``needs_download`` and ``needs_render_in_env``.</span>

<span class="sd">        FIXME:</span>
<span class="sd">          Need to use **kwargs** to invalidate cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conda_meta</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conda_meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conda_release</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_conda_tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conda_tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;meta.yaml&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmpfile</span><span class="p">:</span>
                <span class="n">tmpfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conda_build_config</span><span class="p">:</span>
            <span class="n">cbc_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conda_tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;conda_build_config.yaml&quot;</span><span class="p">)</span>
            <span class="n">cbc_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conda_build_config</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">script</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_scripts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">script_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conda_tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">script</span><span class="p">)</span>
            <span class="n">script_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="n">old_exit</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">new_exit</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">new_exit</span>

        <span class="n">insert_mambabuild</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/dev/null&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">devnull</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">devnull</span><span class="p">),</span> <span class="n">redirect_stderr</span><span class="p">(</span><span class="n">devnull</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_conda_meta</span> <span class="o">=</span> <span class="n">conda_build</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_conda_tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">finalize</span><span class="o">=</span><span class="n">finalize</span><span class="p">,</span>
                        <span class="n">bypass_env_check</span><span class="o">=</span><span class="n">bypass_env_check</span><span class="p">,</span>
                        <span class="n">permit_unsatisfiable_variants</span><span class="o">=</span><span class="n">permit_unsatisfiable_variants</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t extract raw recipe text&quot;</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_yaml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;package&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;build&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">CondaRenderFailure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Must start with package or build section&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Error: Failed to render jinja&quot;</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="k">else</span> <span class="n">msg</span>
                <span class="k">raise</span> <span class="n">CondaRenderFailure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Jinja2 Template Error: &#39;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CondaRenderFailure</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown SystemExit raised in Conda-Build Render API: &#39;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">old_exit</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conda_meta</span></div>

<div class="viewcode-block" id="Recipe.conda_release"><a class="viewcode-back" href="../../developer/_autosummary/bioconda_utils.recipe.html#bioconda_utils.recipe.Recipe.conda_release">[docs]</a>    <span class="k">def</span> <span class="nf">conda_release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Releases resources acquired in `conda_render`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conda_meta</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conda_meta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conda_tempdir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conda_tempdir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conda_tempdir</span> <span class="o">=</span> <span class="kc">None</span></div></div>


<span class="k">def</span> <span class="nf">load_parallel_iter</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">packages</span><span class="p">):</span>
    <span class="n">recipes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_recipes</span><span class="p">(</span><span class="n">recipe_folder</span><span class="p">,</span> <span class="n">packages</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">recipe</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">parallel_iter</span><span class="p">(</span><span class="n">Recipe</span><span class="o">.</span><span class="n">from_file</span><span class="p">,</span> <span class="n">recipes</span><span class="p">,</span> <span class="s2">&quot;Loading Recipes...&quot;</span><span class="p">,</span>
                                      <span class="n">recipe_folder</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="n">RecipeError</span><span class="p">):</span>
            <span class="n">recipe</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recipe</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not load recipe </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">recipe</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">recipe</span>

</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2016-2023, The Bioconda Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    <div class="git-ribbon">
      <a href="https://github.com/bioconda/bioconda-utils/edit/master/bioconda_utils/recipe.py" rel="me">Edit me on GitHub</a>
    </div>
  </body>
</html>