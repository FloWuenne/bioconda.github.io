
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>The bulk branch &#8212; Bioconda  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css" />
    <link rel="stylesheet" type="text/css" href="../_static/font-awesome-4.7.0/css/font-awesome.min.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/vega.min.js"></script>
    <script src="../_static/vega-lite.min.js"></script>
    <script src="../_static/vega-embed.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="bioconda_utils" href="_autosummary/bioconda_utils.html" />
    <link rel="prev" title="Developer Docs" href="index.html" />
    <link href="https://fonts.googleapis.com/css?family=Lato|Raleway" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">

    <link rel="apple-touch-icon" sizes="57x57" href="../_static/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../_static/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../_static/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../_static/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../_static/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../_static/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../_static/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../_static/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../_static/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="../_static/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../_static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../_static/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../_static/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="../_static/ms-icon-144x144.png">

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />


  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo/bioconda_monochrome_small.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../faqs.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributor/index.html">Contributing to Bioconda</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer Docs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#updating-bioconda-utils">Updating <code class="docutils literal notranslate"><span class="pre">bioconda-utils</span></code></a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#bulk-branch">Bulk branch</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">The <code class="xref any docutils literal notranslate"><span class="pre">bulk</span></code> branch</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#updating-pinnings">Updating pinnings</a></li>
<li class="toctree-l4"><a class="reference internal" href="#merging-back-to-master">Merging back to master</a></li>
<li class="toctree-l4"><a class="reference internal" href="#updating-bioconductor">Updating Bioconductor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#notes-on-working-with-bulk-branch">Notes on working with bulk branch</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#api-docs">API docs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
</ul>

<ul>
  
  <li class="toctree-l1"><a href="../conda-package_index.html">Browse packages</a></li>
  
  <li class="toctree-l1"><a href="https://github.com/bioconda/bioconda-recipes">Bioconda @ Github</a></li>
  
  <li class="toctree-l1"><a href="https://gitter.im/bioconda/Lobby"><img alt="Gitter" src="https://img.shields.io/gitter/room/bioconda/Lobby.svg"></a></li>
  
</ul>
<div id="searchbox" style="display: none" role="search">
    <h3 id="searchlabel">Search</h3>
    <p id="searchdesc">packages & docs</p>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="the-bulk-branch">
<h1>The <a class="reference internal" href="#"><span class="doc">The bulk branch</span></a> branch<a class="headerlink" href="#the-bulk-branch" title="Permalink to this heading">¶</a></h1>
<p>Sometimes we need to do maintenance or make changes to lots of recipes at once.
This happens most often when there is a new Bioconductor release: all
<code class="xref any docutils literal notranslate"><span class="pre">bioconductor-*</span></code> recipes need to be updated, and the corresponding packages
need to be built.</p>
<p>This ends up taking substantial compute time on CI infrastructure. If this were
run on the same CI infrastructure that processes pull requests, this might
consume CI time needed for the typical functioning of the daily activity in the
bioconda repository. The <a class="reference internal" href="#"><span class="doc">The bulk branch</span></a> branch is a mechanism for the Bioconda core
team to perform large-scale changes on a different CI system, without tying up
the CI infrastructure used by contributors on individual pull requests.</p>
<p>The bulk branch reads from the <a class="reference internal" href="#"><span class="doc">The bulk branch</span></a> branch of <code class="xref any docutils literal notranslate"><span class="pre">bioconda-common</span></code>.</p>
<p><strong>The bulk branch immediately uploads successfully built packages to
Anaconda.</strong> As such, only the bioconda core team has the ability to push to
this branch.</p>
<section id="updating-pinnings">
<h2>Updating pinnings<a class="headerlink" href="#updating-pinnings" title="Permalink to this heading">¶</a></h2>
<p>Pinnings are updated for example when we are supporting a new version of
Python. These are versions of base packages that are supported, and form the
basis of the build string hashes at the end of conda package names. A recent
example is updating pinnings to support Python 3.10.</p>
<ol class="arabic">
<li><p>Update <a class="reference external" href="https://github.com/bioconda/bioconda-utils/blob/master/bioconda_utils/bioconda_utils-conda_build_config.yaml">bioconda pinnings</a>.
This may take a few tries; you may need to make changes to match
conda-forge’s pinnings. Merge these changes into the master branch (which
will create or update a Release Please PR) and merge in the Release Please
PR to create a new version of bioconda-utils.</p></li>
<li><p>Allow autobump to pick up the new version. This usually takes an hour. Then
merge the corresponding PR in bioconda-recipes. You now have a new
bioconda-utils package to use which contains those pinnings.</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">common.sh</span></code> (see <a class="reference external" href="https://github.com/bioconda/bioconda-common/blob/master/common.sh">here</a>) to
use the new version. <strong>In general, this should be done only on the bulk
branch to start</strong>, since changing the pinnings will likely trigger many
recipes to require rebuilding. Since the bioconda-recipes/bulk branch reads
from the bioconda-common/bulk branch, this allows bulk to run a different
version of bioconda-utils. Once a bulk migration is complete,</p></li>
<li><p>In bioconda-recipes, merge master into bulk to start with a clean slate.
Since bulk is infrequently updated, there may be substantial conflicts
caused by running the default <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">bulk</span> <span class="pre">&amp;&amp;</span> <span class="pre">git</span> <span class="pre">merge</span> <span class="pre">master</span></code>.
This tends to happen most with build numbers. But since we want to prefer
using whatever is in the master branch, we can merge master into bulk, while
preferring master version in any conflicts, with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>checkout<span class="w"> </span>bulk
git<span class="w"> </span>merge<span class="w"> </span>master<span class="w"> </span>-s<span class="w"> </span>recursive<span class="w"> </span>-X<span class="w"> </span>theirs
</pre></div>
</div>
<p>There may be a few remaining conflicts to fix; in all cases you should
prefer what’s on the master branch.</p>
</li>
<li><p>Start a preliminary bulk run to build the cache. In <code class="file docutils literal notranslate"><span class="pre">.github/workflows/Bulk.yml</span></code>, set
the number of workers to 1 (so,
<code class="docutils literal notranslate"><span class="pre">jobs:build-linux:strategy:matrix:runner:[0]</span></code>) and also set
<code class="docutils literal notranslate"><span class="pre">--n-workers=1</span></code> in the <code class="docutils literal notranslate"><span class="pre">bioconda-utils</span></code> call. This will allow building
the cache which will be used in subsequent (parallel) runs. Make sure you do
this for both the Linux and MacOS sections.</p></li>
<li><p>Let the initial run finish. Fix anything obvious, and now that the cache is
built you can incrementally increase the workers and the <code class="docutils literal notranslate"><span class="pre">--n-workers</span></code>
argument to allow parallel jobs.</p></li>
<li><p>Once things largely settle down, run <code class="docutils literal notranslate"><span class="pre">bioconda-utils</span> <span class="pre">update-pinnings</span></code> in
the bulk branch. This will go through all the pinnings, figure out what
recipes they’re used with, and bump the recipes’ build numbers
appropriately. Then push to bulk to rebuild all of those.</p></li>
</ol>
<p>See <a class="reference internal" href="#merge-bulk"><span class="std std-ref">Merging back to master</span></a> for next steps.</p>
</section>
<section id="merging-back-to-master">
<span id="merge-bulk"></span><h2>Merging back to master<a class="headerlink" href="#merging-back-to-master" title="Permalink to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>The goal on the bulk branch is to get all workers successfully passing, such
that there is nothing to do in the PR where bulk is merged into master. This
may require adding recipes to the <code class="docutils literal notranslate"><span class="pre">build-fail-blacklist</span></code> to skip building
them.</p></li>
<li><p>Merge the master branch into the bulk branch, dealing with any conflicts as
needed.</p></li>
<li><p>Merge the bulk branch into the master branch.</p></li>
<li><p>Ensure that <code class="docutils literal notranslate"><span class="pre">bioconda-common/common.sh</span></code> points to the same version of
bioconda-utils that the <code class="docutils literal notranslate"><span class="pre">bulk</span></code> branch has been using.</p></li>
<li><p>Compile a list of packages that have been skipped or blacklisted during the
bulk migration, and open a new issue to ask for help from the community.</p></li>
</ol>
</section>
<section id="updating-bioconductor">
<h2>Updating Bioconductor<a class="headerlink" href="#updating-bioconductor" title="Permalink to this heading">¶</a></h2>
<p>Bioconductor gets updated twice a year (spring and fall), where all BioC
packages get released with updated versions at the same time. This in turn
requires updating the packages on Bioconda. This is a perfect use-case for the
bulk branch. The process is generally the same as above but without the
pinnings updates and with some Bioconductor-specific helper scripts.</p>
<ol class="arabic">
<li><p><em>(this is step 4 from the above section on updating pinnings)</em> In
bioconda-recipes, merge master into bulk to start with a clean slate. Since
bulk is infrequently updated, there may be substantial conflicts caused by
running the default <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">bulk</span> <span class="pre">&amp;&amp;</span> <span class="pre">git</span> <span class="pre">merge</span> <span class="pre">master</span></code>. This tends to
happen most with build numbers. But since we want to prefer using whatever
is in the master branch, we can merge master into bulk, while preferring
master version in any conflicts, with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>checkout<span class="w"> </span>bulk
git<span class="w"> </span>merge<span class="w"> </span>master<span class="w"> </span>-s<span class="w"> </span>recursive<span class="w"> </span>-X<span class="w"> </span>theirs
</pre></div>
</div>
<p>There may be a few remaining conflicts to fix; in all cases you should
prefer what’s on the master branch.</p>
</li>
<li><p>Identify the latest BioConductor version, and update all BioConductor
recipes with:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bioconda-utils<span class="w"> </span>bioconductor-skeleton<span class="w"> </span>update-all-packages<span class="w"> </span>--bioc-version<span class="w"> </span><span class="nv">$BIOC_VERSION</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p><em>(this is step 5 from the above section on updating pinnings)</em> Start
a preliminary bulk run to build the cache. In
<code class="file docutils literal notranslate"><span class="pre">.github/workflows/Bulk.yml</span></code>, set the number of workers to 1 (so,
<code class="docutils literal notranslate"><span class="pre">jobs:build-linux:strategy:matrix:runner:[0]</span></code>) and also set
<code class="docutils literal notranslate"><span class="pre">--n-workers=1</span></code> in the <code class="docutils literal notranslate"><span class="pre">bioconda-utils</span></code> call. This will allow building
the cache which will be used in subsequent (parallel) runs. Make sure you do
this for both the Linux and MacOS sections.</p></li>
<li><p>Use the
[rootNodes.py](<a class="reference external" href="https://github.com/bioconda/bioconda-recipes/blob/master/scripts/bioconductor/rootNodes.py">https://github.com/bioconda/bioconda-recipes/blob/master/scripts/bioconductor/rootNodes.py</a>)
from the bioconda-recipes repo to help figure out what the primary root
nodes are for the currently-remaining packages to be built. This looks at
recently-built packages, removes them from the DAG of recipes to be built,
and then reports to stdout the remaining root nodes. This information can be
used to strategically edit the <code class="docutils literal notranslate"><span class="pre">build-fail-blacklist</span></code> file to prioritize
the building of those root nodes.</p></li>
<li><p>Once builds seem to be stabilizing, remove the temporary edits to the
<code class="docutils literal notranslate"><span class="pre">build-fail-blacklist</span></code>.</p></li>
<li><p>Follow the <a class="reference internal" href="#merge-bulk"><span class="std std-ref">Merging back to master</span></a> instructions for merging bulk back into the
master branch.</p></li>
</ol>
</section>
<section id="notes-on-working-with-bulk-branch">
<h2>Notes on working with bulk branch<a class="headerlink" href="#notes-on-working-with-bulk-branch" title="Permalink to this heading">¶</a></h2>
<p>Some unordered notes on working with the bulk branch:</p>
<ul class="simple">
<li><p>Remember that successfully-built packages are immediately pushed to Anaconda.</p></li>
<li><p>You may want to coordinate the timing of fixes and pushes (say, via gitter).
This is because the bulk branch has <code class="docutils literal notranslate"><span class="pre">fail-fast:</span> <span class="pre">false</span></code> set to allow
parallel jobs to progress as much as possible. Multiple people pushing to
bulk means that there is a risk of trying to build the same recipes multiple
times. In such a case, only the first package will be actually uploaded and
subsequent packages will a failure on the upload step. So there is no danger
to the channel, it’s just poor use of CI resources.</p></li>
<li><p>The logs are awkward to read and hard to find exactly where failures occur.
One way to do this is to go to the bottom where there is a report of which
packages failed. This report is shown when a bulk job goes to completion
(rather than timing out). Then search for that package backwards through the
log. You can also look for the broad structure of the log: recipes with
nothing to do will be reported in a short stanza, so you can use those as
structural markers to indicate where there’s no useful log info.</p></li>
<li><p>Instead of using the search functionality in the CI logs, download the raw
log (from gear menu at top right) to use your browser search functionality,
which is often much easier to use (for example, Chrome shows occurrences of
search term throughout the document in the scrollbar, which makes digging for
the actual error a lot easier).</p></li>
<li><p>You may see a lot of output for Python packages in particular. This is because for
bioconda-utils to figure out whether it needs to build the package, it needs
to know what the hash is for the package. This in turn requires figuring out
all the dependencies to see which of them are pinned and then using those to
calculate a hash. So it may appear that it’s doing a lot of work for packages
that don’t need to be rebuilt, but that work needs to be done simply to
figure out if a rebuild is needed, and so this is expected.</p></li>
<li><p>The bulk runs take place on GitHub Actions, and the configuration is in
<code class="file docutils literal notranslate"><span class="pre">.github/workflows/Bulk.yml</span></code>.</p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2016-2023, The Bioconda Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/developer/bulk.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    <div class="git-ribbon">
      <a href="https://github.com/bioconda/bioconda-utils/edit/master/docs/source/developer/bulk.rst" rel="me">Edit me on GitHub</a>
    </div>
  </body>
</html>